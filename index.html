<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="The Pathway">
    
    <title>The Pathway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 900: '#0f172a', 950: '#020617' },
                        gold: { 500: '#d4af37', 600: '#b5922f', 900: '#423206' },
                        medical: { 500: '#06b6d4', glow: 'rgba(6, 182, 212, 0.6)' }
                    },
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                        serif: ['Merriweather', 'Georgia', 'serif'],
                    },
                    animation: {
                        'breathe': 'breathe 8s infinite ease-in-out',
                        'fade-in': 'fadeIn 0.3s ease-out forwards', 
                        'fade-out': 'fadeOut 0.3s ease-in forwards', 
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'slide-down': 'slideDown 0.25s ease-in forwards',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                    },
                    keyframes: {
                        breathe: {
                            '0%, 100%': { transform: 'scale(1)', opacity: '0.5' },
                            '50%': { transform: 'scale(1.3)', opacity: '0.8' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        fadeOut: {
                            '0%': { opacity: '1', visibility: 'visible' },
                            '100%': { opacity: '0', visibility: 'hidden' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(100%)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideDown: {
                            '0%': { opacity: '1', transform: 'translateY(0)' },
                            '100%': { opacity: '0', transform: 'translateY(100%)' },
                        },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        }
                    },
                    padding: { 'safe': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:ital,wght@0,300;0,400;1,300&display=swap');
        
        html, body { height: 100%; min-height: 100vh; width: 100%; margin: 0; background-color: #020617; color: #e2e8f0; -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; overflow: hidden; overscroll-behavior: none; overscroll-behavior-y: none; }
        @supports (height: 100dvh) { body { min-height: 100dvh; } }
        body { display: flex; flex-direction: column; }
        
        /* Gold Selection Theme */
        ::selection { background-color: #d4af37; color: white; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        
        .glass-panel { background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .btn-primary { transition: all 0.2s ease; }
        .btn-primary:active { transform: scale(0.96); }
        .pb-safe { padding-bottom: 0; }
        .pt-safe { padding-top: env(safe-area-inset-top, 20px); }
        .mb-safe { margin-bottom: 0; }
        
        .view-section { opacity: 0; transition: opacity 0.25s ease-in-out; padding-bottom: calc(env(safe-area-inset-bottom) + 2rem); overscroll-behavior-y: contain; }
        .view-section.active-view { opacity: 1; }
        .faq-answer { display: none; }
        .faq-answer.active { display: block; animation: slideUp 0.3s ease-out forwards; }
        .faq-icon { transition: transform 0.3s ease; }
        .faq-icon.active { transform: rotate(180deg); }
        
        .quote-wrapper { position: relative; display: inline-block; padding: 2rem 3rem; max-width: 100%; }
        .quote-mark { position: absolute; width: 2.5rem; height: 2.5rem; color: rgba(212, 175, 55, 0.4); }
        .quote-mark.start { top: 0; left: 0; }
        .quote-mark.end { bottom: 0; right: 0; transform: rotate(180deg); }
        
        .side-menu-open #side-menu-backdrop { display: block; opacity: 1; }
        .side-menu-open #side-menu { transform: translateX(0); }
        .menu-link { transition: color 0.3s ease; }
        .menu-link.active { color: #d4af37; } 

        .swipe-container { position: relative; overflow: hidden; border-radius: 0.75rem; margin-bottom: 0.75rem; }
        .swipe-item { transition: transform 0.2s ease-out; position: relative; z-index: 10; background: rgba(15, 23, 42, 0.9); touch-action: pan-y; }
        .delete-action { position: absolute; right: 0; top: 0; bottom: 0; width: 80px; display: flex; align-items: center; justify-content: center; z-index: 0; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #d4af37; cursor: pointer; margin-top: -8px; box-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }
        .shake-error { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; border-color: #ef4444 !important; color: #ef4444 !important; }

        /* --- BODY MAP STYLES --- */
        .neuro-body-container {
            position: relative;
            width: 100%;
            /* Subtracting trackpad height to prevent overlap */
            height: calc(100% - 220px); 
            display: flex;
            justify-content: center;
            align-items: center; /* Centered vertically */
            /* Subtle grid */
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 30px 30px;
            background-position: center;
            overflow: hidden; 
            padding-bottom: 2rem;
        }

        /* The SVG layer - Updated Anatomy */
        .anatomy-svg {
            height: 80%; /* Shrunk from 95% */
            width: auto;
            max-width: 100%;
            filter: drop-shadow(0 0 10px rgba(6, 182, 212, 0.1));
            position: relative;
            z-index: 10;
            pointer-events: none; 
            opacity: 0.8;
        }

        /* The Interactive Layer - Must match SVG aspect ratio perfectly */
        .interactive-layer {
            position: absolute;
            height: 80%; /* Match SVG height */
            aspect-ratio: 300 / 700; /* Match SVG ViewBox */
            z-index: 50;
            pointer-events: none; 
        }

        /* Gold Cursor (Updated from Blue) */
        .neuro-cursor {
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 0;
            pointer-events: none;
            z-index: 60;
            will-change: transform; 
            transition: transform 0.06s linear;
            display: none;
        }

        .neuro-cursor-inner {
            position: absolute;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            border: 1px solid #d4af37; /* Gold */
            background-color: rgba(212, 175, 55, 0.15);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
        }
        
        /* Crosshairs */
        .neuro-cursor-inner::before { content: ''; position: absolute; top: -6px; bottom: -6px; left: 50%; width: 1px; background: #d4af37; transform: translateX(-50%); opacity: 0.7; }
        .neuro-cursor-inner::after { content: ''; position: absolute; left: -6px; right: -6px; top: 50%; height: 1px; background: #d4af37; transform: translateY(-50%); opacity: 0.7; }

        /* GOLD MARKERS */
        .body-marker {
            position: absolute;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(212, 175, 55, 0.9);
            border: 1px solid #fff;
            z-index: 40;
            pointer-events: auto; 
            background-color: rgba(212, 175, 55, 0.8); /* Gold */
        }
        
        select { appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }
    </style>
</head>
<body class="selection:bg-gold-500 selection:text-white" ontouchstart="handleGlobalTouchStart(event)" ontouchmove="handleGlobalTouchMove(event)" ontouchend="handleGlobalTouchEnd(event)">

    <div id="side-menu-backdrop" onclick="toggleMenu()" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[90] hidden opacity-0 transition-opacity duration-[1000ms]"></div>

    <aside id="side-menu" class="fixed top-0 bottom-0 right-0 w-3/4 max-w-xs bg-slate-900/95 backdrop-blur-xl border-l border-slate-800 z-[100] transform translate-x-full transition-transform duration-[1000ms] ease-out flex flex-col shadow-2xl pt-safe pb-safe">
        <div class="px-6 pb-6 border-b border-slate-800 flex flex-col relative" style="padding-top: env(safe-area-inset-top);">
            <button onclick="toggleMenu()" class="absolute top-0 right-6 text-slate-400 hover:text-white transition" style="margin-top: env(safe-area-inset-top);"><i data-lucide="x" class="w-6 h-6"></i></button>
            <div class="mt-4 mb-2">
                <h2 class="text-xl font-serif italic text-gold-500 tracking-wide">The Pathway</h2>
                <p class="text-[10px] text-slate-500 uppercase tracking-[0.2em] mt-1">Mechanism of Surrender</p>
            </div>
            <div class="mt-6 pt-6 border-t border-slate-800/50" id="auth-container">
                <div id="logged-out-view">
                    <button onclick="login()" class="w-full py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl transition font-medium flex items-center justify-center gap-3 shadow-lg border border-slate-700">
                        Sign In
                    </button>
                </div>
                <div id="logged-in-view" class="hidden">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="bg-gold-500/20 p-2 rounded-full text-gold-500"><i data-lucide="user" class="w-5 h-5"></i></div>
                        <div>
                            <p class="text-sm text-white font-medium leading-none" id="user-name">User</p>
                            <p class="text-xs text-slate-500 mt-1 leading-none" id="user-email">email@example.com</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="w-full py-2 border border-slate-700 text-slate-400 hover:text-white rounded-xl transition text-xs uppercase tracking-wider">Sign Out</button>
                </div>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto p-6 space-y-2">
            <button onclick="switchTab('guide')" id="menu-guide" class="menu-link w-full text-left py-3 px-2 text-lg font-light text-slate-300 hover:text-white transition flex items-center gap-4 active"><i data-lucide="book" class="w-5 h-5 opacity-70"></i> Guide</button>
            <button onclick="switchTab('process')" id="menu-process" class="menu-link w-full text-left py-3 px-2 text-lg font-light text-slate-300 hover:text-white transition flex items-center gap-4"><i data-lucide="layers" class="w-5 h-5 opacity-70"></i> Work</button>
            <button onclick="switchTab('timer')" id="menu-timer" class="menu-link w-full text-left py-3 px-2 text-lg font-light text-slate-300 hover:text-white transition flex items-center gap-4"><i data-lucide="clock" class="w-5 h-5 opacity-70"></i> Timer</button>
            <button onclick="switchTab('journal')" id="menu-journal" class="menu-link w-full text-left py-3 px-2 text-lg font-light text-slate-300 hover:text-white transition flex items-center gap-4"><i data-lucide="archive" class="w-5 h-5 opacity-70"></i> Log</button>
            <button onclick="switchTab('insights')" id="menu-insights" class="menu-link w-full text-left py-3 px-2 text-lg font-light text-slate-300 hover:text-white transition flex items-center gap-4"><i data-lucide="eye" class="w-5 h-5 opacity-70"></i> Insights</button>
            <button onclick="switchTab('qa')" id="menu-qa" class="menu-link w-full text-left py-3 px-2 text-lg font-light text-slate-300 hover:text-white transition flex items-center gap-4"><i data-lucide="help-circle" class="w-5 h-5 opacity-70"></i> Q&A</button>
        </nav>

        <div class="px-6 pt-6 pb-4 text-center border-t border-slate-800/50 mt-auto">
            <p class="text-[10px] text-slate-600 uppercase tracking-widest">Version 9.9.4</p>
        </div>
    </aside>

    <div id="intro-screen" onclick="dismissIntro()" class="fixed inset-0 z-[80] bg-slate-950 flex flex-col items-center justify-center p-8 text-center cursor-pointer transition-opacity duration-1000">
        <div class="animate-fade-in max-w-lg mx-auto flex flex-col h-full justify-center relative w-full">
            <div class="mb-8 text-gold-500/30 mx-auto"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg></div>
            <h1 class="text-5xl md:text-6xl font-serif italic text-gold-500 mb-16 tracking-wider drop-shadow-[0_0_25px_rgba(212,175,55,0.2)]">The Pathway</h1>
            <div class="flex justify-center">
                <div class="quote-wrapper max-w-md relative">
                    <svg class="quote-mark start" viewBox="0 0 24 24" fill="currentColor"><path d="M14.017 21L14.017 18C14.017 16.896 14.321 15.923 14.929 15.081C15.537 14.239 16.357 13.459 17.389 12.741L16.731 10.561C15.039 11.623 14.069 12.878 13.821 14.326C13.821 14.326 13.821 14.326 13.821 14.326C13.545 13.714 13.407 13.052 13.407 12.34C13.407 10.284 14.147 8.528 15.627 7.072C17.107 5.616 18.867 4.888 20.907 4.888C21.787 4.888 22.467 5.568 22.947 6.928C23.427 8.288 23.667 9.528 23.667 10.648C23.667 14.304 22.397 17.754 19.857 21L14.017 21ZM6.007 21L6.007 18C6.007 16.896 6.311 15.923 6.919 15.081C7.527 14.239 8.347 13.459 9.379 12.741L8.721 10.561C7.029 11.623 6.059 12.878 5.811 14.326C5.811 14.326 5.811 14.326 5.811 14.326C5.535 13.714 5.397 13.052 5.397 12.34C5.397 10.284 6.137 8.528 7.617 7.072C9.097 5.616 10.857 4.888 12.897 4.888C13.777 4.888 14.457 5.568 14.937 6.928C15.417 8.288 15.657 9.528 15.657 10.648C15.657 14.304 14.387 17.754 11.847 21L6.007 21Z" /></svg>
                    <p id="intro-quote-text" class="text-lg text-white font-light leading-relaxed font-serif italic opacity-0 transition-opacity duration-500">Loading...</p>
                    <svg class="quote-mark end" viewBox="0 0 24 24" fill="currentColor"><path d="M14.017 21L14.017 18C14.017 16.896 14.321 15.923 14.929 15.081C15.537 14.239 16.357 13.459 17.389 12.741L16.731 10.561C15.039 11.623 14.069 12.878 13.821 14.326C13.821 14.326 13.821 14.326 13.821 14.326C13.545 13.714 13.407 13.052 13.407 12.34C13.407 10.284 14.147 8.528 15.627 7.072C17.107 5.616 18.867 4.888 20.907 4.888C21.787 4.888 22.467 5.568 22.947 6.928C23.427 8.288 23.667 9.528 23.667 10.648C23.667 14.304 22.397 17.754 19.857 21L14.017 21ZM6.007 21L6.007 18C6.007 16.896 6.311 15.923 6.919 15.081C7.527 14.239 8.347 13.459 9.379 12.741L8.721 10.561C7.029 11.623 6.059 12.878 5.811 14.326C5.811 14.326 5.811 14.326 5.811 14.326C5.535 13.714 5.397 13.052 5.397 12.34C5.397 10.284 6.137 8.528 7.617 7.072C9.097 5.616 10.857 4.888 12.897 4.888C13.777 4.888 14.457 5.568 14.937 6.928C15.417 8.288 15.657 9.528 15.657 10.648C15.657 14.304 14.387 17.754 11.847 21L6.007 21Z" /></svg>
                </div>
            </div>
            <p id="intro-quote-author" class="text-xs text-gold-500 uppercase tracking-[0.25em] font-sans text-center opacity-0 transition-opacity duration-500 delay-100 mt-8"></p>
            <div class="mt-16 animate-pulse opacity-50"><span class="text-[10px] text-slate-400 uppercase tracking-[0.4em]">Tap to Begin</span></div>
        </div>
    </div>

    <header class="flex-none w-full px-6 pb-4 border-b border-slate-800/50 bg-slate-950/90 backdrop-blur z-50 flex justify-between items-center relative" style="padding-top: max(2.5rem, calc(env(safe-area-inset-top) + 1rem));">
        <div><h1 class="text-2xl md:text-3xl font-serif italic text-gold-500 tracking-wide">The Pathway</h1><p class="text-[10px] text-slate-500 uppercase tracking-[0.2em] mt-0.5">Mechanism of Surrender</p></div>
        <button onclick="toggleMenu()" class="text-slate-400 hover:text-white transition p-2"><i data-lucide="menu" class="w-6 h-6"></i></button>
    </header>

    <main id="app-content" class="flex-1 relative w-full overflow-hidden">
        
        <section id="view-guide" class="view-section active-view h-full overflow-y-auto p-4">
            <div class="glass-panel p-6 rounded-2xl shadow-lg mb-8">
                <h2 class="text-2xl font-light mb-4 text-white">The Mechanism</h2>
                <p class="text-slate-300 leading-relaxed mb-4">Letting go involves being aware of a feeling, letting it come up, staying with it, and letting it run its course without wanting to make it different or do anything about it.</p>
                <div class="bg-slate-800/50 p-4 rounded-lg border-l-2 border-gold-500 my-6"><p class="italic text-slate-400 text-sm">"It means to simply let the feeling be there and to focus on letting out the energy behind it."</p><p class="text-right text-xs text-slate-500 mt-2">â€” David R. Hawkins</p></div>
                <div class="space-y-4">
                    <div class="flex gap-4 items-start"><div class="bg-slate-800 p-2 rounded-full text-gold-500 shrink-0"><i data-lucide="eye" class="w-5 h-5"></i></div><div><h3 class="font-medium text-white">1. Acknowledge</h3><p class="text-sm text-slate-400 mt-1">Notice the feeling. Allow it to surface. Do not push it down.</p></div></div>
                    <div class="flex gap-4 items-start"><div class="bg-slate-800 p-2 rounded-full text-gold-500 shrink-0"><i data-lucide="brain-circuit" class="w-5 h-5"></i></div><div><h3 class="font-medium text-white">2. Ignore Thoughts</h3><p class="text-sm text-slate-400 mt-1">Thoughts are rationalizations created by the mind. Ignore the "why." Focus only on the "what" (the sensation).</p></div></div>
                    <div class="flex gap-4 items-start"><div class="bg-slate-800 p-2 rounded-full text-gold-500 shrink-0"><i data-lucide="waves" class="w-5 h-5"></i></div><div><h3 class="font-medium text-white">3. No Resistance</h3><p class="text-sm text-slate-400 mt-1">Drop the resistance to the feeling. It is the resistance that keeps it going. Ask: "Can I welcome this feeling?"</p></div></div>
                </div>
                <button onclick="switchTab('process')" class="w-full mt-8 py-4 bg-gradient-to-r from-slate-800 to-slate-700 hover:from-slate-700 hover:to-slate-600 text-white rounded-xl transition shadow-lg flex items-center justify-center gap-2 font-medium">Start Practice <i data-lucide="arrow-right" class="w-4 h-4"></i></button>
            </div>
        </section>

        <section id="view-process" class="view-section hidden h-full overflow-hidden flex flex-col justify-center p-4">
            <div class="glass-panel p-8 sm:p-10 rounded-2xl sm:rounded-3xl shadow-lg w-full max-w-lg mx-auto flex flex-col justify-center items-center text-center relative overflow-hidden">
                <div id="process-step-0" class="process-step w-full">
                    <h2 class="text-2xl sm:text-3xl font-light mb-2 text-white">Identify Emotion</h2>
                    <p class="text-slate-400 mb-8 text-sm">Select the emotion on the scale.</p>
                    <button onclick="toggleModal('emotion-picker')" id="process-emotion-btn" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-6 py-4 text-lg text-white flex justify-between items-center hover:border-gold-500 transition mb-6">
                        <span id="process-emotion-display" class="text-slate-400">Select Emotion...</span><i data-lucide="chevron-down" class="w-5 h-5 text-slate-500"></i>
                    </button>
                    <button onclick="startProcess()" class="w-full py-4 bg-gold-600 hover:bg-gold-500 text-white font-medium rounded-xl transition shadow-lg shadow-gold-900/20 btn-primary text-lg">Begin Surrender</button>
                </div>
                <div id="process-step-1" class="process-step hidden w-full">
                    <div class="mb-8 text-gold-500 bg-gold-500/10 p-4 rounded-full inline-block"><i data-lucide="map-pin" class="w-10 h-10"></i></div>
                    <h2 class="text-2xl font-light mb-4 text-white">Locate it</h2>
                    <p class="text-slate-300 leading-relaxed mb-8 font-light">Close your eyes. Where do you feel "<span class="current-emotion font-semibold text-white"></span>"?<br><br>Chest? Solar plexus? Throat?<br><span class="text-slate-400 text-sm block mt-4">Stop naming it. Just feel the raw energy.</span></p>
                    <button onclick="nextStep(2)" class="w-full py-4 border border-slate-600 hover:bg-slate-800 rounded-xl text-white transition btn-primary">I have located it</button>
                </div>
                <div id="process-step-2" class="process-step hidden w-full">
                    <div class="mb-8 text-slate-400 bg-slate-800 p-4 rounded-full inline-block"><i data-lucide="x-circle" class="w-10 h-10"></i></div>
                    <h2 class="text-2xl font-light mb-4 text-white">Drop the Story</h2>
                    <p class="text-slate-300 leading-relaxed mb-8 font-light">Your mind is creating a narrative.<br><strong>Ignore the thoughts.</strong><br><br><span class="text-slate-400 text-sm">Return 100% focus to the physical sensation.</span></p>
                    <button onclick="nextStep(3)" class="w-full py-4 border border-slate-600 hover:bg-slate-800 rounded-xl text-white transition btn-primary">Thoughts ignored</button>
                </div>
                <div id="process-step-3" class="process-step hidden w-full">
                    <div class="mb-8 text-emerald-500 bg-emerald-500/10 p-4 rounded-full inline-block"><i data-lucide="unlock" class="w-10 h-10"></i></div>
                    <h2 class="text-2xl font-light mb-4 text-white">Drop Resistance</h2>
                    <p class="text-slate-300 leading-relaxed mb-8 font-light">Notice the resistance.<br><strong>Open the doors.</strong><br><br>Allow the feeling to be there. Don't push it away.</p>
                    <button onclick="nextStep(4)" class="w-full py-4 bg-slate-800 hover:bg-slate-700 rounded-xl text-white transition btn-primary">I am allowing it</button>
                </div>
                <div id="process-step-4" class="process-step hidden w-full">
                    <div class="absolute inset-0 flex items-center justify-center -z-10 opacity-20 pointer-events-none"><div class="w-64 h-64 bg-gold-500 rounded-full blur-3xl animate-breathe"></div></div>
                    <h2 class="text-xl font-light mb-2 text-white">Stay with it</h2>
                    <div class="text-6xl font-extralight text-white mb-8 font-serif tabular-nums tracking-tight" id="process-timer">00:00</div>
                    
                    <div class="flex justify-center gap-4 mb-8">
                        <button onclick="toggleModal('bell-modal')" class="flex items-center gap-2 px-3 py-2 bg-slate-900/80 border border-slate-800 rounded-full text-[10px] text-slate-400 hover:text-gold-500 transition"><i data-lucide="bell" class="w-3 h-3"></i> <span>Interval</span><div id="process-bell-status" class="w-1 h-1 bg-gold-500 rounded-full hidden ml-1"></div></button>
                        <button onclick="toggleModal('ambience-modal')" class="flex items-center gap-2 px-3 py-2 bg-slate-900/80 border border-slate-800 rounded-full text-[10px] text-slate-400 hover:text-emerald-500 transition"><i data-lucide="waves" class="w-3 h-3"></i> <span>Sound</span><div id="process-ambience-status" class="w-1 h-1 bg-emerald-500 rounded-full hidden ml-1"></div></button>
                    </div>

                    <button onclick="finishProcess()" class="w-full py-4 bg-emerald-900/40 hover:bg-emerald-900/60 text-emerald-100 border border-emerald-800/50 rounded-xl transition backdrop-blur-sm btn-primary">Feeling has Shifted</button>
                </div>
                <div id="process-step-5" class="process-step hidden w-full">
                    <div class="mb-6 text-gold-500 animate-fade-in"><i data-lucide="check-circle-2" class="w-20 h-20 mx-auto"></i></div>
                    <h2 class="text-3xl font-light mb-2 text-white">Released</h2>
                    <p class="text-slate-300 mb-8 font-light">You have surrendered a layer of "<span class="current-emotion font-normal text-white"></span>".</p>
                    <div class="mb-8"><p class="text-sm text-slate-400 mb-3">Peak Emotion Intensity</p><input type="range" min="1" max="10" value="5" class="w-full" id="process-intensity-slider" oninput="document.getElementById('process-intensity-val').textContent = this.value"><div class="text-center text-gold-500 font-mono mt-2 text-xl" id="process-intensity-val">5</div></div>
                    <button onclick="transitionToBodyMapFromProcess()" class="w-full py-4 bg-gold-600 hover:bg-gold-500 text-white font-medium rounded-xl transition btn-primary shadow-lg shadow-gold-900/20">Continue to BodyMap</button>
                </div>
                <button onclick="resetProcess()" class="absolute top-0 right-0 p-4 text-slate-600 hover:text-slate-400 hidden" id="process-reset-btn"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
        </section>

        <section id="view-timer" class="view-section hidden h-full overflow-hidden flex flex-col justify-center p-4">
            <div class="text-center w-full">
                <div class="mb-8 max-w-[240px] mx-auto mt-8 relative z-30">
                    <button onclick="toggleModal('emotion-picker')" id="timer-emotion-btn" class="w-full flex items-center justify-between bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-2 text-slate-300 text-sm hover:border-gold-500 transition">
                        <span id="timer-emotion-display">Select Emotion...</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-50"></i>
                    </button>
                </div>
                
                <div class="relative w-64 h-64 mx-auto mb-10 flex items-center justify-center z-10">
                    <div id="breath-circle" class="absolute inset-0 bg-slate-800 rounded-full opacity-50 scale-100 transition-transform duration-1000"></div>
                    <div id="breath-circle-inner" class="absolute w-40 h-40 bg-slate-700/50 rounded-full blur-2xl"></div>
                    <input type="text" inputmode="numeric" id="timer-display" class="relative z-10 text-6xl font-extralight text-white font-serif tabular-nums tracking-tight bg-transparent text-center w-full focus:outline-none border-none p-0 m-0" value="10:00" onclick="this.select()" oninput="handleTimerInput(this)">
                </div>

                <div class="flex justify-center gap-8 mb-8">
                    <button onclick="adjustTimer(-60)" class="text-slate-600 hover:text-slate-300 transition p-4 bg-slate-900 rounded-full"><i data-lucide="minus" class="w-6 h-6"></i></button>
                    <button onclick="adjustTimer(60)" class="text-slate-600 hover:text-slate-300 transition p-4 bg-slate-900 rounded-full"><i data-lucide="plus" class="w-6 h-6"></i></button>
                </div>

                <div class="flex justify-center gap-6 items-center mb-10">
                    <button onclick="resetTimer()" class="w-14 h-14 rounded-full bg-slate-900 border border-slate-800 text-slate-400 flex items-center justify-center transition hover:bg-slate-800"><i data-lucide="rotate-ccw" class="w-5 h-5"></i></button>
                    <button id="timer-toggle" onclick="toggleTimer()" class="w-20 h-20 rounded-full bg-gold-600 hover:bg-gold-500 text-white flex items-center justify-center shadow-xl shadow-gold-900/30 transition btn-primary"><i data-lucide="play" class="w-8 h-8 fill-current ml-1"></i></button>
                </div>

                <div class="flex justify-center gap-4">
                    <button onclick="toggleModal('bell-modal')" class="flex items-center gap-2 px-4 py-2 bg-slate-900/80 border border-slate-800 rounded-full text-xs text-slate-400 hover:text-gold-500 transition"><i data-lucide="bell" class="w-4 h-4"></i> <span>Interval</span><div id="bell-status" class="w-1.5 h-1.5 bg-gold-500 rounded-full hidden ml-1"></div></button>
                    <button onclick="toggleModal('ambience-modal')" class="flex items-center gap-2 px-4 py-2 bg-slate-900/80 border border-slate-800 rounded-full text-xs text-slate-400 hover:text-emerald-500 transition"><i data-lucide="waves" class="w-4 h-4"></i> <span>Sound</span><div id="ambience-status" class="w-1.5 h-1.5 bg-emerald-500 rounded-full hidden ml-1"></div></button>
                </div>
                <p class="mt-8 text-slate-600 text-xs max-w-[200px] mx-auto leading-relaxed">Let the energy behind the thoughts run out.</p>
            </div>
        </section>

        <section id="view-insights" class="view-section hidden h-full overflow-y-auto p-4">
            <h2 class="text-2xl font-light text-white mb-6">Insights</h2>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="openCharts('insights')" class="glass-panel rounded-2xl p-6 aspect-square flex flex-col items-center justify-center text-center gap-3 hover:bg-slate-800/80 transition group relative overflow-hidden">
                    <div class="absolute inset-0 bg-gold-500/5 opacity-0 group-hover:opacity-100 transition duration-500"></div>
                    <div class="w-12 h-12 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center text-gold-500 group-hover:scale-110 transition duration-300">
                        <i data-lucide="bar-chart-2" class="w-6 h-6"></i>
                    </div>
                    <span class="text-sm font-medium text-slate-200">Charts</span>
                </button>

                <button onclick="openBodyMap()" class="glass-panel rounded-2xl p-6 aspect-square flex flex-col items-center justify-center text-center gap-3 hover:bg-slate-800/80 transition group relative overflow-hidden">
                    <div class="absolute inset-0 bg-emerald-500/5 opacity-0 group-hover:opacity-100 transition duration-500"></div>
                    <div class="w-12 h-12 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center text-emerald-500 group-hover:scale-110 transition duration-300">
                        <i data-lucide="activity" class="w-6 h-6"></i>
                    </div>
                    <span class="text-sm font-medium text-slate-200">BodyMap</span>
                </button>

                <button class="glass-panel rounded-2xl p-6 aspect-square flex flex-col items-center justify-center text-center gap-3 opacity-60 cursor-not-allowed relative overflow-hidden">
                    <div class="w-12 h-12 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center text-slate-500">
                        <i data-lucide="bot" class="w-6 h-6"></i>
                    </div>
                    <span class="text-sm font-medium text-slate-500">Coach</span>
                    <span class="absolute top-3 right-3 text-[9px] uppercase tracking-wider text-slate-600 border border-slate-700 px-1 rounded">Soon</span>
                </button>

                <button class="glass-panel rounded-2xl p-6 aspect-square flex flex-col items-center justify-center text-center gap-3 opacity-60 cursor-not-allowed relative overflow-hidden">
                    <div class="w-12 h-12 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center text-slate-500">
                        <i data-lucide="flame" class="w-6 h-6"></i>
                    </div>
                    <span class="text-sm font-medium text-slate-500">Streaks</span>
                    <span class="absolute top-3 right-3 text-[9px] uppercase tracking-wider text-slate-600 border border-slate-700 px-1 rounded">Soon</span>
                </button>
            </div>
        </section>

        <section id="view-charts" class="view-section hidden h-full overflow-hidden flex flex-col p-4">
            <div class="mb-4 flex justify-between items-center">
                <button onclick="exitCharts()" class="p-2 text-slate-400 hover:text-white transition rounded-full bg-slate-800"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                <h2 class="text-xl font-light text-white">Progress Charts</h2>
                <div class="w-9"></div>
            </div>
            <div class="mb-6">
                <label class="text-xs text-slate-500 uppercase tracking-wider mb-2 block">Select Emotion</label>
                <button onclick="toggleModal('emotion-picker')" id="chart-emotion-btn" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-3 text-white flex justify-between items-center hover:border-gold-500 transition">
                    <span id="chart-emotion-display">Select to view...</span><i data-lucide="chevron-down" class="w-4 h-4 text-slate-500"></i>
                </button>
            </div>
            <div class="flex-1 min-h-[300px] relative">
                <canvas id="progressChart"></canvas>
                <div id="chart-placeholder" class="absolute inset-0 flex items-center justify-center text-slate-600 text-sm">Select an emotion to view progress</div>
            </div>
        </section>

        <section id="view-bodymap" class="view-section hidden h-full overflow-hidden flex flex-col relative bg-slate-950">
            <div class="absolute top-0 left-0 right-0 z-40 p-4 bg-gradient-to-b from-slate-950 via-slate-950/90 to-transparent pt-safe">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <button onclick="openBodyMapList()" id="bodymap-back-btn" class="p-2 text-slate-400 hover:text-white transition rounded-full bg-slate-900/50 backdrop-blur border border-slate-800 hidden"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                        <button onclick="switchTab('insights')" id="bodymap-exit-btn" class="p-2 text-slate-400 hover:text-white transition rounded-full bg-slate-900/50 backdrop-blur border border-slate-800"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                        <div>
                            <h2 class="text-lg font-light text-white tracking-wide">BodyScan</h2>
                            <div id="body-part-label" class="text-gold-500 font-mono text-[10px] uppercase tracking-[0.2em] h-3 opacity-0 transition-opacity duration-300">Scanning...</div>
                        </div>
                    </div>
                    <button id="bodymap-save-btn" onclick="finalizeSession()" class="hidden text-xs bg-gold-600 hover:bg-gold-500 text-white px-4 py-2 rounded-lg transition font-medium shadow-lg shadow-gold-900/30">Save</button>
                </div>
            </div>
        
            <div id="bodymap-list-view" class="flex-1 overflow-y-auto pt-24 px-4 pb-safe">
                <div id="bodymap-log-container" class="space-y-3 pb-8"></div>
            </div>
        
            <div id="bodymap-canvas-view" class="hidden flex-1 relative w-full h-full">
                
                <div class="neuro-body-container" id="neuro-container">
                    
                    <!-- NEW ANATOMICAL SVG (300x700) -->
                    <svg viewBox="0 0 300 700" class="anatomy-svg" id="body-silhouette">
                        <!-- Definitions for glow effect -->
                        <defs>
                            <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                                <feGaussianBlur stdDeviation="3" result="blur" />
                                <feComposite in="SourceGraphic" in2="blur" operator="over" />
                            </filter>
                        </defs>
                        
                        <!-- Main Body Outline -->
                        <path d="
                            M150,30 
                            C130,30 120,45 120,65  /* Head Left */
                            C120,80 130,95 135,100 /* Jaw Left */
                            L135,110               /* Neck Left */
                            Q110,120 90,135        /* Shoulder Left */
                            Q80,150 75,180         /* Arm Upper Left */
                            L65,240                /* Elbow Left */
                            L55,310                /* Forearm Left */
                            L40,350                /* Hand Left */
                            L60,350                /* Hand Inner Left */
                            L70,310                /* Forearm Inner Left */
                            L80,240                /* Elbow Inner Left */
                            Q85,200 100,160        /* Armpit Left */
                            L100,320               /* Torso Side Left */
                            Q95,350 90,380         /* Hip Left */
                            L90,520                /* Knee Left */
                            L85,650                /* Ankle Left */
                            L110,660               /* Foot Left */
                            L120,650               /* Ankle Inner Left */
                            L125,520               /* Knee Inner Left */
                            L135,390               /* Crotch Left */
                            
                            L165,390               /* Crotch Right */
                            L175,520               /* Knee Inner Right */
                            L180,650               /* Ankle Inner Right */
                            L190,660               /* Foot Right */
                            L215,650               /* Ankle Right */
                            L210,520               /* Knee Right */
                            L210,380               /* Hip Right */
                            Q205,350 200,320       /* Torso Side Right */
                            L200,160               /* Armpit Right */
                            Q215,200 220,240       /* Elbow Inner Right */
                            L230,310               /* Forearm Inner Right */
                            L240,350               /* Hand Inner Right */
                            L260,350               /* Hand Right */
                            L245,310               /* Forearm Right */
                            L235,240               /* Elbow Right */
                            Q230,150 210,135       /* Arm Upper Right */
                            Q190,120 165,110       /* Shoulder Right */
                            L165,100               /* Neck Right */
                            C170,95 180,80 180,65  /* Jaw Right */
                            C180,45 170,30 150,30  /* Head Right */
                            Z" 
                            stroke="#06b6d4" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round" opacity="0.8" />
                            
                        <!-- Internal Details (Subtle) -->
                        <path d="M135,100 Q150,110 165,100" stroke="#06b6d4" stroke-width="0.5" fill="none" opacity="0.4" /> <!-- Collarbone -->
                        <path d="M150,110 L150,390" stroke="#06b6d4" stroke-width="0.5" fill="none" stroke-dasharray="2,4" opacity="0.2" /> <!-- Center Line -->
                        <path d="M120,320 Q150,330 180,320" stroke="#06b6d4" stroke-width="0.5" fill="none" opacity="0.2" /> <!-- Waist -->
                        
                        <!-- Chakras/Centers (Subtle) -->
                        <circle cx="150" cy="60" r="2" fill="#06b6d4" opacity="0.3" /> <!-- Third Eye -->
                        <circle cx="150" cy="180" r="2" fill="#06b6d4" opacity="0.3" /> <!-- Heart -->
                        <circle cx="150" cy="270" r="2" fill="#06b6d4" opacity="0.3" /> <!-- Solar Plexus -->
                    </svg>

                    <div id="interactive-layer" class="interactive-layer">
                        <div id="markers-container" class="w-full h-full relative"></div>
                        <div id="active-cursor" class="neuro-cursor">
                            <div class="neuro-cursor-inner"></div>
                        </div>
                    </div>

                </div>
        
                <div class="absolute bottom-6 left-1/2 -translate-x-1/2 w-64 h-48 z-50 mb-safe">
                     <div class="w-full h-full rounded-2xl border border-slate-700 bg-slate-900/90 backdrop-blur-xl shadow-2xl relative overflow-hidden ring-1 ring-gold-500/20"
                          id="sensation-trackpad"
                          ontouchstart="handleTrackpadStart(event)"
                          ontouchmove="handleTrackpadMove(event)"
                          ontouchend="handleTrackpadEnd(event)">
                          
                          <div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(#d4af37 1px, transparent 1px); background-size: 10px 10px;"></div>
                          
                          <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none opacity-60">
                              <i data-lucide="fingerprint" class="w-8 h-8 text-gold-500 mb-2"></i>
                              <span class="text-[9px] uppercase tracking-widest text-gold-500">Touch & Drag</span>
                          </div>
                     </div>
                </div>
            </div>
        </section>

        <section id="view-journal" class="view-section hidden h-full overflow-y-auto p-4">
            <div class="flex justify-between items-end mb-6"><h2 class="text-2xl font-light text-white">History</h2><button onclick="clearJournal()" class="text-xs text-red-400/60 hover:text-red-400 uppercase tracking-wider p-2">Clear All</button></div>
            <div id="journal-list" class="space-y-3 pb-8 overflow-x-hidden"></div>
        </section>

        <section id="view-qa" class="view-section hidden h-full overflow-y-auto p-4">
            <h2 class="text-2xl font-light text-white mb-6">Q & A</h2>
            <div id="qa-container" class="space-y-3 pb-8"></div>
        </section>
    </main>

    <div id="emotion-picker" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] hidden flex-col justify-end" onclick="if(event.target === this) toggleModal('emotion-picker')">
        <div class="bg-slate-900 border-t border-slate-700 rounded-t-3xl w-full max-w-md mx-auto max-h-[70vh] flex flex-col shadow-2xl">
            <div class="flex justify-between items-center p-6 border-b border-slate-800">
                <h3 class="text-lg text-white font-medium">Select Emotion</h3>
                <button onclick="toggleModal('emotion-picker')" class="text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="overflow-y-auto p-2" id="emotion-list-container"></div>
        </div>
    </div>

    <div id="sensation-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[80] hidden items-end sm:items-center justify-center p-4 animate-fade-in" onclick="if(event.target === this) cancelBodyPoint()">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl max-w-sm w-full shadow-2xl mb-safe sm:mb-0">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg text-white font-medium">Describe Sensation</h3><button onclick="cancelBodyPoint()" class="text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-slate-500 uppercase tracking-wider mb-2 block">Sensation</label>
                    <select id="sensation-type" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-gold-500 outline-none">
                        <option value="Tightness">Tightness</option>
                        <option value="Heat">Heat</option>
                        <option value="Pressure">Pressure</option>
                        <option value="Heaviness">Heaviness</option>
                        <option value="Vibration">Vibration</option>
                        <option value="Burning">Burning</option>
                        <option value="Numbness">Numbness</option>
                        <option value="Pins & Needles">Pins & Needles</option>
                        <option value="Ache">Dull Ache</option>
                        <option value="Sharp">Sharp Pain</option>
                    </select>
                </div>
                <div id="sensation-emotion-container">
                    <label class="text-xs text-slate-500 uppercase tracking-wider mb-2 block">Associated Emotion</label>
                    <select id="sensation-emotion" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-gold-500 outline-none">
                        </select>
                </div>
                <div>
                    <label class="text-xs text-slate-500 uppercase tracking-wider mb-2 block">Intensity (1-10)</label>
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-slate-500">1</span>
                        <input type="range" min="1" max="10" value="5" class="flex-1" id="sensation-intensity" oninput="document.getElementById('sens-int-val').textContent = this.value">
                        <span class="text-lg font-mono text-gold-500 w-6 text-center" id="sens-int-val">5</span>
                    </div>
                </div>
                <button onclick="confirmBodyPoint()" class="w-full py-3 bg-medical-500 hover:bg-cyan-400 text-white rounded-xl transition font-medium mt-2">Add Spot</button>
            </div>
        </div>
    </div>

    <div id="complete-modal" class="fixed inset-0 bg-black/95 z-[70] hidden items-center justify-center p-6 animate-fade-in">
        <div class="bg-slate-900 border border-slate-700 p-8 rounded-3xl max-w-sm w-full shadow-2xl text-center">
            <div class="mb-4 text-gold-500 mx-auto bg-gold-500/10 p-3 rounded-full inline-block"><i data-lucide="check" class="w-6 h-6"></i></div>
            <h3 class="text-xl text-white mb-2">Session Complete</h3>
            <p class="text-slate-400 text-xs mb-6">Peak Emotion Intensity</p>
            <div class="mb-8 text-left">
                <div class="flex justify-between text-xs text-slate-500 mb-2"><span>Low</span><span>High</span></div>
                <input type="range" min="1" max="10" value="5" class="w-full" id="timer-intensity-slider" oninput="document.getElementById('timer-intensity-val').textContent = this.value">
                <div class="text-center text-gold-500 font-mono mt-2 text-xl" id="timer-intensity-val">5</div>
            </div>
            <div class="space-y-3">
                <button onclick="transitionToBodyMapFromTimer()" class="w-full py-3 bg-gold-600 hover:bg-gold-500 text-white rounded-xl transition font-medium">Continue to BodyMap</button>
                <button onclick="closeCompleteModal()" class="w-full py-3 border border-slate-700 text-slate-400 hover:text-white rounded-xl transition">Discard</button>
            </div>
        </div>
    </div>

    <div id="bell-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[60] hidden items-end sm:items-center justify-center p-4 animate-fade-in" onclick="if(event.target === this) toggleModal('bell-modal')">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl max-w-xs w-full shadow-2xl mb-safe sm:mb-0">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg text-white font-medium">Interval Bell</h3><button onclick="toggleModal('bell-modal')" class="text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="space-y-2">
                <button onclick="setBellInterval(0)" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">None <span id="bell-check-0" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setBellInterval(1)" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Every 1 Minute <span id="bell-check-1" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setBellInterval(5)" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Every 5 Minutes <span id="bell-check-5" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setBellInterval('half')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Halfway Point <span id="bell-check-half" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
            </div>
        </div>
    </div>
    <div id="ambience-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[60] hidden items-end sm:items-center justify-center p-4 animate-fade-in" onclick="if(event.target === this) toggleModal('ambience-modal')">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl max-w-xs w-full shadow-2xl mb-safe sm:mb-0">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg text-white font-medium">Ambient Sound</h3><button onclick="toggleModal('ambience-modal')" class="text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="space-y-2 max-h-64 overflow-y-auto">
                <button onclick="setAmbience('none')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">None <span id="amb-check-none" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setAmbience('rain')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Rain (Synth) <span id="amb-check-rain" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setAmbience('wind')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Wind (Synth) <span id="amb-check-wind" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setAmbience('river')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">River (Synth) <span id="amb-check-river" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setAmbience('birds')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Birds (Synth) <span id="amb-check-birds" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setAmbience('chimes')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Chimes (Synth) <span id="amb-check-chimes" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
            </div>
        </div>
    </div>

    <script>
        // SHARED VARS
        var currentProcessEmotion = "";
        var processSeconds = 0;
        var currentSelectedEmotion = "";
        var currentTimerSessionLength = 600;
        var globalLogData = [];
        
        // BODY MAP VARS
        var pendingSessionData = null; 
        var currentBodyPoints = []; 
        var pendingPoint = null; 
        var bodyMapSource = ''; 
        var chartsSource = ''; 
        
        // TRACKPAD VARS
        let isDraggingTrackpad = false;
        let lastVibrationGridIndex = -1;
        let isSwiping = false; 

        // --- DATA ---
        const INTRO_QUOTES = [
            { q: "To be surrendered means to have no strong emotion about a thing: 'It's okay if it happens, and it's okay if it doesn't.'", a: "David R. Hawkins" },
            { q: "The more we let go, the more loving we become.", a: "David R. Hawkins" },
            { q: "Peace is the natural state of the Self.", a: "David R. Hawkins" },
            { q: "Everything you see happening is the consequence of that which you are.", a: "David R. Hawkins" },
            { q: "Surrender is a constant process of not resisting or clinging to the moment.", a: "David R. Hawkins" },
            { q: "Love is misunderstood to be an emotion; actually, it is a state of awareness.", a: "David R. Hawkins" },
            { q: "The letting go technique is a system of eliminating the ego.", a: "David R. Hawkins" },
            { q: "When you give up the resistance to the feeling, the energy behind it runs out.", a: "David R. Hawkins" },
            { q: "You are the context in which the content of your life is unfolding.", a: "David R. Hawkins" },
            { q: "All we have to do is hand it over to God.", a: "David R. Hawkins" },
            { q: "You are not the feeling; you are the witness of the feeling.", a: "David R. Hawkins" },
            { q: "What you resist, persists.", a: "David R. Hawkins" },
            { q: "The energy of the suppressed feeling is the cause of the thought.", a: "David R. Hawkins" },
            { q: "We are all doing the best we can with what we have at the moment.", a: "David R. Hawkins" },
            { q: "There is no 'out there'. It is all 'in here'.", a: "David R. Hawkins" },
            { q: "Love promotes healing. When we hold it for others, we are healing ourselves.", a: "David R. Hawkins" },
            { q: "The only thing that stands between you and God is a thought.", a: "David R. Hawkins" },
            { q: "Desire is the energy of 'I want'. Surrender is the energy of 'I have'.", a: "David R. Hawkins" },
            { q: "Humility is the doorway to the truth.", a: "David R. Hawkins" },
            { q: "We get what we want when we stop insisting on it.", a: "David R. Hawkins" }
        ];
        const HAWKINS_SCALE = [ { name: "Shame", val: 20 }, { name: "Guilt", val: 30 }, { name: "Apathy", val: 50 }, { name: "Grief", val: 75 }, { name: "Fear", val: 100 }, { name: "Desire", val: 125 }, { name: "Anger", val: 150 }, { name: "Pride", val: 175 }, { name: "Courage", val: 200 }, { name: "Neutrality", val: 250 }, { name: "Willingness", val: 310 }, { name: "Acceptance", val: 350 }, { name: "Reason", val: 400 }, { name: "Love", val: 500 }, { name: "Joy", val: 540 }, { name: "Peace", val: 600 } ];
        const QA_DATA = [ 
            { category: "Beginner / Skeptic", q: "Why aren't I sensing my feelings inside my body?", a: "This numbness is due to ingrained, conditioned resistance. Because the feeling was unpleasant, the mind automatically pushed it out of awareness. It has been repressed for so long that you have lost touch with the physical sensation. Be patient; simply intending to look is the first step." }, 
            { category: "Beginner / Skeptic", q: "Is this just suppressing feelings?", a: "No. Suppression is pushing a feeling down to avoid it. Letting go is the opposite: it is allowing the feeling to come up, acknowledging it, and letting the energy escape." }, 
            { category: "Beginner / Skeptic", q: "Why should I ignore my thoughts?", a: "Thoughts are rationalizations created by the mind to explain the presence of a feeling. They are often repetitive. Focusing on the physical sensation cuts the fuel supply to thoughts." }, 
            { category: "Beginner / Skeptic", q: "What if the feeling is too strong?", a: "If overwhelmed, surrender to the fear of the feeling first. Acknowledge you are afraid. Let go of resistance to the fear." }, 
            { category: "Beginner / Skeptic", q: "Is there scientific proof for this?", a: "Dr. Hawkins' work correlates vibrational states with muscle testing (kinesiology). While the subjective experience is internal, the physiological benefits of stress reduction are well-documented." }, 
            { category: "Beginner / Skeptic", q: "How is this different from relaxation?", a: "Relaxation often targets the body directly. Letting go targets the emotional energy *causing* the tension. It is a permanent release rather than a temporary respite." }, 
            { category: "Beginner / Skeptic", q: "Can I surrender to physical pain?", a: "Yes. Much pain is held in place by resistance. If you stop resisting the sensation and just experience it as pure energy, it often shifts or diminishes." }, 
            { category: "Novice", q: "Nothing seems to be changing in my life?", a: "Letting Go can be subtle or dramatic, both inwardly and outwardly. Often it is others in our life who notice our change before we do. Like shoveling coal from a pile, we're unaware of the amount we've handled because our focus is on what is at hand." }, 
            { category: "Novice", q: "I feel stuck. Nothing is happening.", a: "You may be 'wanting' it to change. Wanting is resistance. Can you let go of the desire to change it? Can you allow it to just be?" }, 
            { category: "Novice", q: "Can I do this in public?", a: "Yes. It's internal. Notice the tension, drop resistance, and let it pass through while walking or in a meeting." }, 
            { category: "Novice", q: "How do I know if I've let go?", a: "You feel lighter, relieved, or clear. Thoughts stop returning, or lack emotional charge." }, 
            { category: "Novice", q: "Why do I feel worse sometimes?", a: "This is the 'healing crisis.' As you open the doors, suppressed energy rushes up to be released. It feels intense, but it is actually leaving. Stay with it." }, 
            { category: "Novice", q: "Is crying okay?", a: "Absolutely. Crying is a natural mechanism of release, especially for Grief. Do not suppress the tears; let them flow until they stop on their own." }, 
            { category: "Adept", q: "Spiritual Pride", a: "Watch out for the ego claiming credit for your progress. 'Look how spiritual I am' is just another feeling (Pride) to be surrendered." }, 
            { category: "Adept", q: "Running out of things to surrender?", a: "You may reach periods of peace, but deeper layers often emerge later. Remain vigilant for subtle attachments to comfort or even to the practice itself." }, 
            { category: "Adept", q: "Handling major crises", a: "In a crisis, the volume of emotion is high. This is actually a golden opportunity. A massive amount of karma can be discharged quickly if you can stay present with the raw energy without resisting." }, 
            { category: "Adept", q: "Attachment to outcomes", a: "Surrender doesn't mean you don't act; it means you surrender your attachment to the result. You do your best and let go of the rest." }, 
            { category: "Adept", q: "The dark night of the soul?", a: "This often occurs before a major transition. It feels like abandonment or total despair. It is the ego facing its own demise. Surrender to the despair itself." }, 
            { category: "Pro", q: "The Witness Trap", a: "At high levels, one can become attached to the 'Observer' role to dissociate from subtle pain. Are you witnessing to avoid feeling? Surrender the position of the witness to become the experience itself, then surrender that." }, 
            { category: "Pro", q: "Somatic Holding Patterns", a: "When the mind is silent but the body remains tense, you are hitting somatic repression. The energy is no longer generating thoughts but is trapped in the fascia. Drop resistance to the physical tightness itself, without labeling it as 'tension'." }, 
            { category: "Pro", q: "Surrendering Positive States?", a: "Yes. When you reach joy or ecstasy, surrender the attachment to it. The fear that it will end is 'Fear'. The desire to keep it is 'Desire'. Letting go of the 'high' allows you to settle into the permanent bedrock of Peace." }, 
            { category: "Pro", q: "Subtle Apathy vs Peace", a: "Apathy feels blank, heavy, and 'I don't care'. Peace feels alive, light, and 'I have everything'. If the silence feels dead, it is Apathy. Look for the subtle resistance to being alive." }, 
            { category: "Pro", q: "The 'I' Thought", a: "Eventually, you notice that for every feeling, there is a subtle 'me' feeling it. This 'I-ness' is the root. Instead of surrendering the object (the feeling), surrender the subject (the 'I'). Ask 'Who is feeling this?' and surrender the answer." }
        ];

        // STATE
        let activeTab = 'guide';
        let timerInterval, timerDuration = 600, defaultDuration = 600, timerEndTime = 0, isTimerRunning = false;
        let bellInterval = 0, currentAmbience = 'none', audioContext, noiseNode, modOsc, birdInterval, chimeInterval;
        let processInterval, processStartTime = 0, pickerCallback, progressChart;
        let lastBellMinute = -1, halfwayBellPlayed = false;
        
        // TOUCH VARS
        let touchStartX = 0, currentSwipeItem = null;
        let globalTouchStartX = 0;

        window.onload = function() {
            // Ensure Intro plays first
            initIntro();
            
            lucide.createIcons();
            initQA();
            initEmotionPicker();
            initSensationEmotionPicker();
            updateTimerDisplay();
            loadJournal();
            
            // If dismissed in session, hide immediately
            if (sessionStorage.getItem('intro_dismissed')) {
                document.getElementById('intro-screen').style.display = 'none';
            }
            
            document.addEventListener('click', unlockAudio, { once: true });
            document.addEventListener('touchstart', unlockAudio, { once: true });
        };

        function initIntro() { 
            const quoteObj = INTRO_QUOTES[Math.floor(Math.random()*INTRO_QUOTES.length)];
            const textEl = document.getElementById('intro-quote-text');
            const authEl = document.getElementById('intro-quote-author');
            if(textEl) {
                textEl.textContent = quoteObj.q;
                textEl.style.opacity = '1';
            }
            if(authEl) {
                authEl.textContent = "â€” " + quoteObj.a;
                authEl.style.opacity = '0.8';
            }
        }
        
        function dismissIntro() { 
            unlockAudio();
            document.getElementById('intro-screen').style.opacity='0'; 
            sessionStorage.setItem('intro_dismissed', 'true');
            setTimeout(()=>{ document.getElementById('intro-screen').style.display='none'; },1000); 
        }
        
        function toggleMenu() { document.body.classList.toggle('side-menu-open'); }
        function toggleSettings() { toggleMenu(); } 

        // FIXED SWIPE LOGIC
        window.handleTouchStart = (e, el) => {
            touchStartX = e.touches[0].clientX;
            currentSwipeItem = el;
            el.style.transition = 'none'; 
            isSwiping = false; 
        };

        window.handleTouchMove = (e, el) => {
            if (!currentSwipeItem) return;
            const touchX = e.touches[0].clientX;
            const diff = touchX - touchStartX;
            
            if (Math.abs(diff) > 5) isSwiping = true;

            const isOpen = el.dataset.isOpen === 'true';
            let newTranslate = 0;
            if (!isOpen) { if (diff < 0) newTranslate = Math.max(diff, -80); } 
            else { newTranslate = -80 + diff; newTranslate = Math.max(Math.min(newTranslate, 0), -80); }
            el.style.transform = `translateX(${newTranslate}px)`;
        };

        window.handleTouchEnd = (e, el) => {
            if (!currentSwipeItem) return;
            el.style.transition = 'transform 0.2s ease-out';
            const styleTransform = el.style.transform;
            const match = /translateX\(([^p]+)px\)/.exec(styleTransform);
            const currentTranslate = match ? parseFloat(match[1]) : 0;
            if (currentTranslate < -40) { el.style.transform = 'translateX(-80px)'; el.dataset.isOpen = 'true'; } 
            else { el.style.transform = 'translateX(0)'; el.dataset.isOpen = 'false'; }
            
            currentSwipeItem = null;
        };

        // EDGE SWIPE LOGIC (Navigation)
        window.handleGlobalTouchStart = (e) => { globalTouchStartX = e.touches[0].clientX; };
        window.handleGlobalTouchMove = (e) => { 
             const x = e.touches[0].clientX;
             const isMenuOpen = document.body.classList.contains('side-menu-open');
             if (isMenuOpen && (x - globalTouchStartX) > 0) {} 
        };
        window.handleGlobalTouchEnd = (e) => {
            const diff = e.changedTouches[0].clientX - globalTouchStartX;
            const width = window.innerWidth;
            const isMenuOpen = document.body.classList.contains('side-menu-open');
            if (!isMenuOpen && globalTouchStartX > width - 50 && diff < -50) { document.body.classList.add('side-menu-open'); }
            else if (isMenuOpen && diff > 50) { document.body.classList.remove('side-menu-open'); }
        };

        // ROBUST AUDIO ENGINE REWRITE
        function unlockAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!audioContext) { audioContext = new AudioContext(); }
            if (audioContext.state === 'suspended') { audioContext.resume().then(() => console.log("Audio Context Resumed")); }
        }

        function createWhiteNoise() {
            if(!audioContext) return;
            const bufferSize = audioContext.sampleRate * 2; 
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) { output[i] = Math.random() * 2 - 1; }
            return buffer;
        }

        function playBell() {
            unlockAudio();
            if(!audioContext || audioContext.state === 'suspended') { unlockAudio(); setTimeout(playBell, 100); return; }
            const t = audioContext.currentTime;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, t);
            osc.frequency.exponentialRampToValueAtTime(110, t + 3); 
            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(0.4, t + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, t + 4); 
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start(t);
            osc.stop(t + 4.5);
        }

        function stopAmbience() { 
            if(noiseNode) { try{noiseNode.stop()}catch(e){}; noiseNode.disconnect(); noiseNode=null; } 
            if(modOsc) { try{modOsc.stop()}catch(e){}; modOsc.disconnect(); modOsc=null; } 
            if(birdInterval) { clearInterval(birdInterval); birdInterval=null; } 
            if(chimeInterval) { clearInterval(chimeInterval); chimeInterval=null; } 
        }

        function playAmbience(type) {
            stopAmbience(); 
            unlockAudio();
            if(!audioContext || audioContext.state === 'suspended') { unlockAudio(); setTimeout(() => playAmbience(type), 100); return; }
            const t = audioContext.currentTime;
            const gain = audioContext.createGain();
            gain.connect(audioContext.destination);

            if(type === 'rain') { 
                const buffer = createWhiteNoise();
                noiseNode = audioContext.createBufferSource();
                noiseNode.buffer = buffer;
                noiseNode.loop = true;
                const filter = audioContext.createBiquadFilter();
                filter.type = 'lowpass'; filter.frequency.value = 400; 
                noiseNode.connect(filter); filter.connect(gain);
                gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.15, t + 2); 
                noiseNode.start(t);
            }
            else if(type === 'wind') { 
                const buffer = createWhiteNoise();
                noiseNode = audioContext.createBufferSource();
                noiseNode.buffer = buffer;
                noiseNode.loop = true;
                const filter = audioContext.createBiquadFilter();
                filter.type = 'bandpass'; filter.frequency.value = 400; filter.Q.value = 1;
                modOsc = audioContext.createOscillator();
                modOsc.frequency.value = 0.1; 
                const modGain = audioContext.createGain();
                modGain.gain.value = 200;
                modOsc.connect(modGain); modGain.connect(filter.frequency);
                noiseNode.connect(filter); filter.connect(gain);
                gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.15, t + 2); 
                noiseNode.start(t); modOsc.start(t);
            }
            else if(type === 'river') {
                const buffer = createWhiteNoise();
                noiseNode = audioContext.createBufferSource();
                noiseNode.buffer = buffer;
                noiseNode.loop = true;
                const filter = audioContext.createBiquadFilter();
                filter.type = 'lowpass'; filter.frequency.value = 250; 
                noiseNode.connect(filter); filter.connect(gain);
                gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.3, t + 2); 
                noiseNode.start(t);
            }
            else if(type === 'birds') {
                birdInterval = setInterval(() => { if(Math.random() > 0.7) playSingleBird(); }, 2000);
            }
            else if(type === 'chimes') {
                chimeInterval = setInterval(() => { if(Math.random() > 0.6) playSingleChime(); }, 3000);
                playSingleChime();
            }
        }

        function playSingleBird() {
            unlockAudio(); if(!audioContext) return;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain); gain.connect(audioContext.destination);
            const t = audioContext.currentTime;
            const freq = 2000 + Math.random() * 1500;
            osc.frequency.setValueAtTime(freq, t);
            osc.frequency.linearRampToValueAtTime(freq + 500, t + 0.1);
            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(0.05, t + 0.05);
            gain.gain.linearRampToValueAtTime(0, t + 0.2);
            osc.start(t); osc.stop(t + 0.3);
        }

        function playSingleChime() {
            unlockAudio(); if(!audioContext) return;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain); gain.connect(audioContext.destination);
            const t = audioContext.currentTime;
            const freqs = [523.25, 659.25, 783.99, 1046.50]; 
            osc.frequency.value = freqs[Math.floor(Math.random() * freqs.length)];
            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(0.05, t + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, t + 3);
            osc.start(t); osc.stop(t + 3.5);
        }

        // TIMER Logic
        function toggleTimer() {
            unlockAudio();
            const btn = document.getElementById('timer-toggle'), emotionBtn = document.getElementById('timer-emotion-btn');
            if (!currentSelectedEmotion && !isTimerRunning) { emotionBtn.classList.add('shake-error'); setTimeout(() => { emotionBtn.classList.remove('shake-error'); }, 500); return; }
            const bc = document.getElementById('breath-circle'), d = document.getElementById('timer-display');
            if (isTimerRunning) {
                const now = Date.now(), rem = Math.ceil((timerEndTime - now)/1000); timerDuration = rem > 0 ? rem : 0; isTimerRunning = false; clearInterval(timerInterval); stopAmbience();
                btn.innerHTML = '<i data-lucide="play" class="w-8 h-8 fill-current ml-1"></i>'; bc.classList.remove('animate-breathe'); bc.style.transform='scale(1)'; d.disabled = false; updateTimerDisplay();
            } else {
                if (timerDuration <= 0) timerDuration = defaultDuration;
                currentTimerSessionLength = timerDuration; isTimerRunning = true; timerEndTime = Date.now() + (timerDuration*1000);
                lastBellMinute = -1; halfwayBellPlayed = false; 
                if(currentAmbience !== 'none') playAmbience(currentAmbience);
                btn.innerHTML = '<i data-lucide="pause" class="w-8 h-8 fill-current"></i>'; bc.classList.add('animate-breathe'); d.disabled = true; updateTimerDisplay();
                timerInterval = setInterval(() => {
                    const now = Date.now(), rem = Math.ceil((timerEndTime - now)/1000);
                    if (bellInterval !== 0 && rem > 0) {
                        const elapsed = currentTimerSessionLength - rem;
                        if (bellInterval === 'half') {
                            const halfWay = Math.floor(currentTimerSessionLength / 2);
                            if (Math.abs(elapsed - halfWay) < 2 && !halfwayBellPlayed) { playBell(); halfwayBellPlayed = true; }
                        } else {
                            const currentMinute = Math.floor(elapsed / 60);
                            if (currentMinute > lastBellMinute && currentMinute > 0 && currentMinute % bellInterval === 0) { lastBellMinute = currentMinute; playBell(); }
                        }
                    }
                    if (rem <= 0) { timerDuration = 0; isTimerRunning = false; clearInterval(timerInterval); stopAmbience(); playBell(); btn.innerHTML = '<i data-lucide="play" class="w-8 h-8 fill-current ml-1"></i>'; bc.classList.remove('animate-breathe'); bc.style.transform='scale(1)'; d.value="00:00"; d.disabled=false; document.getElementById('complete-modal').classList.remove('hidden'); document.getElementById('complete-modal').classList.add('flex'); } else updateTimerDisplay();
                }, 1000);
            }
            lucide.createIcons();
        }
        function formatTime(sec) { if (sec < 0) sec = 0; const m = Math.floor(sec/60).toString().padStart(2,'0'), s = (sec%60).toString().padStart(2,'0'); return `${m}:${s}`; }
        function updateTimerDisplay() { let sec = timerDuration; if(isTimerRunning) { const now = Date.now(), rem = Math.ceil((timerEndTime - now)/1000); sec = rem > 0 ? rem : 0; } document.getElementById('timer-display').value = formatTime(sec); }
        
        function handleTimerInput(input) { 
            let val = input.value.replace(/\D/g, ''); 
            if (val.length > 4) val = val.slice(-4); 
            val = val.padStart(4, '0'); 
            const m = parseInt(val.slice(0, 2), 10); 
            const s = parseInt(val.slice(2, 4), 10); 
            timerDuration = (m * 60) + s; 
            defaultDuration = timerDuration; 
            input.value = `${val.slice(0,2)}:${val.slice(2,4)}`; 
        }
        
        function adjustTimer(amt) { 
            unlockAudio(); 
            if(isTimerRunning) return; 
            if(timerDuration+amt > 0) { timerDuration+=amt; defaultDuration=timerDuration; updateTimerDisplay(); } 
        }
        
        function resetTimer() { 
            unlockAudio();
            isTimerRunning = false; clearInterval(timerInterval); stopAmbience(); 
            timerDuration = defaultDuration; 
            const btn = document.getElementById('timer-toggle'), bc = document.getElementById('breath-circle'), d = document.getElementById('timer-display'); 
            if(btn) btn.innerHTML = '<i data-lucide="play" class="w-8 h-8 fill-current ml-1"></i>'; 
            if(bc) { bc.classList.remove('animate-breathe'); bc.style.transform='scale(1)'; } 
            if(d) d.disabled = false; 
            lucide.createIcons(); updateTimerDisplay(); 
        }

        // UI HELPERS
        function toggleModal(id) {
            const el = document.getElementById(id);
            if (!el) return;
            // Specific handling for the Emotion Picker to slide smoothly
            if (id === 'emotion-picker') {
                const panel = el.firstElementChild;
                const isHidden = el.classList.contains('hidden');
                if (isHidden) {
                    el.classList.remove('hidden'); el.classList.add('flex');
                    el.classList.remove('animate-fade-out'); el.classList.add('animate-fade-in');
                    panel.classList.remove('animate-slide-down'); panel.classList.add('animate-slide-up');
                } else {
                    if (pickerCallback) pickerCallback = null;
                    el.classList.remove('animate-fade-in'); el.classList.add('animate-fade-out');
                    panel.classList.remove('animate-slide-up'); panel.classList.add('animate-slide-down');
                    setTimeout(() => { if (el.classList.contains('animate-fade-out')) { el.classList.add('hidden'); el.classList.remove('flex'); } }, 280);
                }
                return;
            }
            if(id === 'sensation-modal' && el.classList.contains('hidden')) {
                const emotionContainer = document.getElementById('sensation-emotion-container');
                if(bodyMapSource === 'timer' || bodyMapSource === 'process') {
                    emotionContainer.classList.add('hidden');
                } else {
                    emotionContainer.classList.remove('hidden');
                }
            }
            if (id === 'emotion-picker' && !el.classList.contains('hidden')) pickerCallback = null; 
            el.classList.toggle('hidden');
            el.classList.toggle('flex');
        }

        function setBellInterval(val) { 
            unlockAudio(); bellInterval=val; 
            ['0','1','5','half'].forEach(v => document.getElementById(`bell-check-${v}`).classList.add('hidden')); 
            document.getElementById(`bell-check-${val}`).classList.remove('hidden'); 
            const mainInd = document.getElementById('bell-status');
            const procInd = document.getElementById('process-bell-status');
            if(mainInd) mainInd.classList.toggle('hidden', val===0);
            if(procInd) procInd.classList.toggle('hidden', val===0);
            toggleModal('bell-modal'); 
        }
        function setAmbience(val) { 
            unlockAudio(); currentAmbience=val; 
            ['none','rain','wind','river','birds','chimes'].forEach(v => document.getElementById(`amb-check-${v}`).classList.add('hidden')); 
            document.getElementById(`amb-check-${val}`).classList.remove('hidden'); 
            const mainInd = document.getElementById('ambience-status');
            const procInd = document.getElementById('process-ambience-status');
            if(mainInd) mainInd.classList.toggle('hidden', val==='none');
            if(procInd) procInd.classList.toggle('hidden', val==='none');
            if(isTimerRunning || document.getElementById('process-step-4').classList.contains('hidden') === false) playAmbience(val); 
            toggleModal('ambience-modal'); 
        }
        function initQA() { const c=document.getElementById('qa-container'); if(!c) return; let html="", cat=""; QA_DATA.forEach((item,i)=>{ if(item.category!==cat){ cat=item.category; html+=`<h3 class="text-gold-500 text-xs uppercase tracking-widest mt-6 mb-2 font-medium pl-1">${cat}</h3>`; } html+=`<div class="glass-panel rounded-xl overflow-hidden mb-3"><button onclick="toggleFAQ(${i})" class="w-full px-5 py-4 text-left flex justify-between items-center hover:bg-slate-800/50 transition focus:outline-none select-none"><span class="text-slate-200 font-medium pr-4 text-sm">${item.q}</span><i data-lucide="chevron-down" id="faq-icon-${i}" class="faq-icon w-4 h-4 text-slate-500 shrink-0"></i></button><div id="faq-ans-${i}" class="faq-answer bg-slate-900/30 border-t border-slate-800/50"><p class="p-5 text-slate-400 text-sm leading-relaxed font-light">${item.a}</p></div></div>`; }); c.innerHTML=html; lucide.createIcons(); }
        function toggleFAQ(i) { const a=document.getElementById(`faq-ans-${i}`), ic=document.getElementById(`faq-icon-${i}`); a.classList.toggle('active'); ic.classList.toggle('active'); }
        function initEmotionPicker() { const c=document.getElementById('emotion-list-container'); if(c) c.innerHTML = HAWKINS_SCALE.map(e => `<button onclick="selectEmotion('${e.name}')" class="w-full text-left px-6 py-4 border-b border-slate-800 text-slate-300 hover:bg-slate-800 transition flex justify-between items-center group"><span class="font-medium text-lg">${e.name}</span><span class="text-xs text-slate-600 font-mono group-hover:text-gold-500">${e.val}</span></button>`).join(''); }
        function initSensationEmotionPicker() {
            const s = document.getElementById('sensation-emotion');
            if(s) {
                s.innerHTML = HAWKINS_SCALE.map(e => `<option value="${e.name}">${e.name} (${e.val})</option>`).join('');
            }
        }
        
        function selectEmotion(n) { 
            setCurrentEmotion(n);
            toggleModal('emotion-picker');
        }
        
        function setCurrentEmotion(n) {
            currentSelectedEmotion=n;
            if(pickerCallback) { 
                pickerCallback(n); 
                pickerCallback=null; 
            } else { 
                const d1=document.getElementById('process-emotion-display');
                const d2=document.getElementById('timer-emotion-display');
                const d3=document.getElementById('chart-emotion-display');
                if(d1) { d1.textContent=n; d1.classList.add('text-white'); } 
                if(d2) { d2.textContent=n; d2.classList.add('text-gold-500'); } 
                if(d3) { d3.textContent=n; } 
                loadChart(n); 
            }
        }

        function openPickerFor(ctx) { toggleModal('emotion-picker'); if(ctx==='process') pickerCallback=n=>{ const el=document.getElementById('process-emotion-display'); el.textContent=n; el.classList.remove('text-slate-400'); el.classList.add('text-white'); }; else if(ctx==='timer') pickerCallback=n=>{ const el=document.getElementById('timer-emotion-display'); el.textContent=n; el.classList.add('text-gold-500'); }; else if(ctx==='chart') pickerCallback=n=>{ document.getElementById('chart-emotion-display').textContent=n; loadChart(n); }; }
        
        // SMOOTH SWITCH
        function switchTab(id) {
            const current = document.querySelector('.view-section.active-view');
            const next = document.getElementById(`view-${id}`);
            if (current && current.id === `view-${id}`) { document.body.classList.remove('side-menu-open'); return; }
            document.querySelectorAll('.menu-link').forEach(b=>b.classList.remove('active')); 
            const btn = document.getElementById(`menu-${id}`); if(btn) btn.classList.add('active');
            document.body.classList.remove('side-menu-open');
            activeTab=id;
            if(id==='qa') initQA(); if(id==='journal') loadJournal(); 
            if(id==='charts') document.getElementById('chart-emotion-btn').onclick=()=>openPickerFor('chart'); 
            if(id==='process') document.getElementById('process-emotion-btn').onclick=()=>openPickerFor('process');
            if (current) {
                current.classList.remove('active-view');
                setTimeout(() => { current.classList.add('hidden'); if(next) { next.classList.remove('hidden'); requestAnimationFrame(() => { requestAnimationFrame(() => { next.classList.add('active-view'); }); }); } }, 200);
            } else { if(next) { next.classList.remove('hidden'); next.classList.add('active-view'); } }
        }

        function openCharts(source) { 
            chartsSource = source || 'insights';
            switchTab('charts'); 
        }
        
        function exitCharts() {
            if (chartsSource === 'journal') {
                switchTab('journal');
            } else {
                switchTab('insights');
            }
        }
        
        function openBodyMap() { 
            openBodyMapList();
            switchTab('bodymap');
        }

        function openBodyMapList() {
            document.getElementById('bodymap-list-view').classList.remove('hidden');
            document.getElementById('bodymap-canvas-view').classList.add('hidden');
            document.getElementById('bodymap-back-btn').classList.add('hidden');
            document.getElementById('bodymap-exit-btn').classList.remove('hidden');
            document.getElementById('bodymap-save-btn').classList.add('hidden');
            
            const bodyLogs = globalLogData.filter(l => l.bodyPoints && l.bodyPoints.length > 0);
            const container = document.getElementById('bodymap-log-container');
            
            if (bodyLogs.length === 0) {
                container.innerHTML = `<div class="text-center py-16 animate-fade-in"><div class="text-slate-800 mb-4"><i data-lucide="activity" class="w-16 h-16 mx-auto"></i></div><p class="text-slate-600 text-sm">No somatic maps recorded.</p><button onclick="startNewMapSession()" class="mt-6 text-gold-500 text-xs uppercase tracking-widest border border-slate-800 px-4 py-2 rounded-lg hover:bg-slate-800 transition">New Scan</button></div>`;
            } else {
                container.innerHTML = `<div class="mb-4 px-1"><button onclick="startNewMapSession()" class="w-full py-3 border border-slate-800 text-slate-400 hover:text-white hover:bg-slate-900 rounded-xl text-xs uppercase tracking-widest transition">+ New Scan</button></div>` + 
                bodyLogs.map((e, i) => {
                    const idParam = e.id ? `'${e.id}'` : i; 
                    return `<div class="relative overflow-hidden rounded-xl mb-3 animate-fade-in swipe-container" style="animation-delay: ${i*50}ms">
                        <div class="delete-action bg-red-600 text-white" onclick="deleteEntry(${idParam})"><i data-lucide="trash-2" class="w-5 h-5"></i></div>
                        <div class="glass-panel p-5 flex justify-between items-center swipe-item" ontouchstart="handleTouchStart(event, this)" ontouchmove="handleTouchMove(event, this)" ontouchend="handleTouchEnd(event, this)" onclick="if(!isSwiping) loadBodySession('${e.id || i}')">
                            <div class="flex-1 pr-4">
                                <h3 class="text-white font-medium capitalize text-lg truncate">${e.emotion}</h3>
                                <p class="text-xs text-slate-500 mt-1">${e.date} â€¢ ${e.time}</p>
                            </div>
                            <div class="text-right shrink-0">
                                <div class="text-gold-500 text-xs"><i data-lucide="map-pin" class="w-3 h-3 inline mr-1"></i>${e.bodyPoints.length}</div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
            lucide.createIcons();
        }

        function startNewMapSession() {
            pendingSessionData = {
                emotion: "Check-in",
                date: new Date().toLocaleDateString(undefined, {month:'short', day:'numeric'}),
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                duration: 0,
                intensity: 5,
                timestamp: Date.now()
            };
            currentBodyPoints = [];
            bodyMapSource = 'insights_new';
            switchToCanvasMode();
        }

        function loadBodySession(id) {
            let session;
            if(typeof id === 'string' && id.length > 10) {
                session = globalLogData.find(l => l.id === id);
            } else {
                session = globalLogData[id];
            }
            if(!session) return;
            
            pendingSessionData = { ...session };
            currentBodyPoints = session.bodyPoints || [];
            bodyMapSource = 'insights_view';
            switchToCanvasMode();
        }

        function switchToCanvasMode() {
            document.getElementById('bodymap-list-view').classList.add('hidden');
            document.getElementById('bodymap-canvas-view').classList.remove('hidden');
            
            if (bodyMapSource === 'insights_new' || bodyMapSource === 'insights_view') {
                document.getElementById('bodymap-back-btn').classList.remove('hidden');
                document.getElementById('bodymap-exit-btn').classList.add('hidden');
            } else {
                document.getElementById('bodymap-back-btn').classList.add('hidden'); 
                document.getElementById('bodymap-exit-btn').classList.add('hidden'); 
            }
            
            document.getElementById('bodymap-save-btn').classList.remove('hidden');
            renderBodyMarkers();
        }

        // BRIDGE FUNCTIONS
        window.saveTimerSession = () => {}; window.saveAndClose = () => {}; window.deleteEntry = () => {}; window.renameEntry = () => {}; window.clearJournal = () => {}; window.loadJournal = () => {};
        window.startProcess = () => { if(!currentSelectedEmotion) { alert("Please select an emotion first."); return; } currentProcessEmotion = currentSelectedEmotion; document.querySelectorAll('.current-emotion').forEach(el=>el.textContent=currentProcessEmotion); processSeconds=0; nextStep(1); document.getElementById('process-reset-btn').classList.remove('hidden'); };
        window.nextStep = (s) => { 
            document.querySelectorAll('.process-step').forEach(e=>e.classList.add('hidden')); 
            const t=document.getElementById(`process-step-${s}`); 
            t.classList.remove('hidden'); t.classList.add('animate-fade-in'); 
            if(s===4) {
                startProcessTimer(); 
                if(currentAmbience !== 'none') playAmbience(currentAmbience);
            } else stopProcessTimer(); 
            if(s===5) document.getElementById('process-reset-btn').classList.add('hidden'); 
        };
        window.startProcessTimer = () => { const d=document.getElementById('process-timer'); processSeconds=0; d.textContent="00:00"; if(processInterval) clearInterval(processInterval); processStartTime=Date.now(); processInterval=setInterval(()=>{ const now=Date.now(); processSeconds=Math.floor((now-processStartTime)/1000); const m=Math.floor(processSeconds/60).toString().padStart(2,'0'), s=(processSeconds%60).toString().padStart(2,'0'); d.textContent=`${m}:${s}`; },1000); };
        window.stopProcessTimer = () => { if(processInterval) clearInterval(processInterval); };
        window.finishProcess = () => { stopProcessTimer(); stopAmbience(); nextStep(5); };
        window.resetProcess = () => { stopProcessTimer(); stopAmbience(); document.querySelectorAll('.process-step').forEach(e=>e.classList.add('hidden')); document.getElementById('process-step-0').classList.remove('hidden'); document.getElementById('process-reset-btn').classList.add('hidden'); };
        
        // --- UPDATED BODY MAP LOGIC WITH IMPROVED TRACKING ---

        const BODY_WIDTH = 300;
        const BODY_HEIGHT = 700;

        function handleTrackpadStart(e) {
            e.preventDefault();
            isDraggingTrackpad = true;
            const cursor = document.getElementById('active-cursor');
            const label = document.getElementById('body-part-label');
            
            cursor.style.display = 'block';
            // Temporarily disable transition for instant jump to start position
            cursor.style.transition = 'none'; 
            
            label.style.opacity = '1';
            updateCursorPosition(e.touches[0]);
            
            // Restore transition for smooth dragging
            requestAnimationFrame(() => {
                cursor.style.transition = 'transform 0.06s linear';
            });
        }

        function handleTrackpadMove(e) {
            e.preventDefault();
            if(!isDraggingTrackpad) return;
            updateCursorPosition(e.touches[0]);
        }

        function handleTrackpadEnd(e) {
            e.preventDefault();
            isDraggingTrackpad = false;
            if(pendingPoint) {
                toggleModal('sensation-modal');
            }
        }

        function updateCursorPosition(touch) {
            const pad = document.getElementById('sensation-trackpad');
            const padRect = pad.getBoundingClientRect();
            
            // 1. Get Normalised Coordinates (0 to 1)
            let tx = (touch.clientX - padRect.left) / padRect.width;
            let ty = (touch.clientY - padRect.top) / padRect.height;
            
            tx = Math.max(0, Math.min(1, tx));
            ty = Math.max(0, Math.min(1, ty));

            // 2. Map Trackpad to SVG Coordinates
            const bodyX = tx * BODY_WIDTH;
            const bodyY = ty * BODY_HEIGHT;

            // 3. Move Cursor using TRANSFORM (Hardware Accelerated, No Traces)
            const cursor = document.getElementById('active-cursor');
            cursor.style.transform = `translate3d(${bodyX}px, ${bodyY}px, 0)`;

            // 4. Identify Region (New Logic matched to new SVG)
            const region = identifyBodyRegion(bodyX, bodyY);
            const label = document.getElementById('body-part-label');
            
            if (label.textContent !== region) {
                label.textContent = region;
                if (navigator.vibrate) navigator.vibrate(5);
            }

            pendingPoint = { x: tx, y: ty, region };
        }

        function identifyBodyRegion(x, y) {
            // Updated Logic for the new Anatomical Silhouette (300x700)
            
            // HEAD (0 - 90)
            if (y < 90) {
                if (y < 45) return "Crown";
                if (y < 65) return "Forehead";
                if (x > 130 && x < 170) return "Face / Nose";
                if (x < 130) return "Left Temple";
                if (x > 170) return "Right Temple";
                return "Jaw / Mouth";
            }
            
            // NECK (90 - 110)
            if (y < 115) {
                if (x > 135 && x < 165) return "Throat";
                return "Neck";
            }

            // SHOULDERS & UPPER CHEST (115 - 150)
            if (y < 150) {
                if (x < 100 || x > 200) return "Shoulder";
                return "Collarbone / Upper Chest";
            }

            // CHEST / ARMS SPLIT (150 - 240)
            if (y < 240) {
                // Arms are on the outside
                if (x < 90 || x > 210) return "Upper Arm";
                
                // Torso Center
                if (y < 190) {
                    if (x > 140 && x < 160) return "Heart Center";
                    return "Chest";
                }
                return "Solar Plexus"; // 190-240 Center
            }

            // MID SECTION / ARMS (240 - 320)
            if (y < 320) {
                // Arms/Elbows
                if (x < 90 || x > 210) {
                    if (y < 260) return "Elbow";
                    return "Forearm";
                }
                
                // Torso
                if (x > 140 && x < 160) return "Navel";
                return "Stomach / Gut";
            }

            // HIPS / HANDS (320 - 390)
            if (y < 390) {
                // Hands (Very low on this model)
                if (x < 80 || x > 220) return "Hand / Fingers";
                
                // Hips
                if (x < 110 || x > 190) return "Hip";
                return "Pelvis / Root";
            }

            // LEGS (390+)
            if (y < 520) return "Thigh";
            if (y < 560) return "Knee";
            if (y < 640) return "Shin / Calf";
            return "Foot / Ankle";
        }

        function confirmBodyPoint() {
            const type = document.getElementById('sensation-type').value;
            const emotion = document.getElementById('sensation-emotion').value;
            const intensity = document.getElementById('sensation-intensity').value;
            
            if(pendingPoint) {
                currentBodyPoints.push({
                    x: pendingPoint.x,
                    y: pendingPoint.y,
                    region: pendingPoint.region,
                    sensation: type,
                    relatedEmotion: emotion,
                    intensity: intensity
                });
                renderBodyMarkers();
            }
            
            toggleModal('sensation-modal');
            document.getElementById('active-cursor').style.display = 'none';
            document.getElementById('body-part-label').style.opacity = '0';
            pendingPoint = null;
        }

        function cancelBodyPoint() {
            toggleModal('sensation-modal');
            document.getElementById('active-cursor').style.display = 'none';
            document.getElementById('body-part-label').style.opacity = '0';
            pendingPoint = null;
        }

        function deleteBodyPoint(index) {
            if(confirm("Remove this spot?")) {
                currentBodyPoints.splice(index, 1);
                renderBodyMarkers();
            }
        }

        function renderBodyMarkers() {
            const container = document.getElementById('markers-container');
            container.innerHTML = '';
            
            currentBodyPoints.forEach((p, i) => {
                const el = document.createElement('div');
                el.className = 'body-marker';
                el.onclick = (e) => { e.stopPropagation(); deleteBodyPoint(i); };
                
                // Intensity -> Size/Opacity
                const size = 12 + (p.intensity * 1.5); 
                const opacity = 0.4 + (p.intensity / 20);
                
                el.style.width = `${size}px`;
                el.style.height = `${size}px`;
                el.style.backgroundColor = `rgba(212, 175, 55, ${opacity})`; // Gold Markers
                // Use standard positioning for static markers
                el.style.left = `${p.x * BODY_WIDTH}px`;
                el.style.top = `${p.y * BODY_HEIGHT}px`;
                
                container.appendChild(el);
            });
        }

        window.transitionToBodyMapFromTimer = () => {
            const intensity = document.getElementById('timer-intensity-slider').value;
            const emotion = window.currentSelectedEmotion || "Meditation";
            
            pendingSessionData = {
                emotion: emotion,
                date: new Date().toLocaleDateString(undefined, {month:'short', day:'numeric'}),
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                duration: window.currentTimerSessionLength,
                intensity: intensity,
                timestamp: Date.now()
            };

            currentBodyPoints = [];
            bodyMapSource = 'timer'; 
            
            document.getElementById('complete-modal').classList.add('hidden'); 
            document.getElementById('complete-modal').classList.remove('flex');
            resetTimer(); 
            switchTab('bodymap');
            setTimeout(() => switchToCanvasMode(), 50); 
        };

        window.transitionToBodyMapFromProcess = () => {
            const intensity = document.getElementById('process-intensity-slider').value;
            
            pendingSessionData = {
                emotion: window.currentProcessEmotion,
                date: new Date().toLocaleDateString(undefined, {month:'short', day:'numeric'}),
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                duration: window.processSeconds,
                intensity: intensity,
                timestamp: Date.now()
            };

            currentBodyPoints = [];
            bodyMapSource = 'process';
            resetProcess();

            switchTab('bodymap');
            setTimeout(() => switchToCanvasMode(), 50);
        };

        // --- FINAL SAVE ---

        window.finalizeSession = async () => {
            if(!pendingSessionData) { 
                if(bodyMapSource === 'timer') switchTab('timer');
                else if(bodyMapSource === 'process') switchTab('process');
                else switchTab('insights');
                return; 
            }
            
            pendingSessionData.bodyPoints = currentBodyPoints;

            if (isLoggedIn && currentUser) { 
                try { 
                    if(pendingSessionData.id && window.updateSessionInFirebase) {
                        await window.updateSessionInFirebase(pendingSessionData.id, { bodyPoints: currentBodyPoints });
                    } else if (window.saveSessionToFirebase) {
                        await window.saveSessionToFirebase(pendingSessionData);
                    }
                } catch (e) { alert("Error saving: " + e.message); } 
            } else { 
                const rel = JSON.parse(localStorage.getItem('releases') || '[]'); 
                if (pendingSessionData.id) {
                } else {
                    rel.unshift(pendingSessionData); 
                    localStorage.setItem('releases', JSON.stringify(rel));
                }
            }

            pendingSessionData = null;
            currentBodyPoints = [];

            if(bodyMapSource === 'timer') {
                switchTab('timer');
            } else if (bodyMapSource === 'process') {
                switchTab('process');
            } else {
                openBodyMapList();
            }
        };

        window.viewChartsForLog = (emotion) => {
            setCurrentEmotion(emotion);
            openCharts('journal');
        }

        window.loadChart = (em) => { const ctx = document.getElementById('progressChart'); if(!ctx) return; document.getElementById('chart-placeholder').classList.add('hidden'); let data = globalLogData.filter(r => r.emotion === em && r.intensity).reverse(); if(data.length===0) { if(progressChart) progressChart.destroy(); document.getElementById('chart-placeholder').classList.remove('hidden'); document.getElementById('chart-placeholder').textContent = `No data yet for "${em}"`; return; } const lbl = data.map(x => x.date), val = data.map(x => parseInt(x.intensity)); if(progressChart) progressChart.destroy(); progressChart = new Chart(ctx, { type: 'line', data: { labels: lbl, datasets: [{ label: 'Intensity', data: val, borderColor: '#d4af37', backgroundColor: 'rgba(212, 175, 55, 0.1)', tension: 0.4, fill: true, pointBackgroundColor: '#d4af37' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 10, grid: { color: '#1e293b' }, ticks: { color: '#94a3b8' } }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#0f172a', borderColor: '#334155', borderWidth: 1 } } } }); };
        window.closeCompleteModal = () => { document.getElementById('complete-modal').classList.add('hidden'); document.getElementById('complete-modal').classList.remove('flex'); resetTimer(); };
    </script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, deleteDoc, doc, updateDoc, onSnapshot, query, orderBy, serverTimestamp, writeBatch, getDocs } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBc1FA6RTM0sTktO3hhMxWxhYp50CsKJ0I",
            authDomain: "letting-go-app.firebaseapp.com",
            projectId: "letting-go-app",
            storageBucket: "letting-go-app.firebasestorage.app",
            messagingSenderId: "43093477154",
            appId: "1:43093477154:web:60cd1b6da597de2830077b",
            measurementId: "G-K5CDP81Y0T"
        };

        let auth, provider, db, isLoggedIn=false, currentUser=null, unsubscribeJournal=null;

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            provider = new GoogleAuthProvider();
            db = getFirestore(app);

            setPersistence(auth, browserLocalPersistence).catch(console.error);
            
            onAuthStateChanged(auth, (user) => {
                const lOut = document.getElementById('logged-out-view'), lIn = document.getElementById('logged-in-view');
                const uName = document.getElementById('user-name'), uEmail = document.getElementById('user-email');

                if (user) {
                    // Note: removed dismissIntro() so users always see the intro
                    isLoggedIn = true; currentUser = user;
                    if(lOut) lOut.classList.add('hidden');
                    if(lIn) lIn.classList.remove('hidden');
                    if(uName) uName.textContent = user.displayName || "User";
                    if(uEmail) uEmail.textContent = user.email;
                    startJournalListener(user.uid);
                    window.currentUser = user; 
                    window.isLoggedIn = true;
                } else {
                    isLoggedIn = false; currentUser = null;
                    if(lOut) lOut.classList.remove('hidden');
                    if(lIn) lIn.classList.add('hidden');
                    if(unsubscribeJournal) unsubscribeJournal();
                    renderJournal(); 
                    window.currentUser = null;
                    window.isLoggedIn = false;
                }
            });
        } catch (e) { console.error("Firebase Init Error:", e); }

        window.saveSessionToFirebase = async (data) => {
            if(!auth || !currentUser) return;
            data.timestamp = serverTimestamp();
            await addDoc(collection(db, 'users', currentUser.uid, 'logs'), data);
        };
        
        window.updateSessionInFirebase = async (id, updates) => {
            if(!auth || !currentUser) return;
            await updateDoc(doc(db, 'users', currentUser.uid, 'logs', id), updates);
        };

        window.login = function() { 
            if (!auth) return alert("Firebase Error"); 
            signInWithPopup(auth, provider)
                .then((result) => { console.log("Logged in"); }).catch((error) => { alert("Sign in failed: " + error.message); });
        }
        window.logout = function() { if (!auth) return; signOut(auth); }

        window.renderJournal = function(logs) {
            if (!isLoggedIn || !logs) { logs = JSON.parse(localStorage.getItem('releases') || '[]'); }
            window.globalLogData = logs; 
            
            const list = document.getElementById('journal-list');
            if (!list) return;
            if (logs.length === 0) { list.innerHTML = `<div class="text-center py-16 animate-fade-in"><div class="text-slate-800 mb-4"><i data-lucide="book-open" class="w-16 h-16 mx-auto"></i></div><p class="text-slate-600 text-sm">No entries found.</p></div>`; }
            else {
                list.innerHTML = logs.map((e, i) => {
                    const idParam = e.id ? `'${e.id}'` : i; 
                    const bodyPointsCount = e.bodyPoints ? e.bodyPoints.length : 0;
                    return `<div class="relative overflow-hidden rounded-xl mb-3 animate-fade-in swipe-container" style="animation-delay: ${i*50}ms">
                        <div class="delete-action bg-red-600 text-white" onclick="deleteEntry(${idParam})"><i data-lucide="trash-2" class="w-5 h-5"></i></div>
                        <div class="glass-panel p-5 flex justify-between items-center swipe-item" ontouchstart="handleTouchStart(event, this)" ontouchmove="handleTouchMove(event, this)" ontouchend="handleTouchEnd(event, this)" onclick="if(!isSwiping) viewChartsForLog('${e.emotion}')">
                            <div class="flex-1 pr-4">
                                <h3 class="text-white font-medium capitalize text-lg truncate" onclick="renameEntry(${idParam}, '${e.emotion}', event)">${e.emotion} <i data-lucide="edit-2" class="inline-block w-3 h-3 text-slate-600 ml-1"></i></h3>
                                <p class="text-xs text-slate-500 mt-1">${e.date} â€¢ ${e.time}</p>
                            </div>
                            <div class="text-right shrink-0">
                                <div class="text-xs font-mono text-gold-500">${e.duration > 60 ? Math.floor(e.duration/60) + 'm' : e.duration + 's'}</div>
                                ${e.intensity ? `<div class="text-[10px] text-slate-500 mt-1">Int: ${e.intensity}</div>` : ''}
                                ${bodyPointsCount > 0 ? `<div class="text-[10px] text-slate-400 mt-0.5 flex items-center justify-end gap-1"><i data-lucide="map-pin" class="w-2 h-2"></i> ${bodyPointsCount}</div>` : ''}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
            if(window.lucide) window.lucide.createIcons();
            const chartEmotion = document.getElementById('chart-emotion-display').textContent;
            if (chartEmotion !== 'Select to view...') window.loadChart(chartEmotion);
        };

        function startJournalListener(uid) {
            const q = query(collection(db, 'users', uid, 'logs'), orderBy('timestamp', 'desc'));
            unsubscribeJournal = onSnapshot(q, (snapshot) => {
                const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.renderJournal(logs);
                if(!document.getElementById('bodymap-list-view').classList.contains('hidden')) {
                    openBodyMapList();
                }
            });
        }

        window.loadJournal = () => { if(!isLoggedIn) window.renderJournal(); };
        
        window.deleteEntry = async (id) => {
            if (!confirm("Delete this entry?")) return;
            if (isLoggedIn && typeof id === 'string') { 
                await deleteDoc(doc(db, 'users', currentUser.uid, 'logs', id)); 
            } else { 
                const rel = JSON.parse(localStorage.getItem('releases') || '[]'); 
                rel.splice(id, 1); 
                localStorage.setItem('releases', JSON.stringify(rel)); 
                window.renderJournal();
                if(!document.getElementById('bodymap-list-view').classList.contains('hidden')) {
                    openBodyMapList();
                }
            }
        };

        window.renameEntry = async (id, currentName, event) => {
            if(event) event.stopPropagation();
            const newName = prompt("Rename entry:", currentName);
            if (!newName || newName.trim() === "") return;
            if (isLoggedIn && typeof id === 'string') { await updateDoc(doc(db, 'users', currentUser.uid, 'logs', id), { emotion: newName.trim() }); }
            else { const rel = JSON.parse(localStorage.getItem('releases') || '[]'); rel[id].emotion = newName.trim(); localStorage.setItem('releases', JSON.stringify(rel)); window.renderJournal(); }
        };

        window.clearJournal = async () => {
            if (!confirm("Clear all journal entries? This cannot be undone.")) return;
            if (isLoggedIn && currentUser) {
                try {
                    const q = query(collection(db, 'users', currentUser.uid, 'logs'));
                    const snapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    snapshot.docs.forEach((doc) => { batch.delete(doc.ref); });
                    await batch.commit();
                    alert("Cloud logs cleared successfully.");
                } catch (e) { console.error("Error clearing logs:", e); alert("Failed to clear logs: " + e.message); }
            } else { localStorage.removeItem('releases'); window.renderJournal(); }
        };
    </script>
</body>
</html>
