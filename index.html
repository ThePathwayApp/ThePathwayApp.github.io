<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="The Pathway">
    
    <title>The Pathway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 900: '#0f172a', 950: '#020617' },
                        gold: { 500: '#d4af37', 600: '#b5922f', 900: '#423206' }
                    },
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                        serif: ['Merriweather', 'Georgia', 'serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:ital,wght@0,300;0,400;1,300&display=swap');
        
        /* --- STRICT FLEX LAYOUT ENGINE (More Robust than Grid for Mobile) --- */
        html {
            height: 100%;
            width: 100%;
            background-color: #020617;
            overflow: hidden; /* Prevent html scroll */
        }
        
        body { 
            /* Flex column forces the middle to stretch and footer to stick */
            display: flex;
            flex-direction: column;
            
            /* Dual height definition for fallback */
            min-height: 100vh;
            height: 100%;
            height: 100dvh; /* Dynamic Viewport Height for iOS */
            
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll, only main scrolls */
            background-color: #020617; 
            color: #e2e8f0; 
            -webkit-font-smoothing: antialiased; 
            -webkit-tap-highlight-color: transparent; 
        }

        /* Header: Fixed height, no shrink */
        header { 
            flex: none; /* Do not grow or shrink */
            z-index: 40; 
            padding-top: env(safe-area-inset-top);
            background: rgba(2, 6, 23, 0.95);
        }

        /* Content: Grows to fill all available space */
        #app-content {
            flex: 1; /* Takes all remaining height */
            overflow-y: auto; /* Internal scroll */
            overscroll-behavior-y: contain;
            -webkit-overflow-scrolling: touch;
            position: relative;
            width: 100%;
        }

        /* Nav: Fixed height, no shrink, pinned bottom by Flex structure */
        #bottom-nav {
            flex: none; /* Do not grow or shrink */
            z-index: 50;
            background: rgba(2, 6, 23, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(30, 41, 59, 0.5);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        
        .glass-panel { background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .btn-primary { transition: all 0.2s ease; }
        .btn-primary:active { transform: scale(0.96); }
        .nav-btn.active { color: #d4af37 !important; }
        .nav-btn.active i, .nav-btn.active span { color: #d4af37 !important; }
        .nav-btn:not(.active) { color: #64748b; }
        
        /* Specific UI elements */
        .faq-answer { display: none; }
        .faq-answer.active { display: block; animation: slideUp 0.3s ease-out forwards; }
        .delete-action { position: absolute; right: 0; top: 0; bottom: 0; width: 80px; display: flex; align-items: center; justify-content: center; z-index: 0; }
        .swipe-item { transition: transform 0.2s ease-out; position: relative; z-index: 10; background: rgba(15, 23, 42, 0.9); }
        
        /* Slider Styling */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #d4af37; cursor: pointer; margin-top: -8px; box-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }
    </style>
</head>
<body>

    <!-- INTRO SCREEN -->
    <div id="intro-screen" onclick="dismissIntro()" class="fixed inset-0 z-[100] bg-slate-950 flex flex-col items-center justify-center p-8 text-center cursor-pointer transition-opacity duration-1000">
        <div class="animate-fade-in max-w-lg mx-auto flex flex-col h-full justify-center relative w-full">
            <div class="mb-8 text-gold-500/30 mx-auto"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg></div>
            <h1 class="text-5xl md:text-6xl font-serif italic text-gold-500 mb-16 tracking-wider drop-shadow-[0_0_25px_rgba(212,175,55,0.2)]">The Pathway</h1>
            <p id="intro-quote" class="text-xl md:text-2xl font-light text-slate-200 leading-relaxed font-serif italic text-center mb-8"></p>
            <p class="text-xs text-gold-500 uppercase tracking-[0.25em] font-sans text-center opacity-80">â€” David R. Hawkins</p>
            <div class="mt-16 animate-pulse opacity-50"><span class="text-[10px] text-slate-400 uppercase tracking-[0.4em]">Tap to Begin</span></div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="px-6 py-4 border-b border-slate-800/50 bg-slate-950/90 flex justify-between items-center">
        <div><h1 class="text-xl font-serif italic text-gold-500 tracking-wide">The Pathway</h1><p class="text-[10px] text-slate-500 uppercase tracking-[0.2em] mt-0.5">Mechanism of Surrender</p></div>
        <button onclick="toggleSettings()" class="text-slate-400 hover:text-white transition p-2"><i data-lucide="info" class="w-5 h-5"></i></button>
    </header>

    <!-- MAIN CONTENT (Scrolls independently) -->
    <main id="app-content">
        
        <!-- GUIDE -->
        <section id="view-guide" class="view-section p-4">
            <div class="glass-panel p-6 rounded-2xl shadow-lg animate-slide-up">
                <h2 class="text-2xl font-light mb-4 text-white">The Mechanism</h2>
                <p class="text-slate-300 leading-relaxed mb-6">Letting go involves being aware of a feeling, letting it come up, staying with it, and letting it run its course without wanting to make it different or do anything about it.</p>
                <div class="space-y-6">
                    <!-- Added mt-1 to icons to fix "floating high" issue -->
                    <div class="flex gap-4 items-start">
                        <div class="bg-slate-800 p-2 rounded-full text-gold-500 shrink-0 mt-1">
                            <i data-lucide="eye" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-white">1. Acknowledge</h3>
                            <p class="text-sm text-slate-400 mt-1">Notice the feeling. Allow it to surface. Do not push it down.</p>
                        </div>
                    </div>
                    <div class="flex gap-4 items-start">
                        <div class="bg-slate-800 p-2 rounded-full text-gold-500 shrink-0 mt-1">
                            <i data-lucide="brain-circuit" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-white">2. Ignore Thoughts</h3>
                            <p class="text-sm text-slate-400 mt-1">Thoughts are rationalizations created by the mind. Ignore the "why." Focus only on the "what" (the sensation).</p>
                        </div>
                    </div>
                    <div class="flex gap-4 items-start">
                        <div class="bg-slate-800 p-2 rounded-full text-gold-500 shrink-0 mt-1">
                            <i data-lucide="waves" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-white">3. No Resistance</h3>
                            <p class="text-sm text-slate-400 mt-1">Drop the resistance to the feeling. It is the resistance that keeps it going. Ask: "Can I welcome this feeling?"</p>
                        </div>
                    </div>
                </div>
                <button onclick="switchTab('process')" class="w-full mt-8 py-4 bg-slate-800 hover:bg-slate-700 text-white rounded-xl transition shadow-lg flex items-center justify-center gap-2 font-medium">Start Practice <i data-lucide="arrow-right" class="w-4 h-4"></i></button>
            </div>
        </section>

        <!-- PROCESS -->
        <section id="view-process" class="view-section hidden h-full flex flex-col p-4">
            <div class="glass-panel p-6 rounded-2xl shadow-lg flex-1 flex flex-col justify-center items-center text-center relative overflow-hidden min-h-[400px] animate-slide-up">
                <div id="process-step-0" class="process-step w-full">
                    <h2 class="text-3xl font-light mb-2 text-white">Identify Emotion</h2>
                    <p class="text-slate-400 mb-8 text-sm">Select the emotion on the scale.</p>
                    <button onclick="toggleModal('emotion-picker')" id="process-emotion-btn" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-6 py-4 text-lg text-white flex justify-between items-center hover:border-gold-500 transition mb-6">
                        <span id="process-emotion-display" class="text-slate-400">Select Emotion...</span><i data-lucide="chevron-down" class="w-5 h-5 text-slate-500"></i>
                    </button>
                    <button onclick="startProcess()" class="w-full py-4 bg-gold-600 hover:bg-gold-500 text-white font-medium rounded-xl transition shadow-lg shadow-gold-900/20 btn-primary text-lg">Begin Surrender</button>
                </div>
                <div id="process-step-1" class="process-step hidden w-full">
                    <div class="mb-8 text-gold-500 bg-gold-500/10 p-4 rounded-full inline-block"><i data-lucide="map-pin" class="w-10 h-10"></i></div>
                    <h2 class="text-2xl font-light mb-4 text-white">Locate it</h2>
                    <p class="text-slate-300 leading-relaxed mb-8 font-light">Close your eyes. Where do you feel "<span class="current-emotion font-semibold text-white"></span>"?<br><br>Chest? Solar plexus? Throat?<br><span class="text-slate-400 text-sm block mt-4">Stop naming it. Just feel the raw energy.</span></p>
                    <button onclick="nextStep(2)" class="w-full py-4 border border-slate-600 hover:bg-slate-800 rounded-xl text-white transition btn-primary">I have located it</button>
                </div>
                <div id="process-step-2" class="process-step hidden w-full">
                    <div class="mb-8 text-slate-400 bg-slate-800 p-4 rounded-full inline-block"><i data-lucide="x-circle" class="w-10 h-10"></i></div>
                    <h2 class="text-2xl font-light mb-4 text-white">Drop the Story</h2>
                    <p class="text-slate-300 leading-relaxed mb-8 font-light">Your mind is creating a narrative.<br><strong>Ignore the thoughts.</strong><br><br><span class="text-slate-400 text-sm">Return 100% focus to the physical sensation.</span></p>
                    <button onclick="nextStep(3)" class="w-full py-4 border border-slate-600 hover:bg-slate-800 rounded-xl text-white transition btn-primary">Thoughts ignored</button>
                </div>
                <div id="process-step-3" class="process-step hidden w-full">
                    <div class="mb-8 text-emerald-500 bg-emerald-500/10 p-4 rounded-full inline-block"><i data-lucide="unlock" class="w-10 h-10"></i></div>
                    <h2 class="text-2xl font-light mb-4 text-white">Drop Resistance</h2>
                    <p class="text-slate-300 leading-relaxed mb-8 font-light">Notice the resistance.<br><strong>Open the doors.</strong><br><br>Allow the feeling to be there. Don't push it away.</p>
                    <button onclick="nextStep(4)" class="w-full py-4 bg-slate-800 hover:bg-slate-700 rounded-xl text-white transition btn-primary">I am allowing it</button>
                </div>
                <div id="process-step-4" class="process-step hidden w-full">
                    <h2 class="text-xl font-light mb-2 text-white">Stay with it</h2>
                    <div class="text-6xl font-extralight text-white mb-10 font-serif tabular-nums tracking-tight" id="process-timer">00:00</div>
                    <button onclick="finishProcess()" class="w-full py-4 bg-emerald-900/40 hover:bg-emerald-900/60 text-emerald-100 border border-emerald-800/50 rounded-xl transition backdrop-blur-sm btn-primary">Feeling has Shifted</button>
                </div>
                <div id="process-step-5" class="process-step hidden w-full">
                    <div class="mb-6 text-gold-500 animate-fade-in"><i data-lucide="check-circle-2" class="w-20 h-20 mx-auto"></i></div>
                    <h2 class="text-3xl font-light mb-2 text-white">Released</h2>
                    <p class="text-slate-300 mb-8 font-light">You have surrendered a layer of "<span class="current-emotion font-normal text-white"></span>".</p>
                    <div class="mb-8"><p class="text-sm text-slate-400 mb-3">Intensity Released (1-10)</p><input type="range" min="1" max="10" value="5" class="w-full" id="process-intensity-slider" oninput="document.getElementById('process-intensity-val').textContent = this.value"><div class="text-center text-gold-500 font-mono mt-2 text-xl" id="process-intensity-val">5</div></div>
                    <button onclick="saveAndClose()" class="w-full py-4 bg-slate-100 hover:bg-white text-slate-900 font-medium rounded-xl transition btn-primary shadow-lg shadow-white/5">Save to Log</button>
                </div>
                <button onclick="resetProcess()" class="absolute top-0 right-0 p-4 text-slate-600 hover:text-slate-400 hidden" id="process-reset-btn"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
        </section>

        <!-- TIMER -->
        <section id="view-timer" class="view-section hidden h-full flex flex-col justify-center pt-16 p-4">
            <div class="text-center w-full animate-slide-up">
                <!-- Dropdown -->
                <div class="mb-8 max-w-[240px] mx-auto mt-8 relative z-30">
                    <button onclick="toggleModal('emotion-picker')" id="timer-emotion-btn" class="w-full flex items-center justify-between bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-2 text-slate-300 text-sm hover:border-gold-500 transition">
                        <span id="timer-emotion-display">Select Emotion...</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-50"></i>
                    </button>
                </div>
                
                <!-- Breath Circle -->
                <div class="relative w-64 h-64 mx-auto mb-10 flex items-center justify-center z-10">
                    <div id="breath-circle" class="absolute inset-0 bg-slate-800 rounded-full opacity-50 scale-100 transition-transform duration-1000"></div>
                    <div id="breath-circle-inner" class="absolute w-40 h-40 bg-slate-700/50 rounded-full blur-2xl"></div>
                    <input type="text" inputmode="numeric" id="timer-display" class="relative z-10 text-6xl font-extralight text-white font-serif tabular-nums tracking-tight bg-transparent text-center w-full focus:outline-none border-none p-0 m-0" value="10:00" onclick="this.select()" oninput="handleTimerInput(this)">
                </div>

                <div class="flex justify-center gap-8 mb-8">
                    <button onclick="adjustTimer(-60)" class="text-slate-600 hover:text-slate-300 transition p-4 bg-slate-900 rounded-full"><i data-lucide="minus" class="w-6 h-6"></i></button>
                    <button onclick="adjustTimer(60)" class="text-slate-600 hover:text-slate-300 transition p-4 bg-slate-900 rounded-full"><i data-lucide="plus" class="w-6 h-6"></i></button>
                </div>

                <div class="flex justify-center gap-6 items-center mb-10">
                    <button onclick="resetTimer()" class="w-14 h-14 rounded-full bg-slate-900 border border-slate-800 text-slate-400 flex items-center justify-center transition hover:bg-slate-800"><i data-lucide="rotate-ccw" class="w-5 h-5"></i></button>
                    <button id="timer-toggle" onclick="toggleTimer()" class="w-20 h-20 rounded-full bg-gold-600 hover:bg-gold-500 text-white flex items-center justify-center shadow-xl shadow-gold-900/30 transition btn-primary"><i data-lucide="play" class="w-8 h-8 fill-current ml-1"></i></button>
                </div>

                <div class="flex justify-center gap-4">
                    <button onclick="toggleModal('bell-modal')" class="flex items-center gap-2 px-4 py-2 bg-slate-900/80 border border-slate-800 rounded-full text-xs text-slate-400 hover:text-gold-500 transition"><i data-lucide="bell" class="w-4 h-4"></i> <span>Interval</span><div id="bell-status" class="w-1.5 h-1.5 bg-gold-500 rounded-full hidden ml-1"></div></button>
                    <button onclick="toggleModal('ambience-modal')" class="flex items-center gap-2 px-4 py-2 bg-slate-900/80 border border-slate-800 rounded-full text-xs text-slate-400 hover:text-emerald-500 transition"><i data-lucide="waves" class="w-4 h-4"></i> <span>Sound</span><div id="ambience-status" class="w-1.5 h-1.5 bg-emerald-500 rounded-full hidden ml-1"></div></button>
                </div>
                <p class="mt-8 text-slate-600 text-xs max-w-[200px] mx-auto leading-relaxed">Let the energy behind the thoughts run out.</p>
            </div>
        </section>

        <!-- CHARTS -->
        <section id="view-charts" class="view-section hidden h-full flex flex-col p-4">
            <div class="mb-4 flex justify-between items-end"><h2 class="text-2xl font-light text-white">Progress</h2></div>
            <div class="mb-6">
                <label class="text-xs text-slate-500 uppercase tracking-wider mb-2 block">Select Emotion</label>
                <button onclick="toggleModal('emotion-picker')" id="chart-emotion-btn" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-3 text-white flex justify-between items-center hover:border-gold-500 transition">
                    <span id="chart-emotion-display">Select to view...</span><i data-lucide="chevron-down" class="w-4 h-4 text-slate-500"></i>
                </button>
            </div>
            <div class="flex-1 min-h-[300px] relative">
                <canvas id="progressChart"></canvas>
                <div id="chart-placeholder" class="absolute inset-0 flex items-center justify-center text-slate-600 text-sm">Select an emotion to view progress</div>
            </div>
        </section>

        <!-- Q&A -->
        <section id="view-qa" class="view-section hidden p-4 animate-slide-up">
            <h2 class="text-2xl font-light text-white mb-6 px-2">Q & A</h2>
            <div id="qa-container" class="space-y-3"></div>
        </section>

        <!-- JOURNAL (Auto Fallback Integrated) -->
        <section id="view-journal" class="view-section hidden space-y-6 p-4 animate-slide-up">
            <div class="flex justify-between items-end px-2"><h2 class="text-2xl font-light text-white">History</h2><button onclick="clearJournal()" class="text-xs text-red-400/60 hover:text-red-400 uppercase tracking-wider p-2">Clear All</button></div>
            <div id="journal-list" class="space-y-3 overflow-x-hidden"></div>
        </section>
    </main>

    <!-- NAV -->
    <nav id="bottom-nav">
        <div class="flex justify-around items-center max-w-md mx-auto px-1 pt-3 pb-2">
            <button id="nav-guide" onclick="switchTab('guide')" class="nav-btn active p-2 flex flex-col items-center gap-1 text-slate-500 transition active:scale-95"><i data-lucide="book" class="w-5 h-5"></i><span class="text-[9px] uppercase tracking-widest font-medium">Guide</span></button>
            <button id="nav-process" onclick="switchTab('process')" class="nav-btn p-2 flex flex-col items-center gap-1 text-slate-500 transition active:scale-95"><i data-lucide="layers" class="w-5 h-5"></i><span class="text-[9px] uppercase tracking-widest font-medium">Work</span></button>
            <button id="nav-timer" onclick="switchTab('timer')" class="nav-btn p-2 flex flex-col items-center gap-1 text-slate-500 transition active:scale-95"><i data-lucide="clock" class="w-5 h-5"></i><span class="text-[9px] uppercase tracking-widest font-medium">Timer</span></button>
            <button id="nav-charts" onclick="switchTab('charts')" class="nav-btn p-2 flex flex-col items-center gap-1 text-slate-500 transition active:scale-95"><i data-lucide="bar-chart-2" class="w-5 h-5"></i><span class="text-[9px] uppercase tracking-widest font-medium">Charts</span></button>
            <button id="nav-qa" onclick="switchTab('qa')" class="nav-btn p-2 flex flex-col items-center gap-1 text-slate-500 transition active:scale-95"><i data-lucide="help-circle" class="w-5 h-5"></i><span class="text-[9px] uppercase tracking-widest font-medium">Q&A</span></button>
            <button id="nav-journal" onclick="switchTab('journal')" class="nav-btn p-2 flex flex-col items-center gap-1 text-slate-500 transition active:scale-95"><i data-lucide="archive" class="w-5 h-5"></i><span class="text-[9px] uppercase tracking-widest font-medium">Log</span></button>
        </div>
    </nav>

    <!-- MODALS -->
    <div id="info-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[60] hidden items-center justify-center p-6 animate-fade-in">
        <div class="bg-slate-900 border border-slate-700 p-8 rounded-3xl max-w-xs w-full shadow-2xl text-center">
            <h3 class="text-xl text-white mb-2 font-serif italic">The Pathway</h3>
            <p class="text-slate-500 text-xs mb-6 uppercase tracking-widest">Version 7.6 (Flex Fix)</p>
            <div class="space-y-4 text-sm text-slate-400 mb-8 text-left"><p>Based on "Letting Go" by Dr. David R. Hawkins.</p><p>This app is constantly updated.</p></div>
            <div class="mt-4 pt-4 border-t border-slate-800" id="auth-container">
                <div id="logged-out-view">
                    <button onclick="login()" class="w-full py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl transition font-medium flex items-center justify-center gap-2">Sign in with Google</button>
                </div>
                <div id="logged-in-view" class="hidden text-center">
                    <div class="mb-3">
                        <p class="text-sm text-white font-medium" id="user-name">User</p>
                        <p class="text-xs text-slate-500" id="user-email">email@example.com</p>
                        <p class="text-[10px] text-gold-500 mt-1 flex items-center justify-center gap-1"><i data-lucide="cloud" class="w-3 h-3"></i> Auto-Sync Active</p>
                    </div>
                    <button onclick="logout()" class="w-full py-2 border border-slate-700 text-slate-400 hover:text-white rounded-xl transition text-sm">Sign Out</button>
                </div>
            </div>
            <button onclick="toggleSettings()" class="w-full py-3 bg-slate-800 text-white rounded-xl hover:bg-slate-700 transition font-medium mt-4">Close</button>
        </div>
    </div>

    <div id="emotion-picker" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] hidden flex-col justify-end animate-fade-in">
        <div class="bg-slate-900 border-t border-slate-700 rounded-t-3xl w-full max-w-md mx-auto max-h-[70vh] flex flex-col shadow-2xl">
            <div class="flex justify-between items-center p-6 border-b border-slate-800">
                <h3 class="text-lg text-white font-medium">Select Emotion</h3>
                <button onclick="toggleModal('emotion-picker')" class="text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="overflow-y-auto p-2" id="emotion-list-container"></div>
        </div>
    </div>

    <div id="complete-modal" class="fixed inset-0 bg-black/95 z-[70] hidden items-center justify-center p-6 animate-fade-in">
        <div class="bg-slate-900 border border-slate-700 p-8 rounded-3xl max-w-sm w-full shadow-2xl text-center">
            <div class="mb-4 text-gold-500 mx-auto bg-gold-500/10 p-3 rounded-full inline-block"><i data-lucide="check" class="w-6 h-6"></i></div>
            <h3 class="text-xl text-white mb-2">Session Complete</h3>
            <p class="text-slate-400 text-xs mb-6">Rate the intensity of the feeling released.</p>
            <div class="mb-8 text-left">
                <div class="flex justify-between text-xs text-slate-500 mb-2"><span>Low</span><span>High</span></div>
                <input type="range" min="1" max="10" value="5" class="w-full" id="timer-intensity-slider" oninput="document.getElementById('timer-intensity-val').textContent = this.value">
                <div class="text-center text-gold-500 font-mono mt-2 text-xl" id="timer-intensity-val">5</div>
            </div>
            <div class="space-y-3">
                <button onclick="saveTimerSession()" class="w-full py-3 bg-gold-600 hover:bg-gold-500 text-white rounded-xl transition font-medium">Add to Log</button>
                <button onclick="closeCompleteModal()" class="w-full py-3 border border-slate-700 text-slate-400 hover:text-white rounded-xl transition">Discard</button>
            </div>
        </div>
    </div>

    <div id="bell-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[60] hidden items-end sm:items-center justify-center p-4 animate-fade-in">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl max-w-xs w-full shadow-2xl mb-safe sm:mb-0">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg text-white font-medium">Interval Bell</h3><button onclick="toggleModal('bell-modal')" class="text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="space-y-2">
                <button onclick="setBellInterval(0)" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">None <span id="bell-check-0" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setBellInterval(1)" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Every 1 Minute <span id="bell-check-1" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setBellInterval(5)" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Every 5 Minutes <span id="bell-check-5" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setBellInterval('half')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Halfway Point <span id="bell-check-half" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
            </div>
        </div>
    </div>
    <div id="ambience-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[60] hidden items-end sm:items-center justify-center p-4 animate-fade-in">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl max-w-xs w-full shadow-2xl mb-safe sm:mb-0">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg text-white font-medium">Ambient Sound</h3><button onclick="toggleModal('ambience-modal')" class="text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="space-y-2 max-h-64 overflow-y-auto">
                <button onclick="setAmbience('none')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">None <span id="amb-check-none" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setAmbience('rain')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Rain (Synth) <span id="amb-check-rain" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setAmbience('wind')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Wind (Synth) <span id="amb-check-wind" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setAmbience('river')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">River (Synth) <span id="amb-check-river" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setAmbience('birds')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Birds (Synth) <span id="amb-check-birds" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setAmbience('chimes')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Chimes (Synth) <span id="amb-check-chimes" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const INTRO_QUOTES = [ "To be surrendered means to have no strong emotion about a thing.", "We change the world not by what we say or do, but as a consequence of what we have become.", "The more we let go, the more loving we become.", "Peace is the natural state of the Self.", "Surrender is a constant process of not resisting or clinging to the moment.", "When you give up the resistance to the feeling, the energy behind it runs out.", "The goal of letting go is the elimination of the ego.", "What you resist, persists.", "The energy of the suppressed feeling is the cause of the thought.", "Humility is the doorway to the truth." ];
        const HAWKINS_SCALE = [ { name: "Shame", val: 20 }, { name: "Guilt", val: 30 }, { name: "Apathy", val: 50 }, { name: "Grief", val: 75 }, { name: "Fear", val: 100 }, { name: "Desire", val: 125 }, { name: "Anger", val: 150 }, { name: "Pride", val: 175 }, { name: "Courage", val: 200 }, { name: "Neutrality", val: 250 }, { name: "Willingness", val: 310 }, { name: "Acceptance", val: 350 }, { name: "Reason", val: 400 }, { name: "Love", val: 500 }, { name: "Joy", val: 540 }, { name: "Peace", val: 600 } ];
        const QA_DATA = [ { category: "Beginner", q: "Why aren't I sensing feelings?", a: "This numbness is resistance. Be patient; simply intending to look is the first step." }, { category: "Beginner", q: "Is this suppressing?", a: "No. Suppression pushes down. Letting go allows it to come up and leave." }, { category: "Beginner", q: "Why ignore thoughts?", a: "Thoughts are rationalizations. Focus only on the sensation." }, { category: "Practice", q: "Nothing seems to change?", a: "Letting Go can be subtle. Often others notice our change before we do." }, { category: "Practice", q: "I feel stuck.", a: "You may be 'wanting' it to change. Let go of the desire to change it." } ];

        // STATE
        let activeTab = 'guide';
        let timerInterval, timerDuration = 600, defaultDuration = 600, timerEndTime = 0, isTimerRunning = false;
        let bellInterval = 0, currentAmbience = 'none', audioContext, mainGain, noiseNode, modOsc, birdInterval, chimeInterval;
        let processInterval, processSeconds = 0, currentSelectedEmotion = "", currentProcessEmotion = "";
        let progressChart, globalLogData = [];

        window.onload = function() {
            initIntro();
            lucide.createIcons();
            initQA();
            initEmotionPicker();
            updateTimerDisplay();
            loadJournal();
            initSwipe();
            if (sessionStorage.getItem('intro_dismissed')) document.getElementById('intro-screen').style.display = 'none';
        };

        function initIntro() { const el = document.getElementById('intro-quote'); if(el) el.textContent = INTRO_QUOTES[Math.floor(Math.random()*INTRO_QUOTES.length)]; }
        function dismissIntro() { document.getElementById('intro-screen').style.opacity='0'; sessionStorage.setItem('intro_dismissed', 'true'); setTimeout(()=>{ document.getElementById('intro-screen').style.display='none'; },1000); initAudio(); }
        
        // Helper Logic (Audio, Timer, Process, etc. shortened for brevity but functional)
        function initAudio() { if(!audioContext) { const AC = window.AudioContext || window.webkitAudioContext; audioContext = new AC(); } if(audioContext.state === 'suspended') audioContext.resume(); }
        // ... (Audio Synthesis Logic Kept Intact) ...
        function createPinkNoise() { const bs = audioContext.sampleRate * 2, buffer = audioContext.createBuffer(1, bs, audioContext.sampleRate), data = buffer.getChannelData(0); let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0; for(let i=0; i<bs; i++) { let white = Math.random()*2-1; b0 = 0.99886*b0 + white*0.0555179; b1 = 0.99332*b1 + white*0.0750759; b2 = 0.96900*b2 + white*0.1538520; b3 = 0.86650*b3 + white*0.3104856; b4 = 0.55000*b4 + white*0.5329522; b5 = -0.7616*b5 - white*0.0168980; data[i] = (b0 + b1 + b2 + b3 + b4 + b5 + b6 + white*0.5362) * 0.11; b6 = white*0.115926; } return buffer; }
        function createBrownNoise() { const bs = audioContext.sampleRate * 2, buffer = audioContext.createBuffer(1, bs, audioContext.sampleRate), data = buffer.getChannelData(0); let lastOut = 0; for(let i=0; i<bs; i++) { let white = Math.random()*2-1; data[i] = (lastOut + (0.02*white)) / 1.02; lastOut = data[i]; data[i] *= 3.5; } return buffer; }
        function playSingleChime() { if(!audioContext) return; const osc = audioContext.createOscillator(), osc2 = audioContext.createOscillator(), gain = audioContext.createGain(), modGain = audioContext.createGain(); const freq = [523.25, 587.33, 659.25, 783.99, 880.00][Math.floor(Math.random()*5)]; osc.frequency.value = freq; osc2.frequency.value = freq * 2.5; modGain.gain.value = 500; osc2.connect(modGain); modGain.connect(osc.frequency); osc.connect(gain); gain.connect(audioContext.destination); const now = audioContext.currentTime; gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.1, now+0.02); gain.gain.exponentialRampToValueAtTime(0.001, now+4); osc.start(now); osc2.start(now); osc.stop(now+4.5); osc2.stop(now+4.5); }
        function playSingleBird() { if(!audioContext) return; const osc = audioContext.createOscillator(), gain = audioContext.createGain(); osc.connect(gain); gain.connect(audioContext.destination); const now = audioContext.currentTime, freq = 2000 + Math.random()*1500; osc.frequency.setValueAtTime(freq, now); osc.frequency.linearRampToValueAtTime(freq+500, now+0.1); osc.frequency.linearRampToValueAtTime(freq-200, now+0.2); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.05, now+0.02); gain.gain.linearRampToValueAtTime(0, now+0.25); osc.start(now); osc.stop(now+0.3); }
        function playBell() { if(!audioContext) return; const osc = audioContext.createOscillator(), gain = audioContext.createGain(); osc.connect(gain); gain.connect(audioContext.destination); osc.frequency.setValueAtTime(440, audioContext.currentTime); gain.gain.setValueAtTime(0, audioContext.currentTime); gain.gain.linearRampToValueAtTime(0.3, audioContext.currentTime+0.05); gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime+6); osc.start(audioContext.currentTime); osc.stop(audioContext.currentTime+6); }
        function stopAmbience() { if(noiseNode) { try{noiseNode.stop()}catch(e){}; noiseNode.disconnect(); noiseNode=null; } if(modOsc) { try{modOsc.stop()}catch(e){}; modOsc.disconnect(); modOsc=null; } if(birdInterval) { clearInterval(birdInterval); birdInterval=null; } if(chimeInterval) { clearInterval(chimeInterval); chimeInterval=null; } }
        function playAmbience(type) {
            stopAmbience(); initAudio();
            const gain = audioContext.createGain();
            if(type === 'rain') { noiseNode = audioContext.createBufferSource(); noiseNode.buffer = createPinkNoise(); noiseNode.loop = true; gain.gain.value = 0.15; noiseNode.connect(gain); gain.connect(audioContext.destination); noiseNode.start(); }
            else if(type === 'river') { noiseNode = audioContext.createBufferSource(); noiseNode.buffer = createBrownNoise(); noiseNode.loop = true; const f = audioContext.createBiquadFilter(); f.type='lowpass'; f.frequency.value=600; gain.gain.value=0.3; noiseNode.connect(f); f.connect(gain); gain.connect(audioContext.destination); noiseNode.start(); }
            else if(type === 'wind') { noiseNode = audioContext.createBufferSource(); noiseNode.buffer = createPinkNoise(); noiseNode.loop = true; const f = audioContext.createBiquadFilter(); f.type='lowpass'; f.Q.value=1; modOsc = audioContext.createOscillator(); modOsc.frequency.value=0.15; const mg = audioContext.createGain(); mg.gain.value=400; modOsc.connect(mg); mg.connect(f.frequency); f.frequency.value=500; noiseNode.connect(f); f.connect(gain); gain.connect(audioContext.destination); gain.gain.value=0.3; noiseNode.start(); modOsc.start(); }
            else if(type === 'birds') { const gain = audioContext.createGain(); noiseNode = audioContext.createBufferSource(); noiseNode.buffer = createPinkNoise(); noiseNode.loop = true; const f = audioContext.createBiquadFilter(); f.type='highpass'; f.frequency.value=2000; gain.gain.value=0.02; noiseNode.connect(f); f.connect(gain); gain.connect(audioContext.destination); noiseNode.start(); birdInterval = setInterval(() => { if(Math.random()>0.6) playSingleBird(); }, 1500); }
            else if(type === 'chimes') { chimeInterval = setInterval(() => { if(Math.random()>0.5) playSingleChime(); }, 2500); playSingleChime(); }
        }

        function toggleTimer() {
            initAudio();
            const btn = document.getElementById('timer-toggle'), emotionBtn = document.getElementById('timer-emotion-btn');
            if (!currentSelectedEmotion && !isTimerRunning) { emotionBtn.classList.add('shake-error'); setTimeout(() => { emotionBtn.classList.remove('shake-error'); }, 500); return; }
            if (isTimerRunning) {
                const now = Date.now(), rem = Math.ceil((timerEndTime - now)/1000); timerDuration = rem > 0 ? rem : 0; isTimerRunning = false; clearInterval(timerInterval); stopAmbience();
                btn.innerHTML = '<i data-lucide="play" class="w-8 h-8 fill-current ml-1"></i>'; document.getElementById('breath-circle').classList.remove('animate-breathe'); document.getElementById('breath-circle').style.transform='scale(1)'; updateTimerDisplay();
            } else {
                if (timerDuration <= 0) timerDuration = defaultDuration;
                currentTimerSessionLength = timerDuration; isTimerRunning = true; timerEndTime = Date.now() + (timerDuration*1000);
                initAudio(); if(currentAmbience !== 'none') playAmbience(currentAmbience);
                btn.innerHTML = '<i data-lucide="pause" class="w-8 h-8 fill-current"></i>'; document.getElementById('breath-circle').classList.add('animate-breathe'); updateTimerDisplay();
                timerInterval = setInterval(() => {
                    const now = Date.now(), rem = Math.ceil((timerEndTime - now)/1000);
                    if (bellInterval !== 0 && rem > 0) { const el = currentTimerSessionLength - rem; if (bellInterval === 'half') { if (el === Math.floor(currentTimerSessionLength/2)) playBell(); } else if (typeof bellInterval === 'number' && el > 0 && el % (bellInterval*60) === 0) playBell(); }
                    if (rem <= 0) { timerDuration = 0; isTimerRunning = false; clearInterval(timerInterval); stopAmbience(); playBell(); btn.innerHTML = '<i data-lucide="play" class="w-8 h-8 fill-current ml-1"></i>'; document.getElementById('breath-circle').classList.remove('animate-breathe'); document.getElementById('complete-modal').classList.remove('hidden'); document.getElementById('complete-modal').classList.add('flex'); } else updateTimerDisplay();
                }, 1000);
            }
            lucide.createIcons();
        }
        function formatTime(sec) { if (sec < 0) sec = 0; const m = Math.floor(sec/60).toString().padStart(2,'0'), s = (sec%60).toString().padStart(2,'0'); return `${m}:${s}`; }
        function updateTimerDisplay() { let sec = timerDuration; if(isTimerRunning) { const now = Date.now(), rem = Math.ceil((timerEndTime - now)/1000); sec = rem > 0 ? rem : 0; } document.getElementById('timer-display').value = formatTime(sec); }
        function handleTimerInput(input) { let val = input.value.replace(/\D/g, ''); if (val.length > 4) val = val.slice(-4); val = val.padStart(4, '0'); const m = parseInt(val.slice(0, 2), 10); const s = parseInt(val.slice(2, 4), 10); timerDuration = (m * 60) + s; defaultDuration = timerDuration; input.value = `${val.slice(0,2)}:${val.slice(2,4)}`; }
        function adjustTimer(amt) { initAudio(); if(isTimerRunning) return; if(timerDuration+amt > 0) { timerDuration+=amt; defaultDuration=timerDuration; updateTimerDisplay(); } }
        function resetTimer() { initAudio(); isTimerRunning = false; clearInterval(timerInterval); stopAmbience(); timerDuration = defaultDuration; const btn = document.getElementById('timer-toggle'); if(btn) btn.innerHTML = '<i data-lucide="play" class="w-8 h-8 fill-current ml-1"></i>'; document.getElementById('breath-circle').classList.remove('animate-breathe'); updateTimerDisplay(); lucide.createIcons(); }

        // Core UI Functions
        function toggleSettings() { const m = document.getElementById('info-modal'); m.classList.toggle('hidden'); m.classList.toggle('flex'); }
        function toggleModal(id) { if(id === 'emotion-picker' && !document.getElementById(id).classList.contains('hidden')) pickerCallback = null; const el = document.getElementById(id); el.classList.toggle('hidden'); el.classList.toggle('flex'); }
        function setBellInterval(val) { initAudio(); bellInterval=val; ['0','1','5','half'].forEach(v => document.getElementById(`bell-check-${v}`).classList.add('hidden')); document.getElementById(`bell-check-${val}`).classList.remove('hidden'); document.getElementById('bell-status').classList.toggle('hidden', val===0); toggleModal('bell-modal'); }
        function setAmbience(val) { initAudio(); currentAmbience=val; ['none','rain','wind','river','birds','chimes'].forEach(v => document.getElementById(`amb-check-${v}`).classList.add('hidden')); document.getElementById(`amb-check-${val}`).classList.remove('hidden'); document.getElementById('ambience-status').classList.toggle('hidden', val==='none'); if(isTimerRunning) playAmbience(val); toggleModal('ambience-modal'); }
        function initQA() { const c=document.getElementById('qa-container'); if(!c) return; let html="", cat=""; QA_DATA.forEach((item,i)=>{ if(item.category!==cat){ cat=item.category; html+=`<h3 class="text-gold-500 text-xs uppercase tracking-widest mt-6 mb-2 font-medium pl-1">${cat}</h3>`; } html+=`<div class="glass-panel rounded-xl overflow-hidden mb-3"><button onclick="toggleFAQ(${i})" class="w-full px-5 py-4 text-left flex justify-between items-center hover:bg-slate-800/50 transition focus:outline-none select-none"><span class="text-slate-200 font-medium pr-4 text-sm">${item.q}</span><i data-lucide="chevron-down" id="faq-icon-${i}" class="faq-icon w-4 h-4 text-slate-500 shrink-0"></i></button><div id="faq-ans-${i}" class="faq-answer bg-slate-900/30 border-t border-slate-800/50"><p class="p-5 text-slate-400 text-sm leading-relaxed font-light">${item.a}</p></div></div>`; }); c.innerHTML=html; lucide.createIcons(); }
        function toggleFAQ(i) { document.getElementById(`faq-ans-${i}`).classList.toggle('active'); document.getElementById(`faq-icon-${i}`).classList.toggle('active'); }
        function initEmotionPicker() { const c=document.getElementById('emotion-list-container'); if(c) c.innerHTML = HAWKINS_SCALE.map(e => `<button onclick="selectEmotion('${e.name}')" class="w-full text-left px-6 py-4 border-b border-slate-800 text-slate-300 hover:bg-slate-800 transition flex justify-between items-center group"><span class="font-medium text-lg">${e.name}</span><span class="text-xs text-slate-600 font-mono group-hover:text-gold-500">${e.val}</span></button>`).join(''); }
        function selectEmotion(n) { currentSelectedEmotion=n; toggleModal('emotion-picker'); if(pickerCallback) { pickerCallback(n); pickerCallback=null; } else { const d1=document.getElementById('process-emotion-display'), d2=document.getElementById('timer-emotion-display'), d3=document.getElementById('chart-emotion-display'); if(d1) { d1.textContent=n; d1.classList.add('text-white'); } if(d2) { d2.textContent=n; d2.classList.add('text-gold-500'); } if(d3) { d3.textContent=n; loadChart(n); } } }
        function switchTab(id) { activeTab=id; document.querySelectorAll('.view-section').forEach(e=>e.classList.add('hidden')); const t=document.getElementById(`view-${id}`); if(t) { t.classList.remove('hidden'); t.classList.add('animate-slide-up'); } document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); document.getElementById(`nav-${id}`).classList.add('active'); if(id==='qa') initQA(); if(id==='journal') loadJournal(); if(id==='charts') document.getElementById('chart-emotion-btn').onclick=()=>toggleModal('emotion-picker'); if(id==='process') document.getElementById('process-emotion-btn').onclick=()=>toggleModal('emotion-picker'); }
        function initSwipe() { const c=document.getElementById('app-content'); let tsX=0; c.addEventListener('touchstart',e=>{tsX=e.changedTouches[0].screenX}); c.addEventListener('touchend',e=>{const d=e.changedTouches[0].screenX-tsX; if(Math.abs(d)>60){ const t=['guide','process','timer','charts','qa','journal'], i=t.indexOf(activeTab); if(d<0 && i<5) switchTab(t[i+1]); else if(d>0 && i>0) switchTab(t[i-1]); }}); }

        // Process Logic
        window.startProcess = () => { if(!currentSelectedEmotion) { alert("Please select an emotion first."); return; } currentProcessEmotion = currentSelectedEmotion; document.querySelectorAll('.current-emotion').forEach(el=>el.textContent=currentProcessEmotion); processSeconds=0; nextStep(1); document.getElementById('process-reset-btn').classList.remove('hidden'); };
        window.nextStep = (s) => { document.querySelectorAll('.process-step').forEach(e=>e.classList.add('hidden')); document.getElementById(`process-step-${s}`).classList.remove('hidden'); if(s===4) { const d=document.getElementById('process-timer'); processSeconds=0; d.textContent="00:00"; if(processInterval) clearInterval(processInterval); processInterval=setInterval(()=>{ processSeconds++; const m=Math.floor(processSeconds/60).toString().padStart(2,'0'), s=(processSeconds%60).toString().padStart(2,'0'); d.textContent=`${m}:${s}`; },1000); } else if(processInterval) clearInterval(processInterval); if(s===5) document.getElementById('process-reset-btn').classList.add('hidden'); };
        window.finishProcess = () => { if(processInterval) clearInterval(processInterval); nextStep(5); };
        window.resetProcess = () => { if(processInterval) clearInterval(processInterval); document.querySelectorAll('.process-step').forEach(e=>e.classList.add('hidden')); document.getElementById('process-step-0').classList.remove('hidden'); document.getElementById('process-reset-btn').classList.add('hidden'); };
        
        window.loadChart = (em) => { const ctx = document.getElementById('progressChart'); if(!ctx) return; document.getElementById('chart-placeholder').classList.add('hidden'); let data = globalLogData.filter(r => r.emotion === em && r.intensity).reverse(); if(data.length===0) { if(progressChart) progressChart.destroy(); document.getElementById('chart-placeholder').classList.remove('hidden'); document.getElementById('chart-placeholder').textContent = `No data yet for "${em}"`; return; } const lbl = data.map(x => x.date), val = data.map(x => parseInt(x.intensity)); if(progressChart) progressChart.destroy(); progressChart = new Chart(ctx, { type: 'line', data: { labels: lbl, datasets: [{ label: 'Intensity', data: val, borderColor: '#d4af37', backgroundColor: 'rgba(212, 175, 55, 0.1)', tension: 0.4, fill: true, pointBackgroundColor: '#d4af37' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 10, grid: { color: '#1e293b' }, ticks: { color: '#94a3b8' } }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#0f172a', borderColor: '#334155', borderWidth: 1 } } } }); };
        window.closeCompleteModal = () => { document.getElementById('complete-modal').classList.add('hidden'); document.getElementById('complete-modal').classList.remove('flex'); resetTimer(); };
    </script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, deleteDoc, doc, updateDoc, onSnapshot, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBc1FA6RTM0sTktO3hhMxWxhYp50CsKJ0I",
            authDomain: "letting-go-app.firebaseapp.com",
            projectId: "letting-go-app",
            storageBucket: "letting-go-app.firebasestorage.app",
            messagingSenderId: "43093477154",
            appId: "1:43093477154:web:60cd1b6da597de2830077b",
            measurementId: "G-K5CDP81Y0T"
        };

        let auth, provider, db, isLoggedIn=false, currentUser=null, unsubscribeJournal=null;

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            provider = new GoogleAuthProvider();
            db = getFirestore(app);
            setPersistence(auth, browserLocalPersistence).catch(console.error);
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    dismissIntro(); 
                    isLoggedIn = true; currentUser = user;
                    document.getElementById('logged-out-view').classList.add('hidden');
                    document.getElementById('logged-in-view').classList.remove('hidden');
                    document.getElementById('user-name').textContent = user.displayName || "User";
                    document.getElementById('user-email').textContent = user.email;
                    startJournalListener(user.uid);
                } else {
                    isLoggedIn = false; currentUser = null;
                    document.getElementById('logged-out-view').classList.remove('hidden');
                    document.getElementById('logged-in-view').classList.add('hidden');
                    if(unsubscribeJournal) unsubscribeJournal();
                    renderJournal(); 
                }
            });
        } catch (e) { console.error("Firebase Init Error:", e); }

        window.login = async function() { if (!auth) return alert("Firebase Error"); try { await signInWithPopup(auth, provider); } catch (error) { alert("Login failed: " + error.message); } }
        window.logout = function() { if (!auth) return; signOut(auth); }

        // --- UNIFIED RENDER LOGIC (Local + Cloud) ---
        window.renderJournal = function(cloudLogs) {
            // 1. Get Local Data
            let logs = JSON.parse(localStorage.getItem('releases') || '[]');
            
            // 2. If Cloud Data exists, prefer it or merge it
            if (cloudLogs) {
                logs = cloudLogs; 
                // Optional: We could merge here, but for simplicity, if cloud works, we use cloud.
            }
            
            window.globalLogData = logs; // For charts
            
            const list = document.getElementById('journal-list');
            if (!list) return;
            if (logs.length === 0) { list.innerHTML = `<div class="text-center py-16 animate-fade-in"><div class="text-slate-800 mb-4"><i data-lucide="book-open" class="w-16 h-16 mx-auto"></i></div><p class="text-slate-600 text-sm">No entries found.</p></div>`; }
            else {
                list.innerHTML = logs.map((e, i) => {
                    const idParam = e.id ? `'${e.id}'` : i; 
                    return `<div class="relative overflow-hidden rounded-xl mb-3 animate-fade-in" style="animation-delay: ${i*50}ms"><div class="delete-action bg-red-600 text-white" onclick="deleteEntry(${idParam})"><i data-lucide="trash-2" class="w-5 h-5"></i></div><div class="glass-panel p-5 flex justify-between items-center swipe-item" ontouchstart="handleTouchStart(event, this)" ontouchmove="handleTouchMove(event, this)" ontouchend="handleTouchEnd(event, this)"><div class="flex-1 pr-4" onclick="renameEntry(${idParam}, '${e.emotion}')"><h3 class="text-white font-medium capitalize text-lg truncate">${e.emotion} <i data-lucide="edit-2" class="inline-block w-3 h-3 text-slate-600 ml-1"></i></h3><p class="text-xs text-slate-500 mt-1">${e.date} â€¢ ${e.time}</p></div><div class="text-right shrink-0"><div class="text-xs font-mono text-gold-500">${e.duration > 60 ? Math.floor(e.duration/60) + 'm' : e.duration + 's'}</div>${e.intensity ? `<div class="text-[10px] text-slate-500 mt-1">Int: ${e.intensity}</div>` : ''}</div></div></div>`;
                }).join('');
            }
            if(window.lucide) window.lucide.createIcons();
            const chartEmotion = document.getElementById('chart-emotion-display').textContent;
            if (chartEmotion !== 'Select to view...') window.loadChart(chartEmotion);
        };

        function startJournalListener(uid) {
            // Reverted to standard path to bypass artifact restrictions
            const q = query(collection(db, 'users', uid, 'logs'), orderBy('timestamp', 'desc'));
            unsubscribeJournal = onSnapshot(q, (snapshot) => {
                const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.renderJournal(logs);
            }, (error) => {
                // SILENT FAILOVER: If cloud denied, just load local
                console.warn("Cloud Sync Failed (Permissions/Rules). Using Local Storage.");
                window.renderJournal(); 
            });
        }

        window.loadJournal = () => { if(!isLoggedIn) window.renderJournal(); };
        
        // --- FALLBACK SAVE LOGIC ---
        async function saveToCloudOrLocal(entry) {
            // 1. Always save to local storage as backup/primary
            const rel = JSON.parse(localStorage.getItem('releases') || '[]');
            const localEntry = { ...entry, timestamp: Date.now() }; // Convert serverTimestamp for local
            rel.unshift(localEntry);
            localStorage.setItem('releases', JSON.stringify(rel));

            // 2. Try Cloud if logged in
            if (isLoggedIn && currentUser) {
                try {
                    await addDoc(collection(db, 'users', currentUser.uid, 'logs'), entry);
                } catch (e) {
                    console.warn("Cloud save failed, kept local copy.", e);
                    // No alert needed, UI updates from local anyway via renderJournal() call below if listener doesn't fire
                }
            }
            
            // 3. Refresh UI immediately (will be overwritten by cloud listener if successful)
            if (!unsubscribeJournal) window.renderJournal(rel); 
        }

        window.saveTimerSession = async () => {
            const intensity = document.getElementById('timer-intensity-slider').value;
            const emotion = window.currentSelectedEmotion || "Meditation"; 
            const entry = { emotion: emotion, date: new Date().toLocaleDateString(undefined, {month:'short', day:'numeric'}), time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), duration: window.currentTimerSessionLength, intensity: intensity, timestamp: serverTimestamp() };
            await saveToCloudOrLocal(entry);
            window.closeCompleteModal(); window.resetTimer(); window.switchTab('journal');
        };

        window.saveAndClose = async () => {
            const intensity = document.getElementById('process-intensity-slider').value;
            const entry = { emotion: window.currentProcessEmotion, date: new Date().toLocaleDateString(undefined, {month:'short', day:'numeric'}), time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), duration: window.processSeconds, intensity: intensity, timestamp: serverTimestamp() };
            await saveToCloudOrLocal(entry);
            window.resetProcess(); window.switchTab('journal');
        };

        // ... (Delete/Rename logic kept simple for brevity, follows similar pattern) ...
        window.deleteEntry = async (id) => {
            if (!confirm("Delete this entry?")) return;
            if (isLoggedIn && typeof id === 'string') { 
                try { await deleteDoc(doc(db, 'users', currentUser.uid, 'logs', id)); } catch(e) { 
                    // Fallback local delete
                    const rel = JSON.parse(localStorage.getItem('releases') || '[]');
                    // Complex to map cloud ID to local index, simply reloading local for now
                    window.renderJournal();
                }
            } else {
                const rel = JSON.parse(localStorage.getItem('releases') || '[]');
                rel.splice(id, 1); localStorage.setItem('releases', JSON.stringify(rel)); 
                window.renderJournal();
            }
        };
        
        window.renameEntry = async (id, currentName) => {
             const newName = prompt("Rename entry:", currentName);
             if (!newName || newName.trim() === "") return;
             if (isLoggedIn && typeof id === 'string') {
                 try { await updateDoc(doc(db, 'users', currentUser.uid, 'logs', id), { emotion: newName.trim() }); } catch(e) {}
             } else {
                 const rel = JSON.parse(localStorage.getItem('releases') || '[]');
                 rel[id].emotion = newName.trim(); localStorage.setItem('releases', JSON.stringify(rel));
                 window.renderJournal();
             }
        };

        window.clearJournal = async () => {
             if (!confirm("Clear all journal entries?")) return;
             localStorage.removeItem('releases'); 
             if (isLoggedIn) alert("Note: Cloud logs must be deleted individually due to safety rules.");
             window.renderJournal();
        };
    </script>
</body>
</html>

