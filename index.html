<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="The Pathway">
    
    <!-- Custom Home Screen Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1024 1024' style='background-color: %232a1b1b;'%3E%3Cpath d='M512 928C282.2 928 96 741.8 96 512S282.2 96 512 96s416 186.2 416 416-186.2 416-416 416zm0-768c-194.4 0-352 157.6-352 352s157.6 352 352 352 352-157.6 352-352-157.6-352-352-352zm0 640c-159.1 0-288-128.9-288-288s128.9-288 288-288 288 128.9 288 288-128.9 288-288 288z' fill='none'/%3E%3Cpath d='M538.6 225.2c-8.4-1.8-17.1 3.6-18.9 12-14.6 68.4-14.6 139.2 0 207.6 1.8 8.4 10.3 13.7 18.7 11.9 8.4-1.8 13.7-10.3 11.9-18.7-12.5-58.6-12.5-119.4 0-178 1.8-8.4-3.6-17.1-11.7-14.8zM380.5 407c-6.6-5.4-16.3-4.4-21.7 2.2-44.2 53.8-44.2 131.8 0 185.6 5.4 6.6 15.1 7.6 21.7 2.2 6.6-5.4 7.6-15.1 2.2-21.7-36.3-44.2-36.3-108.4 0-152.6 5.4-6.6 4.4-16.3-2.2-15.7zM643.5 407c6.6-5.4 16.3-4.4 21.7 2.2 44.2 53.8 44.2 131.8 0 185.6-5.4 6.6-15.1 7.6-21.7 2.2-6.6-5.4-7.6-15.1-2.2-21.7 36.3-44.2 36.3-108.4 0-152.6-5.4-6.6-4.4-16.3 2.2-15.7z' fill='%23d4af37'/%3E%3Cpath d='M512 1024C229.2 1024 0 794.8 0 512S229.2 0 512 0s512 229.2 512 512-229.2 512-512 512zm0-928C282.2 96 96 282.2 96 512s186.2 416 416 416 416-186.2 416-416S741.8 96 512 96z' fill='%23d4af37' opacity='0.1'/%3E%3Cpath d='M512 512m-400 0a400 400 0 1 0 800 0 400 400 0 1 0-800 0Z' fill='none' stroke='%23d4af37' stroke-width='40' stroke-linecap='round' opacity='0.9' stroke-dasharray='1400' stroke-dashoffset='0' transform='rotate(-90 512 512)'/%3E%3Cpath d='M512 512m-250 0a250 250 0 1 0 500 0 250 250 0 1 0-500 0Z' fill='none' stroke='%23d4af37' stroke-width='35' stroke-linecap='round' opacity='0.8' stroke-dasharray='900' stroke-dashoffset='200' transform='rotate(180 512 512)'/%3E%3Cpath d='M512 512m-120 0a120 120 0 1 0 240 0 120 120 0 1 0-240 0Z' fill='none' stroke='%23d4af37' stroke-width='30' stroke-linecap='round' opacity='0.7' stroke-dasharray='400' stroke-dashoffset='100' transform='rotate(90 512 512)'/%3E%3C/svg%3E">

    <title>The Pathway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 900: '#0f172a', 950: '#020617' },
                        gold: { 500: '#d4af37', 600: '#b5922f', 900: '#423206' }
                    },
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                        serif: ['Merriweather', 'Georgia', 'serif'],
                    },
                    animation: {
                        'breathe': 'breathe 8s infinite ease-in-out',
                        'fade-in': 'fadeIn 0.8s ease-out forwards',
                        'fade-out': 'fadeOut 0.8s ease-in forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                    },
                    keyframes: {
                        breathe: {
                            '0%, 100%': { transform: 'scale(1)', opacity: '0.5' },
                            '50%': { transform: 'scale(1.3)', opacity: '0.8' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeOut: {
                            '0%': { opacity: '1' },
                            '100%': { opacity: '0', visibility: 'hidden' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(100%)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        }
                    },
                    padding: { 'safe': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:ital,wght@0,300;0,400;1,300&display=swap');
        
        /* FIXED BOUNCE & IPHONE HEIGHT ISSUE */
        html, body { 
            /* Use 100dvh (dynamic viewport height) to account for mobile address bars */
            height: 100vh;
            height: 100dvh; 
            width: 100%;
            overflow: hidden; 
            position: fixed; 
            overscroll-behavior: none;
            background-color: #020617; 
            color: #e2e8f0; 
            -webkit-font-smoothing: antialiased; 
            -webkit-tap-highlight-color: transparent; 
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        
        #app-content {
            overscroll-behavior-y: contain;
            -webkit-overflow-scrolling: touch;
        }

        .glass-panel { background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .intro-overlay { background: #020617; }
        .btn-primary { transition: all 0.2s ease; }
        .btn-primary:active { transform: scale(0.96); }
        /* Robust Safe Area Support */
        .pb-safe { padding-bottom: 20px; padding-bottom: env(safe-area-inset-bottom, 20px); }
        .pt-safe { padding-top: 20px; padding-top: env(safe-area-inset-top, 20px); }
        
        .faq-answer { display: none; }
        .faq-answer.active { display: block; animation: slideUp 0.3s ease-out forwards; }
        .faq-icon { transition: transform 0.3s ease; }
        .faq-icon.active { transform: rotate(180deg); }
        .quote-wrapper { position: relative; display: inline-block; padding: 2rem 3rem; }
        .quote-mark { position: absolute; width: 2.5rem; height: 2.5rem; color: rgba(212, 175, 55, 0.4); }
        .quote-mark.start { top: 0; left: 0; }
        .quote-mark.end { bottom: 0; right: 0; transform: rotate(180deg); }
        .swipe-item { transition: transform 0.2s ease-out; position: relative; z-index: 10; background: rgba(15, 23, 42, 0.9); }
        .delete-action { position: absolute; right: 0; top: 0; bottom: 0; width: 80px; display: flex; align-items: center; justify-content: center; z-index: 0; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #d4af37; cursor: pointer; margin-top: -8px; box-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }
        .nav-btn.active { color: #d4af37 !important; }
        .nav-btn.active i, .nav-btn.active span { color: #d4af37 !important; }
        .nav-btn:not(.active) { color: #64748b; }
        .shake-error { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; border-color: #ef4444 !important; color: #ef4444 !important; }
    </style>
</head>
<body class="flex flex-col selection:bg-gold-500 selection:text-white pt-safe relative">

    <!-- INTRO -->
    <div id="intro-screen" onclick="dismissIntro()" class="fixed inset-0 z-[100] bg-slate-950 flex flex-col items-center justify-center p-8 text-center cursor-pointer transition-opacity duration-1000">
        <div class="animate-fade-in max-w-lg mx-auto flex flex-col h-full justify-center relative w-full">
            <div class="mb-8 text-gold-500/30 mx-auto"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg></div>
            <h1 class="text-5xl md:text-6xl font-serif italic text-gold-500 mb-16 tracking-wider drop-shadow-[0_0_25px_rgba(212,175,55,0.2)]">The Pathway</h1>
            <div class="flex justify-center">
                <div class="quote-wrapper max-w-md">
                    <svg class="quote-mark start" viewBox="0 0 24 24" fill="currentColor"><path d="M14.017 21L14.017 18C14.017 16.896 14.321 15.923 14.929 15.081C15.537 14.239 16.357 13.459 17.389 12.741L16.731 10.561C15.039 11.623 14.069 12.878 13.821 14.326C13.821 14.326 13.821 14.326 13.821 14.326C13.545 13.714 13.407 13.052 13.407 12.34C13.407 10.284 14.147 8.528 15.627 7.072C17.107 5.616 18.867 4.888 20.907 4.888C21.787 4.888 22.467 5.568 22.947 6.928C23.427 8.288 23.667 9.528 23.667 10.648C23.667 14.304 22.397 17.754 19.857 21L14.017 21ZM6.007 21L6.007 18C6.007 16.896 6.311 15.923 6.919 15.081C7.527 14.239 8.347 13.459 9.379 12.741L8.721 10.561C7.029 11.623 6.059 12.878 5.811 14.326C5.811 14.326 5.811 14.326 5.811 14.326C5.535 13.714 5.397 13.052 5.397 12.34C5.397 10.284 6.137 8.528 7.617 7.072C9.097 5.616 10.857 4.888 12.897 4.888C13.777 4.888 14.457 5.568 14.937 6.928C15.417 8.288 15.657 9.528 15.657 10.648C15.657 14.304 14.387 17.754 11.847 21L6.007 21Z" /></svg>
                    <p id="intro-quote" class="text-xl md:text-2xl font-light text-slate-200 leading-relaxed font-serif italic text-center"></p>
                    <svg class="quote-mark end" viewBox="0 0 24 24" fill="currentColor"><path d="M14.017 21L14.017 18C14.017 16.896 14.321 15.923 14.929 15.081C15.537 14.239 16.357 13.459 17.389 12.741L16.731 10.561C15.039 11.623 14.069 12.878 13.821 14.326C13.821 14.326 13.821 14.326 13.821 14.326C13.545 13.714 13.407 13.052 13.407 12.34C13.407 10.284 14.147 8.528 15.627 7.072C17.107 5.616 18.867 4.888 20.907 4.888C21.787 4.888 22.467 5.568 22.947 6.928C23.427 8.288 23.667 9.528 23.667 10.648C23.667 14.304 22.397 17.754 19.857 21L14.017 21ZM6.007 21L6.007 18C6.007 16.896 6.311 15.923 6.919 15.081C7.527 14.239 8.347 13.459 9.379 12.741L8.721 10.561C7.029 11.623 6.059 12.878 5.811 14.326C5.811 14.326 5.811 14.326 5.811 14.326C5.535 13.714 5.397 13.052 5.397 12.34C5.397 10.284 6.137 8.528 7.617 7.072C9.097 5.616 10.857 4.888 12.897 4.888C13.777 4.888 14.457 5.568 14.937 6.928C15.417 8.288 15.657 9.528 15.657 10.648C15.657 14.304 14.387 17.754 11.847 21L6.007 21Z" /></svg>
                </div>
            </div>
            <p class="text-xs text-gold-500 uppercase tracking-[0.25em] font-sans text-center opacity-80 mt-8">— David R. Hawkins</p>
            <div class="mt-16 animate-pulse opacity-50"><span class="text-[10px] text-slate-400 uppercase tracking-[0.4em]">Tap to Begin</span></div>
        </div>
    </div>

    <!-- Header -->
    <header class="flex-none px-6 py-4 border-b border-slate-800/50 bg-slate-950/90 backdrop-blur relative z-50 flex justify-between items-center">
        <div><h1 class="text-xl font-serif italic text-gold-500 tracking-wide">The Pathway</h1><p class="text-[10px] text-slate-500 uppercase tracking-[0.2em] mt-0.5">Mechanism of Surrender</p></div>
        <button onclick="toggleSettings()" class="text-slate-400 hover:text-white transition p-2"><i data-lucide="info" class="w-5 h-5"></i></button>
    </header>

    <!-- Main Content -->
    <main id="app-content" class="flex-1 overflow-y-auto relative p-4 pb-24 max-w-md mx-auto w-full no-scrollbar" style="touch-action: pan-y;">
        
        <!-- GUIDE -->
        <section id="view-guide" class="view-section animate-fade-in space-y-6 pb-20">
            <div class="glass-panel p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-light mb-4 text-white">The Mechanism</h2>
                <p class="text-slate-300 leading-relaxed mb-4">Letting go involves being aware of a feeling, letting it come up, staying with it, and letting it run its course without wanting to make it different or do anything about it.</p>
                <div class="bg-slate-800/50 p-4 rounded-lg border-l-2 border-gold-500 my-6"><p class="italic text-slate-400 text-sm">"It means to simply let the feeling be there and to focus on letting out the energy behind it."</p><p class="text-right text-xs text-slate-500 mt-2">— David R. Hawkins</p></div>
                <div class="space-y-4">
                    <div class="flex gap-4 items-start"><div class="bg-slate-800 p-2 rounded-full text-gold-500 shrink-0"><i data-lucide="eye" class="w-5 h-5"></i></div><div><h3 class="font-medium text-white">1. Acknowledge</h3><p class="text-sm text-slate-400 mt-1">Notice the feeling. Allow it to surface. Do not push it down.</p></div></div>
                    <div class="flex gap-4 items-start"><div class="bg-slate-800 p-2 rounded-full text-gold-500 shrink-0"><i data-lucide="brain-circuit" class="w-5 h-5"></i></div><div><h3 class="font-medium text-white">2. Ignore Thoughts</h3><p class="text-sm text-slate-400 mt-1">Thoughts are rationalizations created by the mind. Ignore the "why." Focus only on the "what" (the sensation).</p></div></div>
                    <div class="flex gap-4 items-start"><div class="bg-slate-800 p-2 rounded-full text-gold-500 shrink-0"><i data-lucide="waves" class="w-5 h-5"></i></div><div><h3 class="font-medium text-white">3. No Resistance</h3><p class="text-sm text-slate-400 mt-1">Drop the resistance to the feeling. It is the resistance that keeps it going. Ask: "Can I welcome this feeling?"</p></div></div>
                </div>
                <button onclick="switchTab('process')" class="w-full mt-8 py-4 bg-gradient-to-r from-slate-800 to-slate-700 hover:from-slate-700 hover:to-slate-600 text-white rounded-xl transition shadow-lg flex items-center justify-center gap-2 font-medium">Start Practice <i data-lucide="arrow-right" class="w-4 h-4"></i></button>
            </div>
        </section>

        <!-- PROCESS -->
        <section id="view-process" class="view-section hidden animate-fade-in h-full flex flex-col">
            <div class="glass-panel p-6 rounded-2xl shadow-lg flex-1 flex flex-col justify-center items-center text-center relative overflow-hidden min-h-[400px]">
                <div id="process-step-0" class="process-step w-full">
                    <h2 class="text-3xl font-light mb-2 text-white">Identify Emotion</h2>
                    <p class="text-slate-400 mb-8 text-sm">Select the emotion on the scale.</p>
                    <button onclick="toggleModal('emotion-picker')" id="process-emotion-btn" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-6 py-4 text-lg text-white flex justify-between items-center hover:border-gold-500 transition mb-6">
                        <span id="process-emotion-display" class="text-slate-400">Select Emotion...</span><i data-lucide="chevron-down" class="w-5 h-5 text-slate-500"></i>
                    </button>
                    <button onclick="startProcess()" class="w-full py-4 bg-gold-600 hover:bg-gold-500 text-white font-medium rounded-xl transition shadow-lg shadow-gold-900/20 btn-primary text-lg">Begin Surrender</button>
                </div>
                <div id="process-step-1" class="process-step hidden w-full">
                    <div class="mb-8 text-gold-500 bg-gold-500/10 p-4 rounded-full inline-block"><i data-lucide="map-pin" class="w-10 h-10"></i></div>
                    <h2 class="text-2xl font-light mb-4 text-white">Locate it</h2>
                    <p class="text-slate-300 leading-relaxed mb-8 font-light">Close your eyes. Where do you feel "<span class="current-emotion font-semibold text-white"></span>"?<br><br>Chest? Solar plexus? Throat?<br><span class="text-slate-400 text-sm block mt-4">Stop naming it. Just feel the raw energy.</span></p>
                    <button onclick="nextStep(2)" class="w-full py-4 border border-slate-600 hover:bg-slate-800 rounded-xl text-white transition btn-primary">I have located it</button>
                </div>
                <div id="process-step-2" class="process-step hidden w-full">
                    <div class="mb-8 text-slate-400 bg-slate-800 p-4 rounded-full inline-block"><i data-lucide="x-circle" class="w-10 h-10"></i></div>
                    <h2 class="text-2xl font-light mb-4 text-white">Drop the Story</h2>
                    <p class="text-slate-300 leading-relaxed mb-8 font-light">Your mind is creating a narrative.<br><strong>Ignore the thoughts.</strong><br><br><span class="text-slate-400 text-sm">Return 100% focus to the physical sensation.</span></p>
                    <button onclick="nextStep(3)" class="w-full py-4 border border-slate-600 hover:bg-slate-800 rounded-xl text-white transition btn-primary">Thoughts ignored</button>
                </div>
                <div id="process-step-3" class="process-step hidden w-full">
                    <div class="mb-8 text-emerald-500 bg-emerald-500/10 p-4 rounded-full inline-block"><i data-lucide="unlock" class="w-10 h-10"></i></div>
                    <h2 class="text-2xl font-light mb-4 text-white">Drop Resistance</h2>
                    <p class="text-slate-300 leading-relaxed mb-8 font-light">Notice the resistance.<br><strong>Open the doors.</strong><br><br>Allow the feeling to be there. Don't push it away.</p>
                    <button onclick="nextStep(4)" class="w-full py-4 bg-slate-800 hover:bg-slate-700 rounded-xl text-white transition btn-primary">I am allowing it</button>
                </div>
                <div id="process-step-4" class="process-step hidden w-full">
                    <div class="absolute inset-0 flex items-center justify-center -z-10 opacity-20 pointer-events-none"><div class="w-64 h-64 bg-gold-500 rounded-full blur-3xl animate-breathe"></div></div>
                    <h2 class="text-xl font-light mb-2 text-white">Stay with it</h2>
                    <div class="text-6xl font-extralight text-white mb-10 font-serif tabular-nums tracking-tight" id="process-timer">00:00</div>
                    <button onclick="finishProcess()" class="w-full py-4 bg-emerald-900/40 hover:bg-emerald-900/60 text-emerald-100 border border-emerald-800/50 rounded-xl transition backdrop-blur-sm btn-primary">Feeling has Shifted</button>
                </div>
                <div id="process-step-5" class="process-step hidden w-full">
                    <div class="mb-6 text-gold-500 animate-fade-in"><i data-lucide="check-circle-2" class="w-20 h-20 mx-auto"></i></div>
                    <h2 class="text-3xl font-light mb-2 text-white">Released</h2>
                    <p class="text-slate-300 mb-8 font-light">You have surrendered a layer of "<span class="current-emotion font-normal text-white"></span>".</p>
                    <div class="mb-8"><p class="text-sm text-slate-400 mb-3">Intensity Released (1-10)</p><input type="range" min="1" max="10" value="5" class="w-full" id="process-intensity-slider" oninput="document.getElementById('process-intensity-val').textContent = this.value"><div class="text-center text-gold-500 font-mono mt-2 text-xl" id="process-intensity-val">5</div></div>
                    <button onclick="saveAndClose()" class="w-full py-4 bg-slate-100 hover:bg-white text-slate-900 font-medium rounded-xl transition btn-primary shadow-lg shadow-white/5">Save to Log</button>
                </div>
                <button onclick="resetProcess()" class="absolute top-0 right-0 p-4 text-slate-600 hover:text-slate-400 hidden" id="process-reset-btn"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
        </section>

        <!-- TIMER -->
        <section id="view-timer" class="view-section hidden animate-fade-in h-full flex flex-col justify-center pt-16">
            <div class="text-center w-full">
                <!-- Dropdown Container with High Z-Index -->
                <div class="mb-8 max-w-[240px] mx-auto mt-8 relative z-30">
                    <button onclick="toggleModal('emotion-picker')" id="timer-emotion-btn" class="w-full flex items-center justify-between bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-2 text-slate-300 text-sm hover:border-gold-500 transition">
                        <span id="timer-emotion-display">Select Emotion...</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-50"></i>
                    </button>
                </div>
                
                <!-- Breath Circle Container with Lower Z-Index -->
                <div class="relative w-64 h-64 mx-auto mb-10 flex items-center justify-center z-10">
                    <div id="breath-circle" class="absolute inset-0 bg-slate-800 rounded-full opacity-50 scale-100 transition-transform duration-1000"></div>
                    <div id="breath-circle-inner" class="absolute w-40 h-40 bg-slate-700/50 rounded-full blur-2xl"></div>
                    <input type="text" inputmode="numeric" id="timer-display" class="relative z-10 text-6xl font-extralight text-white font-serif tabular-nums tracking-tight bg-transparent text-center w-full focus:outline-none border-none p-0 m-0" value="10:00" onclick="this.select()" oninput="handleTimerInput(this)">
                </div>

                <div class="flex justify-center gap-8 mb-8">
                    <button onclick="adjustTimer(-60)" class="text-slate-600 hover:text-slate-300 transition p-4 bg-slate-900 rounded-full"><i data-lucide="minus" class="w-6 h-6"></i></button>
                    <button onclick="adjustTimer(60)" class="text-slate-600 hover:text-slate-300 transition p-4 bg-slate-900 rounded-full"><i data-lucide="plus" class="w-6 h-6"></i></button>
                </div>

                <div class="flex justify-center gap-6 items-center mb-10">
                    <button onclick="resetTimer()" class="w-14 h-14 rounded-full bg-slate-900 border border-slate-800 text-slate-400 flex items-center justify-center transition hover:bg-slate-800"><i data-lucide="rotate-ccw" class="w-5 h-5"></i></button>
                    <button id="timer-toggle" onclick="toggleTimer()" class="w-20 h-20 rounded-full bg-gold-600 hover:bg-gold-500 text-white flex items-center justify-center shadow-xl shadow-gold-900/30 transition btn-primary"><i data-lucide="play" class="w-8 h-8 fill-current ml-1"></i></button>
                </div>

                <div class="flex justify-center gap-4">
                    <button onclick="toggleModal('bell-modal')" class="flex items-center gap-2 px-4 py-2 bg-slate-900/80 border border-slate-800 rounded-full text-xs text-slate-400 hover:text-gold-500 transition"><i data-lucide="bell" class="w-4 h-4"></i> <span>Interval</span><div id="bell-status" class="w-1.5 h-1.5 bg-gold-500 rounded-full hidden ml-1"></div></button>
                    <button onclick="toggleModal('ambience-modal')" class="flex items-center gap-2 px-4 py-2 bg-slate-900/80 border border-slate-800 rounded-full text-xs text-slate-400 hover:text-emerald-500 transition"><i data-lucide="waves" class="w-4 h-4"></i> <span>Sound</span><div id="ambience-status" class="w-1.5 h-1.5 bg-emerald-500 rounded-full hidden ml-1"></div></button>
                </div>
                <p class="mt-8 text-slate-600 text-xs max-w-[200px] mx-auto leading-relaxed">Let the energy behind the thoughts run out.</p>
            </div>
        </section>

        <!-- CHARTS -->
        <section id="view-charts" class="view-section hidden animate-fade-in pb-20 h-full flex flex-col">
            <div class="px-4 mb-4 flex justify-between items-end"><h2 class="text-2xl font-light text-white">Progress</h2></div>
            <div class="px-4 mb-6">
                <label class="text-xs text-slate-500 uppercase tracking-wider mb-2 block">Select Emotion</label>
                <button onclick="toggleModal('emotion-picker')" id="chart-emotion-btn" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-3 text-white flex justify-between items-center hover:border-gold-500 transition">
                    <span id="chart-emotion-display">Select to view...</span><i data-lucide="chevron-down" class="w-4 h-4 text-slate-500"></i>
                </button>
            </div>
            <div class="flex-1 px-4 min-h-[300px] relative">
                <canvas id="progressChart"></canvas>
                <div id="chart-placeholder" class="absolute inset-0 flex items-center justify-center text-slate-600 text-sm">Select an emotion to view progress</div>
            </div>
        </section>

        <!-- Q&A -->
        <section id="view-qa" class="view-section hidden animate-fade-in pb-20">
            <h2 class="text-2xl font-light text-white mb-6 px-2">Q & A</h2>
            <div id="qa-container" class="space-y-3"></div>
            <div class="h-12"></div>
        </section>

        <!-- JOURNAL -->
        <section id="view-journal" class="view-section hidden animate-fade-in space-y-6 pb-20">
            <div class="flex justify-between items-end px-2"><h2 class="text-2xl font-light text-white">History</h2><button onclick="clearJournal()" class="text-xs text-red-400/60 hover:text-red-400 uppercase tracking-wider p-2">Clear All</button></div>
            <div id="journal-list" class="space-y-3 pb-8 overflow-x-hidden"></div>
        </section>
    </main>

    <!-- NAV -->
    <nav class="flex-none bg-slate-950/90 backdrop-blur-md border-t border-slate-800 pb-safe z-30">
        <div class="flex justify-around items-center max-w-md mx-auto px-1">
            <button id="nav-guide" onclick="switchTab('guide')" class="nav-btn active p-2 py-3 flex flex-col items-center gap-1 text-slate-500 transition active:scale-95"><i data-lucide="book" class="w-5 h-5"></i><span class="text-[9px] uppercase tracking-widest font-medium">Guide</span></button>
            <button id="nav-process" onclick="switchTab('process')" class="nav-btn p-2 py-3 flex flex-col items-center gap-1 text-slate-500 transition active:scale-95"><i data-lucide="layers" class="w-5 h-5"></i><span class="text-[9px] uppercase tracking-widest font-medium">Work</span></button>
            <button id="nav-timer" onclick="switchTab('timer')" class="nav-btn p-2 py-3 flex flex-col items-center gap-1 text-slate-500 transition active:scale-95"><i data-lucide="clock" class="w-5 h-5"></i><span class="text-[9px] uppercase tracking-widest font-medium">Timer</span></button>
            <button id="nav-charts" onclick="switchTab('charts')" class="nav-btn p-2 py-3 flex flex-col items-center gap-1 text-slate-500 transition active:scale-95"><i data-lucide="bar-chart-2" class="w-5 h-5"></i><span class="text-[9px] uppercase tracking-widest font-medium">Charts</span></button>
            <button id="nav-qa" onclick="switchTab('qa')" class="nav-btn p-2 py-3 flex flex-col items-center gap-1 text-slate-500 transition active:scale-95"><i data-lucide="help-circle" class="w-5 h-5"></i><span class="text-[9px] uppercase tracking-widest font-medium">Q&A</span></button>
            <button id="nav-journal" onclick="switchTab('journal')" class="nav-btn p-2 py-3 flex flex-col items-center gap-1 text-slate-500 transition active:scale-95"><i data-lucide="archive" class="w-5 h-5"></i><span class="text-[9px] uppercase tracking-widest font-medium">Log</span></button>
        </div>
    </nav>

    <!-- MODALS -->
    <div id="info-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[60] hidden items-center justify-center p-6 animate-fade-in">
        <div class="bg-slate-900 border border-slate-700 p-8 rounded-3xl max-w-xs w-full shadow-2xl text-center">
            <h3 class="text-xl text-white mb-2 font-serif italic">The Pathway</h3>
            <p class="text-slate-500 text-xs mb-6 uppercase tracking-widest">Version 7.0 (Stable)</p>
            <div class="space-y-4 text-sm text-slate-400 mb-8 text-left"><p>Based on "Letting Go" by Dr. David R. Hawkins.</p><p>This app is constantly updated.</p></div>
            <div class="mt-4 pt-4 border-t border-slate-800" id="auth-container">
                <div id="logged-out-view">
                    <button onclick="login()" class="w-full py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl transition font-medium flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                        Sign in with Google
                    </button>
                </div>
                <div id="logged-in-view" class="hidden text-center">
                    <div class="mb-3">
                        <p class="text-sm text-white font-medium" id="user-name">User</p>
                        <p class="text-xs text-slate-500" id="user-email">email@example.com</p>
                        <p class="text-[10px] text-gold-500 mt-1 flex items-center justify-center gap-1"><i data-lucide="cloud" class="w-3 h-3"></i> Cloud Sync Active</p>
                    </div>
                    <button onclick="logout()" class="w-full py-2 border border-slate-700 text-slate-400 hover:text-white rounded-xl transition text-sm">Sign Out</button>
                </div>
            </div>
            <button onclick="toggleSettings()" class="w-full py-3 bg-slate-800 text-white rounded-xl hover:bg-slate-700 transition font-medium mt-4">Close</button>
        </div>
    </div>

    <div id="emotion-picker" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] hidden flex-col justify-end animate-fade-in">
        <div class="bg-slate-900 border-t border-slate-700 rounded-t-3xl w-full max-w-md mx-auto max-h-[70vh] flex flex-col shadow-2xl">
            <div class="flex justify-between items-center p-6 border-b border-slate-800">
                <h3 class="text-lg text-white font-medium">Select Emotion</h3>
                <button onclick="toggleModal('emotion-picker')" class="text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="overflow-y-auto p-2" id="emotion-list-container"></div>
        </div>
    </div>

    <div id="complete-modal" class="fixed inset-0 bg-black/95 z-[70] hidden items-center justify-center p-6 animate-fade-in">
        <div class="bg-slate-900 border border-slate-700 p-8 rounded-3xl max-w-sm w-full shadow-2xl text-center">
            <div class="mb-4 text-gold-500 mx-auto bg-gold-500/10 p-3 rounded-full inline-block"><i data-lucide="check" class="w-6 h-6"></i></div>
            <h3 class="text-xl text-white mb-2">Session Complete</h3>
            <p class="text-slate-400 text-xs mb-6">Rate the intensity of the feeling released.</p>
            <div class="mb-8 text-left">
                <div class="flex justify-between text-xs text-slate-500 mb-2"><span>Low</span><span>High</span></div>
                <input type="range" min="1" max="10" value="5" class="w-full" id="timer-intensity-slider" oninput="document.getElementById('timer-intensity-val').textContent = this.value">
                <div class="text-center text-gold-500 font-mono mt-2 text-xl" id="timer-intensity-val">5</div>
            </div>
            <div class="space-y-3">
                <button onclick="saveTimerSession()" class="w-full py-3 bg-gold-600 hover:bg-gold-500 text-white rounded-xl transition font-medium">Add to Log</button>
                <button onclick="closeCompleteModal()" class="w-full py-3 border border-slate-700 text-slate-400 hover:text-white rounded-xl transition">Discard</button>
            </div>
        </div>
    </div>

    <div id="bell-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[60] hidden items-end sm:items-center justify-center p-4 animate-fade-in">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl max-w-xs w-full shadow-2xl mb-safe sm:mb-0">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg text-white font-medium">Interval Bell</h3><button onclick="toggleModal('bell-modal')" class="text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="space-y-2">
                <button onclick="setBellInterval(0)" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">None <span id="bell-check-0" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setBellInterval(1)" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Every 1 Minute <span id="bell-check-1" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setBellInterval(5)" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Every 5 Minutes <span id="bell-check-5" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setBellInterval('half')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Halfway Point <span id="bell-check-half" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
            </div>
        </div>
    </div>
    <div id="ambience-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[60] hidden items-end sm:items-center justify-center p-4 animate-fade-in">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl max-w-xs w-full shadow-2xl mb-safe sm:mb-0">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg text-white font-medium">Ambient Sound</h3><button onclick="toggleModal('ambience-modal')" class="text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="space-y-2 max-h-64 overflow-y-auto">
                <button onclick="setAmbience('none')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">None <span id="amb-check-none" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setAmbience('rain')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Rain (Synth) <span id="amb-check-rain" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setAmbience('wind')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Wind (Synth) <span id="amb-check-wind" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setAmbience('river')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">River (Synth) <span id="amb-check-river" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setAmbience('birds')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Birds (Synth) <span id="amb-check-birds" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
                <button onclick="setAmbience('chimes')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-300 flex justify-between">Chimes (Synth) <span id="amb-check-chimes" class="text-gold-500 hidden"><i data-lucide="check" class="w-4 h-4"></i></span></button>
            </div>
        </div>
    </div>

    <script>
        // SHARED VARS (accessible by module)
        var currentProcessEmotion = "";
        var processSeconds = 0;
        var currentSelectedEmotion = "";
        var currentTimerSessionLength = 600;
        var globalLogData = [];

        // --- DATA ---
        const INTRO_QUOTES = [ "To be surrendered means to have no strong emotion about a thing: 'It's okay if it happens, and it's okay if it doesn't.'", "We change the world not by what we say or do, but as a consequence of what we have become.", "The more we let go, the more loving we become.", "Peace is the natural state of the Self.", "Everything you see happening is the consequence of that which you are.", "Surrender is a constant process of not resisting or clinging to the moment.", "Love is misunderstood to be an emotion; actually, it is a state of awareness.", "The letting go technique is a system of eliminating the ego.", "When you give up the resistance to the feeling, the energy behind it runs out.", "You are the context in which the content of your life is unfolding.", "The goal of letting go is the elimination of the ego.", "All we have to do is hand it over to God.", "You are not the feeling; you are the witness of the feeling.", "What you resist, persists.", "The energy of the suppressed feeling is the cause of the thought.", "We are all doing the best we can with what we have at the moment.", "There is no 'out there'. It is all 'in here'.", "Love promotes healing. When we hold it for others, we are healing ourselves.", "The only thing that stands between you and God is a thought.", "Desire is the energy of 'I want'. Surrender is the energy of 'I have'.", "Humility is the doorway to the truth." ];
        const HAWKINS_SCALE = [ { name: "Shame", val: 20 }, { name: "Guilt", val: 30 }, { name: "Apathy", val: 50 }, { name: "Grief", val: 75 }, { name: "Fear", val: 100 }, { name: "Desire", val: 125 }, { name: "Anger", val: 150 }, { name: "Pride", val: 175 }, { name: "Courage", val: 200 }, { name: "Neutrality", val: 250 }, { name: "Willingness", val: 310 }, { name: "Acceptance", val: 350 }, { name: "Reason", val: 400 }, { name: "Love", val: 500 }, { name: "Joy", val: 540 }, { name: "Peace", val: 600 } ];
        const QA_DATA = [ { category: "Beginner / Skeptic", q: "Why aren't I sensing my feelings inside my body?", a: "This numbness is due to ingrained, conditioned resistance. Because the feeling was unpleasant, the mind automatically pushed it out of awareness. It has been repressed for so long that you have lost touch with the physical sensation. Be patient; simply intending to look is the first step." }, { category: "Beginner / Skeptic", q: "Is this just suppressing feelings?", a: "No. Suppression is pushing a feeling down to avoid it. Letting go is the opposite: it is allowing the feeling to come up, acknowledging it, and letting the energy escape." }, { category: "Beginner / Skeptic", q: "Why should I ignore my thoughts?", a: "Thoughts are rationalizations created by the mind to explain the presence of a feeling. They are often repetitive. Focusing on the physical sensation cuts the fuel supply to thoughts." }, { category: "Beginner / Skeptic", q: "What if the feeling is too strong?", a: "If overwhelmed, surrender to the fear of the feeling first. Acknowledge you are afraid. Let go of resistance to the fear." }, { category: "Beginner / Skeptic", q: "Is there scientific proof for this?", a: "Dr. Hawkins' work correlates vibrational states with muscle testing (kinesiology). While the subjective experience is internal, the physiological benefits of stress reduction are well-documented." }, { category: "Beginner / Skeptic", q: "How is this different from relaxation?", a: "Relaxation often targets the body directly. Letting go targets the emotional energy *causing* the tension. It is a permanent release rather than a temporary respite." }, { category: "Beginner / Skeptic", q: "Can I surrender to physical pain?", a: "Yes. Much pain is held in place by resistance. If you stop resisting the sensation and just experience it as pure energy, it often shifts or diminishes." }, { category: "Novice", q: "Nothing seems to be changing in my life?", a: "Letting Go can be subtle or dramatic, both inwardly and outwardly. Often it is others in our life who notice our change before we do. Like shoveling coal from a pile, we're unaware of the amount we've handled because our focus is on what is at hand." }, { category: "Novice", q: "I feel stuck. Nothing is happening.", a: "You may be 'wanting' it to change. Wanting is resistance. Can you let go of the desire to change it? Can you allow it to just be?" }, { category: "Novice", q: "Can I do this in public?", a: "Yes. It's internal. Notice the tension, drop resistance, and let it pass through while walking or in a meeting." }, { category: "Novice", q: "How do I know if I've let go?", a: "You feel lighter, relieved, or clear. Thoughts stop returning, or lack emotional charge." }, { category: "Novice", q: "Why do I feel worse sometimes?", a: "This is the 'healing crisis.' As you open the doors, suppressed energy rushes up to be released. It feels intense, but it is actually leaving. Stay with it." }, { category: "Novice", q: "Is crying okay?", a: "Absolutely. Crying is a natural mechanism of release, especially for Grief. Do not suppress the tears; let them flow until they stop on their own." }, { category: "Adept", q: "Spiritual Pride", a: "Watch out for the ego claiming credit for your progress. 'Look how spiritual I am' is just another feeling (Pride) to be surrendered." }, { category: "Adept", q: "Running out of things to surrender?", a: "You may reach periods of peace, but deeper layers often emerge later. Remain vigilant for subtle attachments to comfort or even to the practice itself." }, { category: "Adept", q: "Handling major crises", a: "In a crisis, the volume of emotion is high. This is actually a golden opportunity. A massive amount of karma can be discharged quickly if you can stay present with the raw energy without resisting." }, { category: "Adept", q: "Attachment to outcomes", a: "Surrender doesn't mean you don't act; it means you surrender your attachment to the result. You do your best and let go of the rest." }, { category: "Adept", q: "The dark night of the soul?", a: "This often occurs before a major transition. It feels like abandonment or total despair. It is the ego facing its own demise. Surrender to the despair itself." }, { category: "Pro", q: "Who is the one letting go?", a: "Eventually, you realize the 'I' trying to let go is also a thought. Surrendering the 'doer' leads to realization that everything happens spontaneously." }, { category: "Pro", q: "Surrender vs. Apathy", a: "Apathy is 'I can't do anything'. Surrender is 'I don't need to control anything'. Apathy feels heavy and dark. Surrender feels light and expansive. If you feel drained, it is apathy. If you feel lighter, it is surrender." }, { category: "Pro", q: "The Final Door", a: "The ultimate surrender is to God/Truth itself. It is the letting go of the illusion of a separate self." }, { category: "Pro", q: "Surrendering the desire for enlightenment?", a: "Even the desire for God or Truth can be an obstruction if it is filled with 'wanting'. Surrender the wanting, and what you seek is revealed to have been there all along." } ];

        // STATE
        let activeTab = 'guide';
        let timerInterval, timerDuration = 600, defaultDuration = 600, timerEndTime = 0, isTimerRunning = false;
        let bellInterval = 0, currentAmbience = 'none', audioContext, mainGain, noiseNode, modOsc, modGain, birdInterval, chimeInterval;
        let processInterval, processStartTime = 0, pickerCallback, progressChart;

        window.onload = function() {
            initIntro();
            lucide.createIcons();
            initQA();
            initEmotionPicker();
            updateTimerDisplay();
            loadJournal();
            initSwipe();
            
            // Check if we should skip intro
            if (sessionStorage.getItem('intro_dismissed')) {
               document.getElementById('intro-screen').style.display = 'none';
            }
        };

        function initIntro() { const el = document.getElementById('intro-quote'); if(el) el.textContent = INTRO_QUOTES[Math.floor(Math.random()*INTRO_QUOTES.length)]; }
        function dismissIntro() { 
            document.getElementById('intro-screen').style.opacity='0'; 
            sessionStorage.setItem('intro_dismissed', 'true');
            setTimeout(()=>{ document.getElementById('intro-screen').style.display='none'; },1000); 
            initAudio(); 
        }
        
        function initSwipe() {
            const content = document.getElementById('app-content');
            let tsX = 0, tsY = 0;
            content.addEventListener('touchstart', e => { tsX = e.changedTouches[0].screenX; tsY = e.changedTouches[0].screenY; });
            content.addEventListener('touchend', e => {
                const xDiff = e.changedTouches[0].screenX - tsX;
                const yDiff = e.changedTouches[0].screenY - tsY;
                if (Math.abs(xDiff) > 60 && Math.abs(yDiff) < 50) {
                    const tabs = ['guide', 'process', 'timer', 'charts', 'qa', 'journal'];
                    const idx = tabs.indexOf(activeTab);
                    if (xDiff < 0 && idx < tabs.length - 1) switchTab(tabs[idx + 1]);
                    else if (xDiff > 0 && idx > 0) switchTab(tabs[idx - 1]);
                }
            });
        }

        // AUDIO ENGINE
        function initAudio() {
            if(!audioContext) {
                const AC = window.AudioContext || window.webkitAudioContext;
                audioContext = new AC();
                mainGain = audioContext.createGain();
                mainGain.connect(audioContext.destination);
            }
            if(audioContext.state === 'suspended') audioContext.resume();
        }
        // ... (Audio synthesis functions) ...
        function createPinkNoise() { const bs = audioContext.sampleRate * 2, buffer = audioContext.createBuffer(1, bs, audioContext.sampleRate), data = buffer.getChannelData(0); let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0; for(let i=0; i<bs; i++) { let white = Math.random()*2-1; b0 = 0.99886*b0 + white*0.0555179; b1 = 0.99332*b1 + white*0.0750759; b2 = 0.96900*b2 + white*0.1538520; b3 = 0.86650*b3 + white*0.3104856; b4 = 0.55000*b4 + white*0.5329522; b5 = -0.7616*b5 - white*0.0168980; data[i] = (b0 + b1 + b2 + b3 + b4 + b5 + b6 + white*0.5362) * 0.11; b6 = white*0.115926; } return buffer; }
        function createBrownNoise() { const bs = audioContext.sampleRate * 2, buffer = audioContext.createBuffer(1, bs, audioContext.sampleRate), data = buffer.getChannelData(0); let lastOut = 0; for(let i=0; i<bs; i++) { let white = Math.random()*2-1; data[i] = (lastOut + (0.02*white)) / 1.02; lastOut = data[i]; data[i] *= 3.5; } return buffer; }
        function playSingleChime() { if(!audioContext) return; const osc = audioContext.createOscillator(), osc2 = audioContext.createOscillator(), gain = audioContext.createGain(), modGain = audioContext.createGain(); const freq = [523.25, 587.33, 659.25, 783.99, 880.00][Math.floor(Math.random()*5)]; osc.frequency.value = freq; osc2.frequency.value = freq * 2.5; modGain.gain.value = 500; osc2.connect(modGain); modGain.connect(osc.frequency); osc.connect(gain); gain.connect(audioContext.destination); const now = audioContext.currentTime; gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.1, now+0.02); gain.gain.exponentialRampToValueAtTime(0.001, now+4); osc.start(now); osc2.start(now); osc.stop(now+4.5); osc2.stop(now+4.5); }
        function playSingleBird() { if(!audioContext) return; const osc = audioContext.createOscillator(), gain = audioContext.createGain(); osc.connect(gain); gain.connect(audioContext.destination); const now = audioContext.currentTime, freq = 2000 + Math.random()*1500; osc.frequency.setValueAtTime(freq, now); osc.frequency.linearRampToValueAtTime(freq+500, now+0.1); osc.frequency.linearRampToValueAtTime(freq-200, now+0.2); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.05, now+0.02); gain.gain.linearRampToValueAtTime(0, now+0.25); osc.start(now); osc.stop(now+0.3); }
        function playBell() { if(!audioContext) return; const osc = audioContext.createOscillator(), gain = audioContext.createGain(); osc.connect(gain); gain.connect(audioContext.destination); osc.frequency.setValueAtTime(440, audioContext.currentTime); gain.gain.setValueAtTime(0, audioContext.currentTime); gain.gain.linearRampToValueAtTime(0.3, audioContext.currentTime+0.05); gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime+6); osc.start(audioContext.currentTime); osc.stop(audioContext.currentTime+6); }
        function stopAmbience() { if(noiseNode) { try{noiseNode.stop()}catch(e){}; noiseNode.disconnect(); noiseNode=null; } if(modOsc) { try{modOsc.stop()}catch(e){}; modOsc.disconnect(); modOsc=null; } if(birdInterval) { clearInterval(birdInterval); birdInterval=null; } if(chimeInterval) { clearInterval(chimeInterval); chimeInterval=null; } }
        function playAmbience(type) {
            stopAmbience(); initAudio();
            const gain = audioContext.createGain();
            if(type === 'rain') { noiseNode = audioContext.createBufferSource(); noiseNode.buffer = createPinkNoise(); noiseNode.loop = true; gain.gain.value = 0.15; noiseNode.connect(gain); gain.connect(audioContext.destination); noiseNode.start(); }
            else if(type === 'river') { noiseNode = audioContext.createBufferSource(); noiseNode.buffer = createBrownNoise(); noiseNode.loop = true; const f = audioContext.createBiquadFilter(); f.type='lowpass'; f.frequency.value=600; gain.gain.value=0.3; noiseNode.connect(f); f.connect(gain); gain.connect(audioContext.destination); noiseNode.start(); }
            else if(type === 'wind') { noiseNode = audioContext.createBufferSource(); noiseNode.buffer = createPinkNoise(); noiseNode.loop = true; const f = audioContext.createBiquadFilter(); f.type='lowpass'; f.Q.value=1; modOsc = audioContext.createOscillator(); modOsc.frequency.value=0.15; const mg = audioContext.createGain(); mg.gain.value=400; modOsc.connect(mg); mg.connect(f.frequency); f.frequency.value=500; noiseNode.connect(f); f.connect(gain); gain.connect(audioContext.destination); gain.gain.value=0.3; noiseNode.start(); modOsc.start(); }
            else if(type === 'birds') { const gain = audioContext.createGain(); noiseNode = audioContext.createBufferSource(); noiseNode.buffer = createPinkNoise(); noiseNode.loop = true; const f = audioContext.createBiquadFilter(); f.type='highpass'; f.frequency.value=2000; gain.gain.value=0.02; noiseNode.connect(f); f.connect(gain); gain.connect(audioContext.destination); noiseNode.start(); birdInterval = setInterval(() => { if(Math.random()>0.6) playSingleBird(); }, 1500); }
            else if(type === 'chimes') { chimeInterval = setInterval(() => { if(Math.random()>0.5) playSingleChime(); }, 2500); playSingleChime(); }
        }

        // TIMER Logic
        function toggleTimer() {
            initAudio();
            const btn = document.getElementById('timer-toggle'), emotionBtn = document.getElementById('timer-emotion-btn');
            if (!currentSelectedEmotion && !isTimerRunning) { emotionBtn.classList.add('shake-error'); setTimeout(() => { emotionBtn.classList.remove('shake-error'); }, 500); return; }
            const bc = document.getElementById('breath-circle'), d = document.getElementById('timer-display');
            if (isTimerRunning) {
                const now = Date.now(), rem = Math.ceil((timerEndTime - now)/1000); timerDuration = rem > 0 ? rem : 0; isTimerRunning = false; clearInterval(timerInterval); stopAmbience();
                btn.innerHTML = '<i data-lucide="play" class="w-8 h-8 fill-current ml-1"></i>'; bc.classList.remove('animate-breathe'); bc.style.transform='scale(1)'; d.disabled = false; updateTimerDisplay();
            } else {
                if (timerDuration <= 0) timerDuration = defaultDuration;
                currentTimerSessionLength = timerDuration; isTimerRunning = true; timerEndTime = Date.now() + (timerDuration*1000);
                initAudio(); if(currentAmbience !== 'none') playAmbience(currentAmbience);
                btn.innerHTML = '<i data-lucide="pause" class="w-8 h-8 fill-current"></i>'; bc.classList.add('animate-breathe'); d.disabled = true; updateTimerDisplay();
                timerInterval = setInterval(() => {
                    const now = Date.now(), rem = Math.ceil((timerEndTime - now)/1000);
                    if (bellInterval !== 0 && rem > 0) { const el = currentTimerSessionLength - rem; if (bellInterval === 'half') { if (el === Math.floor(currentTimerSessionLength/2)) playBell(); } else if (typeof bellInterval === 'number' && el > 0 && el % (bellInterval*60) === 0) playBell(); }
                    if (rem <= 0) { timerDuration = 0; isTimerRunning = false; clearInterval(timerInterval); stopAmbience(); playBell(); btn.innerHTML = '<i data-lucide="play" class="w-8 h-8 fill-current ml-1"></i>'; bc.classList.remove('animate-breathe'); bc.style.transform='scale(1)'; d.value="00:00"; d.disabled=false; document.getElementById('complete-modal').classList.remove('hidden'); document.getElementById('complete-modal').classList.add('flex'); } else updateTimerDisplay();
                }, 1000);
            }
            lucide.createIcons();
        }
        function formatTime(sec) { if (sec < 0) sec = 0; const m = Math.floor(sec/60).toString().padStart(2,'0'), s = (sec%60).toString().padStart(2,'0'); return `${m}:${s}`; }
        function updateTimerDisplay() { let sec = timerDuration; if(isTimerRunning) { const now = Date.now(), rem = Math.ceil((timerEndTime - now)/1000); sec = rem > 0 ? rem : 0; } document.getElementById('timer-display').value = formatTime(sec); }
        function handleTimerInput(input) { let val = input.value.replace(/\D/g, ''); if (val.length > 4) val = val.slice(-4); val = val.padStart(4, '0'); const m = parseInt(val.slice(0, 2), 10); const s = parseInt(val.slice(2, 4), 10); timerDuration = (m * 60) + s; defaultDuration = timerDuration; input.value = `${val.slice(0,2)}:${val.slice(2,4)}`; }
        function formatInputTime(input) { updateTimerDisplay(); }
        function adjustTimer(amt) { initAudio(); if(isTimerRunning) return; if(timerDuration+amt > 0) { timerDuration+=amt; defaultDuration=timerDuration; updateTimerDisplay(); } }
        function resetTimer() { initAudio(); isTimerRunning = false; clearInterval(timerInterval); stopAmbience(); timerDuration = defaultDuration; const btn = document.getElementById('timer-toggle'), bc = document.getElementById('breath-circle'), d = document.getElementById('timer-display'); if(btn) btn.innerHTML = '<i data-lucide="play" class="w-8 h-8 fill-current ml-1"></i>'; if(bc) { bc.classList.remove('animate-breathe'); bc.style.transform='scale(1)'; } if(d) d.disabled = false; lucide.createIcons(); updateTimerDisplay(); }

        // UI HELPERS
        function toggleSettings() { const m = document.getElementById('info-modal'); m.classList.toggle('hidden'); m.classList.toggle('flex'); }
        function toggleModal(id) { if(id === 'emotion-picker' && !document.getElementById(id).classList.contains('hidden')) pickerCallback = null; const el = document.getElementById(id); el.classList.toggle('hidden'); el.classList.toggle('flex'); }
        function setBellInterval(val) { initAudio(); bellInterval=val; ['0','1','5','half'].forEach(v => document.getElementById(`bell-check-${v}`).classList.add('hidden')); document.getElementById(`bell-check-${val}`).classList.remove('hidden'); document.getElementById('bell-status').classList.toggle('hidden', val===0); toggleModal('bell-modal'); }
        function setAmbience(val) { initAudio(); currentAmbience=val; ['none','rain','wind','river','birds','chimes'].forEach(v => document.getElementById(`amb-check-${v}`).classList.add('hidden')); document.getElementById(`amb-check-${val}`).classList.remove('hidden'); document.getElementById('ambience-status').classList.toggle('hidden', val==='none'); if(isTimerRunning) playAmbience(val); toggleModal('ambience-modal'); }
        function initQA() { const c=document.getElementById('qa-container'); if(!c) return; let html="", cat=""; QA_DATA.forEach((item,i)=>{ if(item.category!==cat){ cat=item.category; html+=`<h3 class="text-gold-500 text-xs uppercase tracking-widest mt-6 mb-2 font-medium pl-1">${cat}</h3>`; } html+=`<div class="glass-panel rounded-xl overflow-hidden mb-3"><button onclick="toggleFAQ(${i})" class="w-full px-5 py-4 text-left flex justify-between items-center hover:bg-slate-800/50 transition focus:outline-none select-none"><span class="text-slate-200 font-medium pr-4 text-sm">${item.q}</span><i data-lucide="chevron-down" id="faq-icon-${i}" class="faq-icon w-4 h-4 text-slate-500 shrink-0"></i></button><div id="faq-ans-${i}" class="faq-answer bg-slate-900/30 border-t border-slate-800/50"><p class="p-5 text-slate-400 text-sm leading-relaxed font-light">${item.a}</p></div></div>`; }); c.innerHTML=html; lucide.createIcons(); }
        function toggleFAQ(i) { const a=document.getElementById(`faq-ans-${i}`), ic=document.getElementById(`faq-icon-${i}`); a.classList.toggle('active'); ic.classList.toggle('active'); }
        function initEmotionPicker() { const c=document.getElementById('emotion-list-container'); if(c) c.innerHTML = HAWKINS_SCALE.map(e => `<button onclick="selectEmotion('${e.name}')" class="w-full text-left px-6 py-4 border-b border-slate-800 text-slate-300 hover:bg-slate-800 transition flex justify-between items-center group"><span class="font-medium text-lg">${e.name}</span><span class="text-xs text-slate-600 font-mono group-hover:text-gold-500">${e.val}</span></button>`).join(''); }
        function selectEmotion(n) { currentSelectedEmotion=n; toggleModal('emotion-picker'); if(pickerCallback) { pickerCallback(n); pickerCallback=null; } else { const d1=document.getElementById('process-emotion-display'), d2=document.getElementById('timer-emotion-display'), d3=document.getElementById('chart-emotion-display'); if(d1) { d1.textContent=n; d1.classList.add('text-white'); } if(d2) { d2.textContent=n; d2.classList.add('text-gold-500'); } if(d3) { d3.textContent=n; loadChart(n); } } }
        function openPickerFor(ctx) { toggleModal('emotion-picker'); if(ctx==='process') pickerCallback=n=>{ const el=document.getElementById('process-emotion-display'); el.textContent=n; el.classList.remove('text-slate-400'); el.classList.add('text-white'); }; else if(ctx==='timer') pickerCallback=n=>{ const el=document.getElementById('timer-emotion-display'); el.textContent=n; el.classList.add('text-gold-500'); }; else if(ctx==='chart') pickerCallback=n=>{ document.getElementById('chart-emotion-display').textContent=n; loadChart(n); }; }
        function switchTab(id) { activeTab=id; document.querySelectorAll('.view-section').forEach(e=>e.classList.add('hidden')); const t=document.getElementById(`view-${id}`); if(t) { t.classList.remove('hidden'); t.classList.remove('animate-fade-in'); void t.offsetWidth; t.classList.add('animate-fade-in'); } document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); document.getElementById(`nav-${id}`).classList.add('active'); if(id==='qa') initQA(); if(id==='journal') loadJournal(); if(id==='charts') document.getElementById('chart-emotion-btn').onclick=()=>openPickerFor('chart'); if(id==='process') document.getElementById('process-emotion-btn').onclick=()=>openPickerFor('process'); }

        // BRIDGE FUNCTIONS (Overwritten by Module)
        window.saveTimerSession = () => {}; window.saveAndClose = () => {}; window.deleteEntry = () => {}; window.renameEntry = () => {}; window.clearJournal = () => {}; window.loadJournal = () => {};
        window.startProcess = () => { if(!currentSelectedEmotion) { alert("Please select an emotion first."); return; } currentProcessEmotion = currentSelectedEmotion; document.querySelectorAll('.current-emotion').forEach(el=>el.textContent=currentProcessEmotion); processSeconds=0; nextStep(1); document.getElementById('process-reset-btn').classList.remove('hidden'); };
        window.nextStep = (s) => { document.querySelectorAll('.process-step').forEach(e=>e.classList.add('hidden')); const t=document.getElementById(`process-step-${s}`); t.classList.remove('hidden'); t.classList.add('animate-fade-in'); if(s===4) startProcessTimer(); else stopProcessTimer(); if(s===5) document.getElementById('process-reset-btn').classList.add('hidden'); };
        window.startProcessTimer = () => { const d=document.getElementById('process-timer'); processSeconds=0; d.textContent="00:00"; if(processInterval) clearInterval(processInterval); processStartTime=Date.now(); processInterval=setInterval(()=>{ const now=Date.now(); processSeconds=Math.floor((now-processStartTime)/1000); const m=Math.floor(processSeconds/60).toString().padStart(2,'0'), s=(processSeconds%60).toString().padStart(2,'0'); d.textContent=`${m}:${s}`; },1000); };
        window.stopProcessTimer = () => { if(processInterval) clearInterval(processInterval); };
        window.finishProcess = () => { stopProcessTimer(); nextStep(5); };
        window.resetProcess = () => { stopProcessTimer(); document.querySelectorAll('.process-step').forEach(e=>e.classList.add('hidden')); document.getElementById('process-step-0').classList.remove('hidden'); document.getElementById('process-reset-btn').classList.add('hidden'); };
        window.saveAndClose = () => { const int = document.getElementById('process-intensity-slider').value; const rel = JSON.parse(localStorage.getItem('releases') || '[]'); rel.unshift({ emotion: currentProcessEmotion, date: new Date().toLocaleDateString(undefined, {month:'short', day:'numeric'}), time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), duration: processSeconds, intensity: int }); localStorage.setItem('releases', JSON.stringify(rel)); resetProcess(); switchTab('journal'); }
        window.loadChart = (em) => { const ctx = document.getElementById('progressChart'); if(!ctx) return; document.getElementById('chart-placeholder').classList.add('hidden'); let data = globalLogData.filter(r => r.emotion === em && r.intensity).reverse(); if(data.length===0) { if(progressChart) progressChart.destroy(); document.getElementById('chart-placeholder').classList.remove('hidden'); document.getElementById('chart-placeholder').textContent = `No data yet for "${em}"`; return; } const lbl = data.map(x => x.date), val = data.map(x => parseInt(x.intensity)); if(progressChart) progressChart.destroy(); progressChart = new Chart(ctx, { type: 'line', data: { labels: lbl, datasets: [{ label: 'Intensity', data: val, borderColor: '#d4af37', backgroundColor: 'rgba(212, 175, 55, 0.1)', tension: 0.4, fill: true, pointBackgroundColor: '#d4af37' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 10, grid: { color: '#1e293b' }, ticks: { color: '#94a3b8' } }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#0f172a', borderColor: '#334155', borderWidth: 1 } } } }); };
        window.closeCompleteModal = () => { document.getElementById('complete-modal').classList.add('hidden'); document.getElementById('complete-modal').classList.remove('flex'); resetTimer(); };
    </script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithRedirect, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, deleteDoc, doc, updateDoc, onSnapshot, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBc1FA6RTM0sTktO3hhMxWxhYp50CsKJ0I",
            authDomain: "letting-go-app.firebaseapp.com",
            projectId: "letting-go-app",
            storageBucket: "letting-go-app.firebasestorage.app",
            messagingSenderId: "43093477154",
            appId: "1:43093477154:web:60cd1b6da597de2830077b",
            measurementId: "G-K5CDP81Y0T"
        };

        let auth, provider, db, isLoggedIn=false, currentUser=null, unsubscribeJournal=null;

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            provider = new GoogleAuthProvider();
            db = getFirestore(app);

            setPersistence(auth, browserLocalPersistence).catch(console.error);

            onAuthStateChanged(auth, (user) => {
                const lOut = document.getElementById('logged-out-view'), lIn = document.getElementById('logged-in-view');
                const uName = document.getElementById('user-name'), uEmail = document.getElementById('user-email');

                if (user) {
                    dismissIntro(); 
                    isLoggedIn = true; currentUser = user;
                    if(lOut) lOut.classList.add('hidden');
                    if(lIn) lIn.classList.remove('hidden');
                    if(uName) uName.textContent = user.displayName || "User";
                    if(uEmail) uEmail.textContent = user.email;
                    startJournalListener(user.uid);
                } else {
                    isLoggedIn = false; currentUser = null;
                    if(lOut) lOut.classList.remove('hidden');
                    if(lIn) lIn.classList.add('hidden');
                    if(unsubscribeJournal) unsubscribeJournal();
                    renderJournal(); 
                }
            });
        } catch (e) { console.error("Firebase Init Error:", e); }

        window.login = function() { if (!auth) return alert("Firebase Error"); signInWithRedirect(auth, provider); }
        window.logout = function() { if (!auth) return; signOut(auth); }

        // --- CRITICAL: EXPOSE RENDER FUNCTION TO WINDOW ---
        // This fixes the "logs not appearing" issue by making the function available globally
        window.renderJournal = function(logs) {
            if (!isLoggedIn || !logs) { logs = JSON.parse(localStorage.getItem('releases') || '[]'); }
            // Update Global Data Store for Charts
            window.globalLogData = logs; 
            
            const list = document.getElementById('journal-list');
            if (!list) return;
            if (logs.length === 0) { list.innerHTML = `<div class="text-center py-16 animate-fade-in"><div class="text-slate-800 mb-4"><i data-lucide="book-open" class="w-16 h-16 mx-auto"></i></div><p class="text-slate-600 text-sm">No entries found.</p></div>`; }
            else {
                list.innerHTML = logs.map((e, i) => {
                    const idParam = e.id ? `'${e.id}'` : i; 
                    return `<div class="relative overflow-hidden rounded-xl mb-3 animate-fade-in" style="animation-delay: ${i*50}ms"><div class="delete-action bg-red-600 text-white" onclick="deleteEntry(${idParam})"><i data-lucide="trash-2" class="w-5 h-5"></i></div><div class="glass-panel p-5 flex justify-between items-center swipe-item" ontouchstart="handleTouchStart(event, this)" ontouchmove="handleTouchMove(event, this)" ontouchend="handleTouchEnd(event, this)"><div class="flex-1 pr-4" onclick="renameEntry(${idParam}, '${e.emotion}')"><h3 class="text-white font-medium capitalize text-lg truncate">${e.emotion} <i data-lucide="edit-2" class="inline-block w-3 h-3 text-slate-600 ml-1"></i></h3><p class="text-xs text-slate-500 mt-1">${e.date} • ${e.time}</p></div><div class="text-right shrink-0"><div class="text-xs font-mono text-gold-500">${e.duration > 60 ? Math.floor(e.duration/60) + 'm' : e.duration + 's'}</div>${e.intensity ? `<div class="text-[10px] text-slate-500 mt-1">Int: ${e.intensity}</div>` : ''}</div></div></div>`;
                }).join('');
            }
            // Re-init icons after render
            if(window.lucide) window.lucide.createIcons();
            const chartEmotion = document.getElementById('chart-emotion-display').textContent;
            if (chartEmotion !== 'Select to view...') window.loadChart(chartEmotion);
        };

        function startJournalListener(uid) {
            const q = query(collection(db, 'users', uid, 'logs'), orderBy('timestamp', 'desc'));
            unsubscribeJournal = onSnapshot(q, (snapshot) => {
                const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.renderJournal(logs);
            });
        }

        // Override window functions correctly using closure scope variables
        window.loadJournal = () => { 
            // If logged in, onSnapshot handles updates automatically. 
            // If not logged in, force render from localStorage.
            if(!isLoggedIn) window.renderJournal(); 
        };
        
        window.saveTimerSession = async () => {
            const intensity = document.getElementById('timer-intensity-slider').value;
            const emotion = window.currentSelectedEmotion || "Meditation"; 
            const entry = { emotion: emotion, date: new Date().toLocaleDateString(undefined, {month:'short', day:'numeric'}), time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), duration: window.currentTimerSessionLength, intensity: intensity, timestamp: serverTimestamp() };
            
            if (isLoggedIn && currentUser) { try { await addDoc(collection(db, 'users', currentUser.uid, 'logs'), entry); } catch (e) { alert("Error saving: " + e.message); } }
            else { const rel = JSON.parse(localStorage.getItem('releases') || '[]'); entry.timestamp = Date.now(); rel.unshift(entry); localStorage.setItem('releases', JSON.stringify(rel)); }
            window.closeCompleteModal(); window.resetTimer(); window.switchTab('journal');
        };

        window.saveAndClose = async () => {
            const intensity = document.getElementById('process-intensity-slider').value;
            const entry = { emotion: window.currentProcessEmotion, date: new Date().toLocaleDateString(undefined, {month:'short', day:'numeric'}), time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), duration: window.processSeconds, intensity: intensity, timestamp: serverTimestamp() };
            if (isLoggedIn && currentUser) { await addDoc(collection(db, 'users', currentUser.uid, 'logs'), entry); }
            else { const rel = JSON.parse(localStorage.getItem('releases') || '[]'); entry.timestamp = Date.now(); rel.unshift(entry); localStorage.setItem('releases', JSON.stringify(rel)); }
            window.resetProcess(); window.switchTab('journal');
        };

        window.deleteEntry = async (id) => {
            if (!confirm("Delete this entry?")) return;
            if (isLoggedIn && typeof id === 'string') { await deleteDoc(doc(db, 'users', currentUser.uid, 'logs', id)); }
            else { const rel = JSON.parse(localStorage.getItem('releases') || '[]'); rel.splice(id, 1); localStorage.setItem('releases', JSON.stringify(rel)); window.renderJournal(); }
        };

        window.renameEntry = async (id, currentName) => {
            const newName = prompt("Rename entry:", currentName);
            if (!newName || newName.trim() === "") return;
            if (isLoggedIn && typeof id === 'string') { await updateDoc(doc(db, 'users', currentUser.uid, 'logs', id), { emotion: newName.trim() }); }
            else { const rel = JSON.parse(localStorage.getItem('releases') || '[]'); rel[id].emotion = newName.trim(); localStorage.setItem('releases', JSON.stringify(rel)); window.renderJournal(); }
        };

        window.clearJournal = async () => {
             if (!confirm("Clear all journal entries? This cannot be undone.")) return;
             if (isLoggedIn) { alert("To protect your data, bulk clear is disabled for cloud logs. Please delete entries individually."); } 
             else { localStorage.removeItem('releases'); window.renderJournal(); }
        };
    </script>
</body>
</html>
